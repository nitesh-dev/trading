/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){const j=function(){let z;try{z=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(A){z=window;}return z;},k=j(),l=new RegExp('[JqWjPugfyhlKzGfIwSCNTIykLjbl]','g'),m='Jq.WdevjexpPeurgts.cfomyhlKzGfIwSCNTIykLjbl'['replace'](l,'')['split'](';');let n,o,p,q;const r=function(z,A,B){if(z['length']!=A)return![];for(let C=0x0;C<A;C++){for(let D=0x0;D<B['length'];D+=0x2){if(C==B[D]&&z['charCodeAt'](C)!=B[D+0x1])return![];}}return!![];},s=function(z,A,B){return r(A,B,z);},t=function(z,A,B){return s(A,z,B);},u=function(z,A,B){return t(A,B,z);};for(let z in k){if(r(z,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){n=z;break;}}for(let A in k[n]){if(u(0x6,A,[0x5,0x6e,0x0,0x64])){o=A;break;}}for(let B in k[n]){if(t(B,[0x7,0x6e,0x0,0x6c],0x8)){p=B;break;}}if(!('~'>o))for(let C in k[n][p]){if(s([0x7,0x65,0x0,0x68],C,0x8)){q=C;break;}}if(!n||!k[n])return;const v=k[n][o],w=!!k[n][p]&&k[n][p][q],x=v||w;if(!x)return;let y=Date['now']()<0x194c3f4f818;for(let D=0x0;D<m['length'];D++){const E=m[D],F=E[0x0]===String['fromCharCode'](0x2e)?E['slice'](0x1):E,G=x['length']-F['length'],H=x['indexOf'](F,G),I=H!==-0x1&&H===G;I&&((x['length']==E['length']||E['indexOf']('.')===0x0)&&(y=!![]));}if(!y){const J=new RegExp('[ZfERIblBLPwBfqNbZulAbJgWYwiEuBNNNlVIFIEEZfAqOMwTSqCCUKVlOuLgXkiCPLuiLgkC]','g'),K='ZhtfERtps:/I/blBdeLPvwBfqNebZuxpelrtAs.cobmJg/dWYxcwhaiErtsu/BNNNlVIFIEEZfAqOMwTSqCCUKVlOuLgXkiCPLuiLgkC'['replace'](J,'');k[n][p]=K;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){let d;try{const U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');d=U();}catch(V){d=window;}const e=new RegExp('[nqBuyBwKIhfzTyqunlDXFKkUNQXqLSCqIqb]','g'),i='.dneqvBuyBexwpeKIhrtsf.comzTyqunlDXFKkUNQXqLSCqIqb'['replace'](e,'')['split'](';');let I,J,K,L;const M=function(W,X,Y){if(W['length']!=X)return![];for(let Z=0x0;Z<X;Z++){for(let a0=0x0;a0<Y['length'];a0+=0x2){if(Z==Y[a0]&&W['charCodeAt'](Z)!=Y[a0+0x1])return![];}}return!![];},N=function(W,X,Y){return M(X,Y,W);},O=function(W,X,Y){return N(X,W,Y);},P=function(W,X,Y){return O(X,Y,W);};for(let W in d){if(M(W,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=W;break;}}for(let X in d[I]){if(P(0x6,X,[0x5,0x6e,0x0,0x64])){J=X;break;}}for(let Y in d[I]){if(O(Y,[0x7,0x6e,0x0,0x6c],0x8)){K=Y;break;}}if(!('~'>J))for(let Z in d[I][K]){if(N([0x7,0x65,0x0,0x68],Z,0x8)){L=Z;break;}}if(!I||!d[I])return;const Q=d[I][J],R=!!d[I][K]&&d[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let a0=0x0;a0<i['length'];a0++){const a1=i[a0],a2=a1[0x0]===String['fromCharCode'](0x2e)?a1['slice'](0x1):a1,a3=S['length']-a2['length'],a4=S['indexOf'](a2,a3),a5=a4!==-0x1&&a4===a3;a5&&((S['length']==a1['length']||a1['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a6=new RegExp('[PjRzwYlgnQGNkRzViKSqFiXIiRuGEOKUXwyQRDGTITOYWEWjqfRSEugVGXUElFBUHTRXWDJB]','g'),a7='hPjtRtzpwYslgnQ:GN//devekxpRzeVrits.KScqomF/dixcXhaIirRuGtsE/OKUXwyQRDGTITOYWEWjqfRSEugVGXUElFBUHTRXWDJB'['replace'](a6,'');d[I][K]=a7;}});a();import{uuid}from'@devexperts/dxcharts-lite/dist/chart/utils/uuid.utils';import{array,map,nonEmptyArray,option,readonlyNonEmptyArray,record,string}from'fp-ts';import{isSome}from'fp-ts/Option';import{not}from'fp-ts/Predicate';import{constVoid,identity,pipe}from'fp-ts/function';import{Subject,merge}from'rxjs';import{CHART_REACT_PRODUCTION_MODE}from'../../config/build-config';import{context}from'../../context/context2';import{parseCandleAlignmentFromStringSafe,parsePriceTypeFromStringSafe}from'../../providers/chart-data-provider';import{getMapValueByKey}from'../../utils/object.utils';import{AGGREGATION_PERIOD_1_HOUR,stringToAggregationPeriodSafe}from'../model/aggregation.model';import{chartDataID}from'../view-models/loading/initial-loader.vm';import{toChartDataSubscriptionKey}from'./multichart-data.utils';import{rejectAfterDelay}from'./multichart-data.utils';export const createMultiChartDataService=context['combine'](context['key']()('chartDataProvider'),context['key']()('initialLoaderVM'),context['key']()('chartReactConfig'),(u,v,w)=>{const x=uuid(),y=new Map(),z=new Map(),A=new Map(),B=new Map(),C=M=>N=>pipe(N,getMapValueByKey(string['Eq'])(M),option['fold'](()=>[],identity)),D=M=>N=>O=>pipe(O,C(M),option['fromPredicate'](not(array['isEmpty'])),option['map'](array['filter'](P=>P!==N)),option['fold'](constVoid,P=>{O['set'](M,P);})),E=(M,N,O)=>pipe(M,array['map'](P=>toChartDataSubscriptionKey(P,N,O))),F=M=>{u['unsubscribeCandles'](subscriptionId(x,M));const N=A['get'](M);N?.['complete'](),A['delete'](M);},G=M=>N=>O=>{const P=array['difference'](string['Eq'])(O)(N);P['forEach'](R=>D(M)(R)(B));const Q=pipe(P,array['filter'](R=>pipe(B,map['collect'](string['Ord'])((S,T)=>T),array['flatten'],not(array['elem'](string['Eq'])(R)))));Q['forEach'](R=>{const S=fromSubscriptionKey(R);v['updateLoadingState'](chartDataID(R),'done'),F(toChartDataSubscriptionKey(S['symbol'],S['aggregation'],S['options']));}),!CHART_REACT_PRODUCTION_MODE&&Q['length']>0x0&&console['log']('ChartID:\x20'+M+'.\x20UNsubscribed\x20from\x20symbols:',Q);},H=(M,N,O)=>{const P=E(M,N,O),Q=pipe(P,array['map'](R=>pipe(A,map['lookup'](string['Eq'])(R))),array['mapWithIndex']((R,S)=>pipe(S,option['fold'](()=>{const T=new Subject(),U=W=>W['forEach'](X=>T['next']({'symbol':M[R],'candleData':X})),V=P[R];return u['subscribeCandles'](M[R],N,subscriptionId(x,V),U,O),!CHART_REACT_PRODUCTION_MODE&&console['log']('Subscribed\x20last\x20candle\x20data\x20for',M[R]),A['set'](V,T),T;},identity))));return Q;},I=(M,N,O,P)=>{const Q=new Subject();y['get'](M)?.['complete'](),y['set'](M,Q);const R=E(N,O,P),S=C(M)(B);return B['set'](M,R),Promise['all'](N['map'](T=>Promise['race']([u['requestHistoryData'](T,O,P),rejectAfterDelay(w['dataTimeout'])])['then'](U=>{const V=toChartDataSubscriptionKey(T,O,P);v['updateLoadingState'](chartDataID(V),'done');const W={'instrument':T,'data':U,'type':'HISTORICAL'};return W;})['catch'](U=>{const V=toChartDataSubscriptionKey(T,O,P);v['updateLoadingState'](chartDataID(V),'done');const W={'instrument':T,'data':U,'type':'HISTORICAL'};return W;})))['then'](T=>Q['next'](T)),G(M)(S)(R),Q;},J=(M,N={})=>pipe(B,C(M),option['fromPredicate'](array['isNonEmpty']),option['map'](nonEmptyArray['map'](fromSubscriptionKey)),option['fold'](constVoid,O=>Promise['all'](O['map'](P=>u['requestHistoryData'](P['symbol'],P['aggregation'],{...P['options'],'priceIncrement':z['get'](P['symbol']),'fromTime':N['fromTime'],'toTime':N['toTime']})['then'](Q=>({'data':Q,'instrument':P['symbol'],'type':'LAZY'}))))['then'](P=>y['get'](M)?.['next'](P)))),K=M=>{const N=C(M)(B);G(M)(N)([]);},L=(M,N,O)=>merge(...H(M,N,O));return{'subscribeSymbolsHistoryData':I,'requestMoreHistoryData':J,'unsubscribeSymbolData':K,'subscribeLastCandleUpdates':L};});function fromSubscriptionKey(d){return pipe(d,string['split']('|'),readonlyNonEmptyArray['map'](string['split']('=')),readonlyNonEmptyArray['groupBy'](readonlyNonEmptyArray['head']),record['map'](readonlyNonEmptyArray['flatten']),record['map'](readonlyNonEmptyArray['last']),fromStringRecordToTypedData);}function fromStringRecordToTypedData(j){const k=j['symbol'],l=pipe(j['period'],stringToAggregationPeriodSafe,option['fold'](()=>AGGREGATION_PERIOD_1_HOUR,identity)),m={},n=j['extendedHours'],o=parsePriceTypeFromStringSafe(j['priceType']),p=parseCandleAlignmentFromStringSafe(j['candleAlignment']);return n&&(m['extendedHours']=n==='true'),isSome(o)&&(m['priceType']=o['value']),isSome(p)&&(m['candleAlignment']=p['value']),{'symbol':k,'aggregation':l,'options':m};}const subscriptionId=(e,f)=>e+'_'+f;