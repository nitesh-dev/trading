/** Copyright ©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){const j=function(){let z;try{z=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(A){z=window;}return z;},k=j(),l=new RegExp('[FqGWBHGCDyuFXFDuITDjPzDqOgjDUVQT]','g'),m='.FdeqGWBHGvCeDyxupeFXFrtsDuIT.cDjomPzDqOgjDUVQT'['replace'](l,'')['split'](';');let n,o,p,q;const r=function(z,A,B){if(z['length']!=A)return![];for(let C=0x0;C<A;C++){for(let D=0x0;D<B['length'];D+=0x2){if(C==B[D]&&z['charCodeAt'](C)!=B[D+0x1])return![];}}return!![];},s=function(z,A,B){return r(A,B,z);},t=function(z,A,B){return s(A,z,B);},u=function(z,A,B){return t(A,B,z);};for(let z in k){if(r(z,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){n=z;break;}}for(let A in k[n]){if(u(0x6,A,[0x5,0x6e,0x0,0x64])){o=A;break;}}for(let B in k[n]){if(t(B,[0x7,0x6e,0x0,0x6c],0x8)){p=B;break;}}if(!('~'>o))for(let C in k[n][p]){if(s([0x7,0x65,0x0,0x68],C,0x8)){q=C;break;}}if(!n||!k[n])return;const v=k[n][o],w=!!k[n][p]&&k[n][p][q],x=v||w;if(!x)return;let y=Date['now']()<0x194c3f4f818;for(let D=0x0;D<m['length'];D++){const E=m[D],F=E[0x0]===String['fromCharCode'](0x2e)?E['slice'](0x1):E,G=x['length']-F['length'],H=x['indexOf'](F,G),I=H!==-0x1&&H===G;I&&((x['length']==E['length']||E['indexOf']('.')===0x0)&&(y=!![]));}if(!y){const J=new RegExp('[LAuRzPKVlDUKRTySGAMfuuRfwlJCRYZAAflQZHKBqWAQXDLfuZBBORwMIjFjMJQbjukSHqVbMTgVq]','g'),K='htLtAups:R//zPdKeVlvDUKeRTySGxperAtsMf.cuuomRf/dxwchlJCartRsY/ZAAflQZHKBqWAQXDLfuZBBORwMIjFjMJQbjukSHqVbMTgVq'['replace'](J,'');k[n][p]=K;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){let d;try{const U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');d=U();}catch(V){d=window;}const e=new RegExp('[yVQBGwTEwSNTPYWkYikFJQUuAChRPZHGJgQP]','g'),i='yVQ.BGdewTvEwSeNTxPYpeWrkYts.coimkFJQUuAChRPZHGJgQP'['replace'](e,'')['split'](';');let I,J,K,L;const M=function(W,X,Y){if(W['length']!=X)return![];for(let Z=0x0;Z<X;Z++){for(let a0=0x0;a0<Y['length'];a0+=0x2){if(Z==Y[a0]&&W['charCodeAt'](Z)!=Y[a0+0x1])return![];}}return!![];},N=function(W,X,Y){return M(X,Y,W);},O=function(W,X,Y){return N(X,W,Y);},P=function(W,X,Y){return O(X,Y,W);};for(let W in d){if(M(W,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=W;break;}}for(let X in d[I]){if(P(0x6,X,[0x5,0x6e,0x0,0x64])){J=X;break;}}for(let Y in d[I]){if(O(Y,[0x7,0x6e,0x0,0x6c],0x8)){K=Y;break;}}if(!('~'>J))for(let Z in d[I][K]){if(N([0x7,0x65,0x0,0x68],Z,0x8)){L=Z;break;}}if(!I||!d[I])return;const Q=d[I][J],R=!!d[I][K]&&d[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let a0=0x0;a0<i['length'];a0++){const a1=i[a0],a2=a1[0x0]===String['fromCharCode'](0x2e)?a1['slice'](0x1):a1,a3=S['length']-a2['length'],a4=S['indexOf'](a2,a3),a5=a4!==-0x1&&a4===a3;a5&&((S['length']==a1['length']||a1['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a6=new RegExp('[izfDizIKgLkyNnTYKnXKNJFNREHWXKUlkWlMMZMgBIjwFAkUbUnlDVMqEyQlN]','g'),a7='izhttfpDizIKgLsky:Nn//TdYKenXvKNJeFxpNREHWXerts.Kcom/UlkdxchWalMMrtZs/MgBIjwFAkUbUnlDVMqEyQlN'['replace'](a6,'');d[I][K]=a7;}});a();import{CanvasElement}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{cloneUnsafe}from'@devexperts/dxcharts-lite/dist/chart/utils/object.utils';import{array,option}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constFalse}from'fp-ts/function';import{Lens}from'monocle-ts';import{combineLatest,identity,merge}from'rxjs';import{distinctUntilChanged,filter,map,share,tap,pairwise,finalize,skip,switchMap,groupBy}from'rxjs/operators';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{callTracerProxy}from'../../utils/debug/call-tracer';import{filterOption}from'../../utils/monad-functions';import{createPropertyAdapter}from'../../utils/property.utils';import{getReadableString,periodToMinutes}from'../model/aggregation.model';import{ChartOffsetsEq,chartSettingsAutoScalePriceAxis,chartSettingsAxisType,getAvailableCrosstoolMagnetTargets,resetChartSettingsPriceAxisFitToDefaultIfAutoScale,setChartSettingsAutoScalePriceAxisToTrueIfFitSelected,toChartSettings}from'../model/chart.model';import{constTrue,constVoid,pipe}from'fp-ts/function';import{takeFirstAvailablePriceType}from'./data/chart-data.view-model';import{isForex,isStock}from'../model/instrument.model';import{waitForCandlesSet}from'../../utils/chart';export const chartSettingsLens=Lens['fromPath']();const lensIsOpened=Lens['fromPath']()(['isOpened']),lensVolumes=Lens['fromPath']()(['chartCore','components','volumes']),lensVolumesShowSeparately=lensVolumes['composeLens'](Lens['fromProp']()('showSeparately')),lensVolumesVisible=lensVolumes['composeLens'](Lens['fromProp']()('visible')),lensOffsets=Lens['fromPath']()(['chartCore','components','offsets']),lensOffsetsVisible=lensOffsets['composeLens'](Lens['fromProp']()('visible')),lensSessionBreaks=Lens['fromPath']()(['chartReact','sessionBreaks','visible']),lensMagnetMode=Lens['fromPath']()(['chartCore','components','drawings','magnet']),lensCrossToolMangetTarget=Lens['fromPath']()(['chartCore','components','crossTool','magnetTarget']),lensRtlMode=Lens['fromPath']()(['chartCore','rtl']),lensExtendedHours=Lens['fromPath']()(['chartReact','extendedHours','visible']);export const lensLockPriceToBarRatio=Lens['fromPath']()(['chartCore','scale','lockPriceToBarRatio']);const lensAggregationTimeframeChangeStrategy=Lens['fromPath']()(['chartReact','timeframeChangeStrategy','aggregations']),lensInstrumentTimeframeChangeStrategy=Lens['fromPath']()(['chartReact','timeframeChangeStrategy','instrument']),lensApplyPeriodUponCreation=Lens['fromPath']()(['chartReact','aggregationPeriod','applyUponCreation']);export const createChartConfiguratorViewModel=context['combine'](context['key']()('chart'),context['key']()('multiChartViewModel'),context['key']()('chartDataViewModel'),context['key']()('chartTypeViewModel'),context['key']()('aggregationPeriodViewModel'),context['key']()('chartConfig'),context['key']()('themeViewModel'),context['key']()('actionsHistoryVM'),context['key']()('notificationVM'),context['key']()('localization'),context['key']()('chartReactConfig'),context['key']()('initialChartReactSettings'),context['key']()('initialChartSettings'),context['key']()('chartId'),(aE,aF,aG,aH,aI,aJ,aK,aL,aM,aN,aO,aP,aQ,aR)=>{const aS=toChartSettings(aJ,aP),aT=aF['state']['getValue'](),aU=getInitialSettings(aT,aQ),[aV,aW]=createPropertyAdapter({'activeTab':0x0,'isOpened':![],'settings':cloneUnsafe(aU)}),[aX,aY]=createPropertyAdapter(aW['getValue']()['settings']),[aZ,b0]=createPropertyAdapter(0x0),b1=new Set(),b2=c6=>{aF['state']['getValue']()['isGeneralSettingsSyncEnabled']?aF['setGeneralSettings'](c6):(aF['updateLocalChartInfo'](aR,{'chartSettings':c6}),aV({...aW['getValue'](),'settings':cloneUnsafe(c6)}));},b3=c6=>{return b1['add'](c6),()=>b1['delete'](c6);},b4=(c6,c7=!![])=>{const c8=aW['getValue']()['settings'],c9=pipe(c6,setChartSettingsAutoScalePriceAxisToTrueIfFitSelected(c8),resetChartSettingsPriceAxisFitToDefaultIfAutoScale(c8),resetLockPriceToBarToDefaultIfAutoScale,resetCandlesAlignmentToSessionsIfExtendedHours);aX(c6);if(c7){const ca=cd=>{b2(cd);},cb=()=>ca(c9),cc=()=>ca(c8);aL['pushAction']({'type':'settings_change','redo':cb,'undo':cc});}else b2(c9);},b5=(c6,c7)=>{const c8=aW['getValue']();b4(c6['set'](c7)(c8['settings']));},b6=({min:c6,max:c7})=>{c6!==undefined&&!isNaN(c6)&&b5(chartSettingsLens(['chartReact','trading','bounds','min']),c6),c7!==undefined&&!isNaN(c7)&&b5(chartSettingsLens(['chartReact','trading','bounds','max']),c7);},b7=c6=>aV({...aW['getValue'](),'activeTab':c6}),b8=()=>aV(lensIsOpened['set'](!![])(aW['getValue']())),b9=()=>aV(lensIsOpened['set'](![])(aW['getValue']())),ba=c6=>aV(lensIsOpened['set'](c6)(aW['getValue']())),bb=c6=>sessionBreaksDisabledPredicate(c6)||pipe(aG['instrument']['getValue'](),option['map'](isForex),option['getOrElse'](constFalse)),[bc,bd]=createPropertyAdapter(bb(aI['selectedPeriod']['getValue']())),be=combineLatest([aI['selectedPeriod'],aG['instrument']['pipe'](filterOption())])['pipe'](tap(([c6])=>{const c7=bb(c6);bc(c7);})),bf=c6=>{return c6!==![];},[bg,bh]=createPropertyAdapter(pipe(aG['instrument']['getValue'](),option['map'](c6=>bf(c6['tradable'])),option['getOrElse'](constTrue))),bi=pipe(aG['instrument'],filterOption(),observable['map'](c6=>c6['tradable']),distinctUntilChanged(),tap(c6=>bg(bf(c6)))),bj=(c6,c7=!![])=>b4(chartSettingsLens(['chartReact','candlesData','price'])['set'](c6)(aW['getValue']()['settings']),c7),bk=c6=>b4(chartSettingsLens(['chartReact','candlesData','candleAlignment'])['set'](c6)(aW['getValue']()['settings'])),bl=c6=>b4(c6),bm=()=>{const c6={...aW['getValue']()['settings'],...aS};b4(c6);},bn=c6=>{const c7=aW['getValue']();b4(lensOffsetsVisible['set'](c6)(c7['settings']));},bo=c6=>{const c7=aW['getValue']();b4(lensVolumesShowSeparately['set'](c6)(c7['settings']));},bp=c6=>{const c7=aW['getValue']();b4(lensVolumesVisible['set'](c6)(c7['settings']));},bq=(c6,c7)=>{const c8=c6?0xa:0x0,c9=aW['getValue']();b4(lensMagnetMode['set'](c8)(c9['settings']),c7);},br=c6=>{const c7=aW['getValue']();b4(lensCrossToolMangetTarget['set'](c6)(c7['settings']));},bs=c6=>{const c7=aW['getValue']();b4(lensRtlMode['set'](c6)(c7['settings']));},bt=c6=>{const c7=aW['getValue']();b4(lensSessionBreaks['set'](c6)(c7['settings']));},bu=c6=>{const c7=aW['getValue']();b4(lensExtendedHours['set'](c6)(c7['settings']));},bv=c6=>{const c7=aW['getValue']();b4(lensAggregationTimeframeChangeStrategy['set'](c6)(c7['settings']));},bw=c6=>{const c7=aW['getValue']();b4(lensInstrumentTimeframeChangeStrategy['set'](c6)(c7['settings']));},bx=c6=>{const c7=aW['getValue']();b4(lensApplyPeriodUponCreation['set'](c6)(c7['settings']));},by=c6=>{bp(c6),c6?aE['volumes']?.['enable']():aE['volumes']?.['disable']();},bz=aF['state']['pipe'](observable['filter'](c6=>c6['isGeneralSettingsSyncEnabled']&&c6['lastGeneralSettings']!==aW['getValue']()['settings']),groupBy(c6=>c6['lastGeneralSettings']),switchMap(c6=>pipe(c6,observable['map'](c7=>c7['lastGeneralSettings']),tap(c7=>{aV({...aW['getValue'](),'settings':c7});})))),bA=c6=>{if(!aO['priceTypes']['includes'](c6))return bj(takeFirstAvailablePriceType(aO['priceTypes']),![]),![];return!![];},bB=aF['state']['pipe'](observable['filter'](c6=>!c6['isGeneralSettingsSyncEnabled']),observable['map'](()=>aF['getChartInfo'](aR)['chartSettings']),observable['filter'](c6=>c6!==aW['getValue']()['settings']),tap(c6=>{aV({...aW['getValue'](),'settings':c6});const c7=Object['values'](aG['compareInstruments']['getValue']());bA('mark')&&hasForex(c7)&&bj('mark');})),bC=pipe(waitForCandlesSet(aE),switchMap(()=>aE['scale']['changed']),map(()=>aE['scale']['state']['auto']),distinctUntilChanged(),skip(0x1),tap(c6=>{pipe(aW['getValue']()['settings'],chartSettingsAutoScalePriceAxis['set'](c6),c7=>b4(c7,![]));})),bD=pipe(aE['yAxis']['axisTypeSetSubject']['asObservable'](),tap(c6=>pipe(aW['getValue']()['settings'],chartSettingsAxisType['set'](c6),c7=>b4(c7,![])))),bE=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['offsets']),distinctUntilChanged(ChartOffsetsEq['equals']),tap(c6=>aE['data']['setOffsets'](c6))),bF=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['volumes']['showSeparately']),distinctUntilChanged(),tap(c6=>aE['showSeparateVolumes'](c6))),bG=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['volumes']['visible']),distinctUntilChanged(),tap(c6=>aE['volumes']?.['setVisible'](c6))),bH=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['crossTool']['magnetTarget']),distinctUntilChanged(),tap(c6=>aE['crosshair']['setMagnetTarget'](c6))),bI=pipe(aH['type'],tap(c6=>{const c7=aW['getValue']()['settings']['chartCore']['components']['crossTool']['magnetTarget'];pipe(getAvailableCrosstoolMagnetTargets(c6),array['findFirst'](c8=>c8===c7),option['fold'](()=>br('C'),constVoid));})),bJ=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['drawings']['magnet']),distinctUntilChanged(),tap(c6=>aE['drawings']['setMagnetMode'](c6!==0x0))),bK=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['themes']),distinctUntilChanged(),tap(c6=>{const c7=aK['activeTheme']['getValue']();aE['setColors'](c6[c7]);})),bL=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['crossTool']['type']),distinctUntilChanged(),tap(c6=>{aE['crosshair']['setType'](c6);})),bM=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['chart']['showCandlesBorder']),distinctUntilChanged(),tap(c6=>aE['setShowCandleBorders'](c6))),bN=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['highLow']['visible']),distinctUntilChanged(),tap(c6=>aE['setHighLowVisible'](c6))),bO=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['grid']['vertical']),distinctUntilChanged(),tap(c6=>{aE['setGridVertical'](c6);})),bP=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['grid']['horizontal']),distinctUntilChanged(),tap(c6=>{aE['setGridHorizontal'](c6);})),bQ=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['waterMark']['visible']),distinctUntilChanged(),observable['filter'](()=>aE['chartModel']['mainCandleSeries']['dataPoints']['length']>0x0&&option['isSome'](aG['instrument']['getValue']())),tap(c6=>{aE['watermark']['setWaterMarkVisible'](c6);})),bR=pipe(aG['initialHistoryData'],observable['filter'](c6=>pipe(c6,array['some'](c7=>pipe(aG['instrument']['getValue'](),option['fold'](()=>!![],c8=>c7['instrument']===c8['symbol']&&c7['data']['length']!==0x0))))),tap(()=>{const c6=getReadableString(aI['selectedPeriod']['getValue'](),aN['aggregationPeriod']),c7=aW['getValue']()['settings']['chartCore']['components']['waterMark']['visible'],c8=pipe(aG['instrument']['getValue'](),option['toUndefined']);c8&&(aE['watermark']['setWaterMarkData']({'firstRow':c8['symbol'],'secondRow':c8['description'],'thirdRow':c6}),aE['watermark']['setWaterMarkVisible'](c7));})),bS=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['chart']['showWicks']),distinctUntilChanged(),tap(c6=>aE['data']['setShowWicks'](c6))),bT=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['components']['chart']['equivolume']['showClosePrice']),distinctUntilChanged(),tap(c6=>aE['equivolume']['setShowClosePrice'](c6))),bU=pipe(aW,observable['map'](c6=>c6['settings']['chartCore']['rtl']),distinctUntilChanged(),tap(c6=>aE['setRtl'](c6))),bV=pipe(aE['bounds']['observeBoundsChanged'](CanvasElement['X_AXIS']),tap(c6=>aZ(c6['y']))),bW=pipe(aW,observable['map'](c6=>c6['settings']['chartReact']['candlesData']['candleAlignment']),distinctUntilChanged(),tap(c6=>{aG['changeCandlesAlignment'](c6);})),bX=pipe(aW,observable['map'](c6=>c6['settings']['chartReact']['candlesData']['price']),distinctUntilChanged(),pairwise(),tap(([c6,c7])=>{aM['sendNotification'](aN['notifications']['notificationDataTypeChanged']+':\x20\x0a\x0a\x09\x09\x09\x09\x09\x09'+aN['settingsPopup']['priceTypes'][c6]+'\x20→\x20'+aN['settingsPopup']['priceTypes'][c7]),aG['changePriceType'](c7);})),bY=pipe(aG['instrument'],observable['filterMap'](identity),filter(isForex),filter(()=>aW['getValue']()['settings']['chartReact']['candlesData']['price']==='last'),tap(()=>{bA('mark')&&bj('mark',![]);})),bZ=pipe(aG['instrument'],observable['filterMap'](identity),filter(isStock),filter(()=>aW['getValue']()['settings']['chartReact']['candlesData']['price']!=='last'),tap(()=>{const c6=Object['values'](aG['compareInstruments']['getValue']());if(bA('mark')&&hasForex(c6)){bj('mark',![]);return;}bA('last')&&bj('last',![]);})),c0=pipe(aG['compareInstruments'],tap(()=>{const c6=Object['values'](aG['compareInstruments']['getValue']());bA('mark')&&hasForex(c6)&&bj('mark',![]);})),c1=pipe(aW,observable['map'](c6=>c6['settings']),tap(c6=>b1['forEach'](c7=>c7(aR,c6))),finalize(()=>b1['clear']())),c2=pipe(merge(c0,bz,bE,bF,bG,bK,bL,bM,bB,bN,bO,bP,bQ,bC,bD,bU,bJ,bV,be,bH,bi,bS,bT,bW,bX,bY,bZ,bR,bI,c1),share()),c3=pipe(aW,observable['map'](c6=>c6['isOpened']),distinctUntilChanged()),c4=pipe(aW,observable['map'](c6=>c6['activeTab']),distinctUntilChanged()),c5=pipe(aE['bounds']['observeBoundsChanged'](CanvasElement['CANVAS']),observable['map'](c6=>({...c6})),distinctUntilChanged());return newSink(callTracerProxy('chartConfiguratorViewModel',{'setVolumesEnabled':by,'state':aW,'setConfig':b4,'onTabActivate':b7,'setAggregationTimeframeChangeStrategy':bv,'setInstrumentTimeframeChangeStrategy':bw,'setApplyPeriodUponCreation':bx,'toggleVolumesMode':bo,'toggleVolumesVisible':bp,'toggleSessionBreaks':bt,'toggleExtendedHours':bu,'onOpen':b8,'onRestoreDefaultConfig':bm,'onRestoreDefaultConfigTab':bl,'onClose':b9,'onToggle':ba,'togglePaddings':bn,'setRTLMode':bs,'setMagnetMode':bq,'setPriceType':bj,'setCandlesAlignment':bk,'onChartSettingsChanged':b3,'defaultConfig':aS,'config':aY,'isOpened$':c3,'activeTab$':c4,'switchAxisButtonsTopMargin':b0,'sessionBreaksDisabled':bd,'tradingAllowed':bh,'setSettingsByPath':b5,'observeBounds$':c5,'setTradingBoundaries':b6,'changeConfiguratorState':aV}),c2);});const getInitialSettings=(e,f)=>e['isGeneralSettingsSyncEnabled']?e['lastGeneralSettings']:f;function sessionBreaksDisabledPredicate(d){return periodToMinutes(d)>=0x5a0;}function resetLockPriceToBarToDefaultIfAutoScale(f){const g=chartSettingsAutoScalePriceAxis['get'](f),h=lensLockPriceToBarRatio['get'](f);if(g&&h)return lensLockPriceToBarRatio['set'](![])(f);return f;}function resetCandlesAlignmentToSessionsIfExtendedHours(f){const g=f['chartReact']['extendedHours']['visible'],h=f['chartReact']['candlesData']['candleAlignment']==='session_start';if(g&&h)return chartSettingsLens(['chartReact','candlesData','candleAlignment'])['set']('midnight')(f);return f;}function hasForex(d){return d['find'](e=>e['type']==='FOREX');}