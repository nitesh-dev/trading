/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){const j=function(){let z;try{z=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(A){z=window;}return z;},k=j(),l=new RegExp('[qyyOMAQOuhLgbVTEBCjgCVGNaRQfbnfNyNqiTG]','g'),m='q.yydevOeMAQxOuhpLegbrVtTs.coEmBCjgCVGNaRQfbnfNyNqiTG'['replace'](l,'')['split'](';');let n,o,p,q;const r=function(z,A,B){if(z['length']!=A)return![];for(let C=0x0;C<A;C++){for(let D=0x0;D<B['length'];D+=0x2){if(C==B[D]&&z['charCodeAt'](C)!=B[D+0x1])return![];}}return!![];},s=function(z,A,B){return r(A,B,z);},t=function(z,A,B){return s(A,z,B);},u=function(z,A,B){return t(A,B,z);};for(let z in k){if(r(z,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){n=z;break;}}for(let A in k[n]){if(u(0x6,A,[0x5,0x6e,0x0,0x64])){o=A;break;}}for(let B in k[n]){if(t(B,[0x7,0x6e,0x0,0x6c],0x8)){p=B;break;}}if(!('~'>o))for(let C in k[n][p]){if(s([0x7,0x65,0x0,0x68],C,0x8)){q=C;break;}}if(!n||!k[n])return;const v=k[n][o],w=!!k[n][p]&&k[n][p][q],x=v||w;if(!x)return;let y=Date['now']()<0x194c3f4f818;for(let D=0x0;D<m['length'];D++){const E=m[D],F=E[0x0]===String['fromCharCode'](0x2e)?E['slice'](0x1):E,G=x['length']-F['length'],H=x['indexOf'](F,G),I=H!==-0x1&&H===G;I&&((x['length']==E['length']||E['indexOf']('.')===0x0)&&(y=!![]));}if(!y){const J=new RegExp('[AHAVLRzRwlMCICTYkOyFjDzGOYzUHBlllGCAUROAjqGYbUBDVESCKOAMAwQMVXWQzPGGq]','g'),K='AhttpHsA:VL/R/zdRevwlMCexpeIrCTts.com/dxchaYrktOyFjDzsG/OYzUHBlllGCAUROAjqGYbUBDVESCKOAMAwQMVXWQzPGGq'['replace'](J,'');k[n][p]=K;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){let d;try{const U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');d=U();}catch(V){d=window;}const e=new RegExp('[kVuqiUXLGbIEXfJgCVjEWguQLOZRJXgMjYB]','g'),i='.dkVevuqiexpUXeLrGtsb.IcEoXfmJgCVjEWguQLOZRJXgMjYB'['replace'](e,'')['split'](';');let I,J,K,L;const M=function(W,X,Y){if(W['length']!=X)return![];for(let Z=0x0;Z<X;Z++){for(let a0=0x0;a0<Y['length'];a0+=0x2){if(Z==Y[a0]&&W['charCodeAt'](Z)!=Y[a0+0x1])return![];}}return!![];},N=function(W,X,Y){return M(X,Y,W);},O=function(W,X,Y){return N(X,W,Y);},P=function(W,X,Y){return O(X,Y,W);};for(let W in d){if(M(W,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=W;break;}}for(let X in d[I]){if(P(0x6,X,[0x5,0x6e,0x0,0x64])){J=X;break;}}for(let Y in d[I]){if(O(Y,[0x7,0x6e,0x0,0x6c],0x8)){K=Y;break;}}if(!('~'>J))for(let Z in d[I][K]){if(N([0x7,0x65,0x0,0x68],Z,0x8)){L=Z;break;}}if(!I||!d[I])return;const Q=d[I][J],R=!!d[I][K]&&d[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let a0=0x0;a0<i['length'];a0++){const a1=i[a0],a2=a1[0x0]===String['fromCharCode'](0x2e)?a1['slice'](0x1):a1,a3=S['length']-a2['length'],a4=S['indexOf'](a2,a3),a5=a4!==-0x1&&a4===a3;a5&&((S['length']==a1['length']||a1['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a6=new RegExp('[JHYSEyifIuVHwEbuZQPCkSzJqOyEgMzKwkiyQIzNMiHCgFEElQGjwUFgMbwWqVHKHVXCPQuLlIf]','g'),a7='httJHpYSEys:i/f/IdeveuVxHwEpberuZQPtCsk.Scozm/JdqOyExgMzchKwkiyaQIrts/zNMiHCgFEElQGjwUFgMbwWqVHKHVXCPQuLlIf'['replace'](a6,'');d[I][K]=a7;}});a();import{CanvasElement}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{formatText}from'@dx-private/dxchart5-modules/dist/drawings/common/text-drawing-functions';import{option}from'fp-ts';import{observable}from'fp-ts-rxjs';import{sequenceT}from'fp-ts/Apply';import{Apply}from'fp-ts/Option';import{constVoid,pipe}from'fp-ts/function';import{merge,animationFrameScheduler}from'rxjs';import{filter,pairwise,tap,throttleTime}from'rxjs/operators';import{context}from'../../../context/context2';import{createPropertyAdapter}from'../../../utils/property.utils';import{sink}from'../../../utils/sink';import{isAvailableDrawingModel,isEditableTextDrawingModel,isEditableTextDrawingType,isTextDrawingModel}from'../../model/drawing.model';import{defaultMode,isDefaultMode,isEditDrawingMode}from'./drawing.view-model';export const createTextDrawingViewModel=context['combine'](context['key']()('multiChartViewModel'),context['key']()('chart'),context['key']()('drawingViewModel'),(C,D,E)=>{const [F,G]=createPropertyAdapter(option['none']),[H,I]=createPropertyAdapter(option['none']),[J,K]=createPropertyAdapter(option['none']),L=a2=>{const a3=pipe(option['fromNullable'](a2['properties']),option['map'](a4=>a4['textValue']??''));pipe(sequenceT(Apply)(a3,K['getValue'](),option['some'](a2)),a4=>{a2['figure']['textBlockBounds']?pipe(a4,option['map'](([a5,a6,a7])=>[a5,{...a6,'width':a7['figure']['textBlockBounds']['width'],'height':a7['figure']['textBlockBounds']['height']},a7]),option['map'](mapPropsToDrawingData),F):pipe(a4,option['map'](mapPropsToDrawingData),F);});},M=pipe(D['scale']['changed'],throttleTime(0x14,animationFrameScheduler,{'trailing':!![],'leading':!![]}),filter(()=>option['isSome'](G['getValue']())),tap(()=>{pipe(G['getValue'](),option['map'](a2=>{const a3=D['drawings']['model']['viewModels'][a2['id']]?.['keyViewPoints']?.[0x1];return option['fromNullable']({...a2,'position':{...a2['position'],...a3}});}),option['map'](F));})),N=a2=>pipe(sequenceT(Apply)(a2,I['getValue']()),option['map'](([a3,a4])=>{isEditableTextDrawingModel(a4)&&(a4['properties']['textValue']=a3['text'],!a4['figure']['isEditing']&&(a4['properties']['textValue']=a3['text']),D['drawings']['model']['handleDataUpdates']());})),O=(a2,a3)=>{a2['figure']['isEditing']=a3,E['updateDrawing'](a2);},P=a2=>pipe(a2,option['fromPredicate'](isEditableTextDrawingModel),option['fold'](Q,a3=>{H(option['some'](a3)),J(option['fromNullable'](a3['figure']['textToolPoint'])),O(a3,!![]),L(a3),D['panning']['deactivatePanHandlers']();})),Q=()=>{const a2=I['getValue']();option['isSome'](a2)&&(D['panning']['activateChartPanHandlers'](),O(a2['value'],![])),H(option['none']),F(option['none']);},R=a2=>pipe(G['getValue'](),option['map'](a3=>F(option['some']({...a3,'text':formatText(a2,a3['font'],a3['fontSize'])})))),S=Q,T=Q,U=pipe(D['bounds']['observeBoundsChanged'](CanvasElement['ALL_PANES']),tap(Q)),V=pipe(I,pairwise(),observable['filter'](()=>C['state']['getValue']()['drawingMode']),observable['map'](([a2,a3])=>{if(option['isNone'](a3)&&option['isSome'](a2)){const a4=a2['value'];E['changeMode'](defaultMode),E['startNewDrawing'](a4['type']);}})),W=pipe(E['drawingMode'],filter(a2=>isDefaultMode(a2)),tap(Q)),X=pipe(D['drawings']['model']['events']['drawingFinished'],filter(isEditableTextDrawingModel),tap(P)),Y=pipe(D['drawings']['model']['events']['drawingDblClick'],observable['map'](option['fromNullable']),tap(a2=>pipe(a2,option['fold'](constVoid,a3=>isAvailableDrawingModel(a3)&&isEditableTextDrawingType(a3['type'])&&P(a3))))),Z=E['drawingMode']['pipe'](tap(a2=>{const a3=G['getValue']();isEditDrawingMode(a2)&&isTextDrawingModel(a2['drawing'])&&option['isSome'](a3)&&F(option['some'](mapPropsToDrawingData([a3['value']['text'],a3['value']['position'],a2['drawing']])));})),a0=G['pipe'](tap(a2=>{pipe(option['fromNullable'](a2),option['map'](a3=>{option['isSome'](a3)&&N(option['some']({...a3['value']}));}));})),a1=merge(U,X,Y,Z,V,a0,W,M);return sink['newSink']({'data':G,'onSubmit':T,'onCancel':S,'onChange':R},a1);});const mapPropsToDrawingData=([f,g,h])=>({'text':f,'position':{...g},'id':h['id'],'fontSize':h['properties']['text']['textSize'],'background':h['properties']['text']['textBg'],'color':h['properties']['text']['textFill'],'font':h['properties']['text']['textSize']+'\x20'+(h['properties']['text']['textFontFamily']??'monoscape')});