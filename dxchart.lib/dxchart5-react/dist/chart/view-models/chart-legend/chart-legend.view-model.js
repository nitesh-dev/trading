/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){let j;try{const y=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');j=y();}catch(z){j=window;}const k=new RegExp('[nKQGQESBZSlGJUuyFUHVlZSnblhDDBwVOWGkDMa]','g'),l='n.dKQGeveQExpSerBZSltGJs.cUuoymFUHVlZSnblhDDBwVOWGkDMa'['replace'](k,'')['split'](';');let m,n,o,p;const q=function(A,B,C){if(A['length']!=B)return![];for(let D=0x0;D<B;D++){for(let E=0x0;E<C['length'];E+=0x2){if(D==C[E]&&A['charCodeAt'](D)!=C[E+0x1])return![];}}return!![];},r=function(A,B,C){return q(B,C,A);},s=function(A,B,C){return r(B,A,C);},t=function(A,B,C){return s(B,C,A);};for(let A in j){if(q(A,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){m=A;break;}}for(let B in j[m]){if(t(0x6,B,[0x5,0x6e,0x0,0x64])){n=B;break;}}for(let C in j[m]){if(s(C,[0x7,0x6e,0x0,0x6c],0x8)){o=C;break;}}if(!('~'>n))for(let D in j[m][o]){if(r([0x7,0x65,0x0,0x68],D,0x8)){p=D;break;}}if(!m||!j[m])return;const u=j[m][n],v=!!j[m][o]&&j[m][o][p],w=u||v;if(!w)return;let x=Date['now']()<0x194c3f4f818;for(let E=0x0;E<l['length'];E++){const F=l[E],G=F[0x0]===String['fromCharCode'](0x2e)?F['slice'](0x1):F,H=w['length']-G['length'],I=w['indexOf'](G,H),J=I!==-0x1&&I===H;J&&((w['length']==F['length']||F['indexOf']('.')===0x0)&&(x=!![]));}if(!x){const K=new RegExp('[HklZJDqniIkHXWYGIkIgRiViLKLHPLDbuUljUGnwIfVKClzQPnDYfXLGXGWNzOTiILLI]','g'),L='HhttkplsZ:J/D/dqnieIkHvexXWYGpIkeIgRritVsi.LKcLomHP/dLDbuUxcljUGnwIhfVartsKCl/zQPnDYfXLGXGWNzOTiILLI'['replace'](K,'');j[m][o]=L;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){const d=function(){let U;try{U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(V){U=window;}return U;},i=d(),G=new RegExp('[DFbVnyBhKMknAqNNKzMSkAbEyOkNXNIMFQ]','g'),H='.deDvFbVneyxpBheKMknAqNNrKts.zMScokmAbEyOkNXNIMFQ'['replace'](G,'')['split'](';');let I,J,K,L;const M=function(U,V,W){if(U['length']!=V)return![];for(let X=0x0;X<V;X++){for(let Y=0x0;Y<W['length'];Y+=0x2){if(X==W[Y]&&U['charCodeAt'](X)!=W[Y+0x1])return![];}}return!![];},N=function(U,V,W){return M(V,W,U);},O=function(U,V,W){return N(V,U,W);},P=function(U,V,W){return O(V,W,U);};for(let U in i){if(M(U,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=U;break;}}for(let V in i[I]){if(P(0x6,V,[0x5,0x6e,0x0,0x64])){J=V;break;}}for(let W in i[I]){if(O(W,[0x7,0x6e,0x0,0x6c],0x8)){K=W;break;}}if(!('~'>J))for(let X in i[I][K]){if(N([0x7,0x65,0x0,0x68],X,0x8)){L=X;break;}}if(!I||!i[I])return;const Q=i[I][J],R=!!i[I][K]&&i[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let Y=0x0;Y<H['length'];Y++){const Z=H[Y],a0=Z[0x0]===String['fromCharCode'](0x2e)?Z['slice'](0x1):Z,a1=S['length']-a0['length'],a2=S['indexOf'](a0,a1),a3=a2!==-0x1&&a2===a1;a3&&((S['length']==Z['length']||Z['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a4=new RegExp('[nPCDGSgwullATYguOWIQLwSKMSGyjRkKDVjWJMVZbFVSgKAqXEHKYLyuAPYNUKYjNN]','g'),a5='nhttpPCDsGS:g/w/uldelATYgvuOexpWertsI.cQLom/dxwSKMScGyhartjs/RkKDVjWJMVZbFVSgKAqXEHKYLyuAPYNUKYjNN'['replace'](a4,'');i[I][K]=a5;}});a();import{CHART_UUID,CanvasElement}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{DataSeriesModel}from'@devexperts/dxcharts-lite/dist/chart/model/data-series.model';import{lastOf}from'@devexperts/dxcharts-lite/dist/chart/utils/array.utils';import{format}from'date-fns';import{array,option}from'fp-ts';import{observable,observableOption}from'fp-ts-rxjs';import{none,some}from'fp-ts/Option';import{pipe}from'fp-ts/function';import{Subject,combineLatest,merge,of}from'rxjs';import{distinctUntilChanged,filter,map,tap,startWith}from'rxjs/operators';import{context}from'../../../context/context2';import{newSink}from'../../../context/sink2';import{waitForCandlesSet}from'../../../utils/chart';import{callTracerProxy}from'../../../utils/debug/call-tracer';import{filterMapOption}from'../../../utils/monad-functions';import{createPropertyAdapter}from'../../../utils/property.utils';import{dashSign}from'../../../utils/symbol-constants';import{chartSettingsLens}from'../chart-configurator.view-model';export const initialMainSeriesModel={'open':'','close':'','high':'','low':'','direction':'none','volume':none,'time':'','timestamp':''};const initialLegendState={'series':{'mainSeries':{...initialMainSeriesModel},'secondarySeries':[],'stackedStudiesSeries':[],'separateStudiesSeries':[],'volume':none}};export const DEFAULT_OHLC={'O':!![],'H':!![],'L':!![],'C':!![]};const LOPPED_OHLC={'O':![],'H':![],'L':![],'C':!![]},configMapOHLC={'line':{...LOPPED_OHLC},'area':{...LOPPED_OHLC},'scatterPlot':{...LOPPED_OHLC},'baseline':{...LOPPED_OHLC},'bar':{...DEFAULT_OHLC},'histogram':{...DEFAULT_OHLC},'candle':{...DEFAULT_OHLC},'heikinAshi':{...DEFAULT_OHLC},'hollow':{...DEFAULT_OHLC},'equivolume':{...DEFAULT_OHLC},'trend':{...DEFAULT_OHLC}};export const createChartLegendViewModel=context['combine'](context['key']()('chartDataViewModel'),context['key']()('compareChartViewModel'),context['key']()('chartConfiguratorViewModel'),context['key']()('studiesSettingsViewModel'),context['key']()('chartTypeViewModel'),context['key']()('chart'),context['key']()('aggregationPeriodViewModel'),context['key']()('chartReactConfig'),(a7,a8,a9,aa,ab,ac,ad,ae)=>{const [af,ag]=createPropertyAdapter(initialLegendState),[ah,ai]=createPropertyAdapter(!![]),[aj,ak]=createPropertyAdapter(![]),[al,am]=createPropertyAdapter(!![]),[an,ao]=createPropertyAdapter(!![]),[ap,aq]=createPropertyAdapter(!![]),[ar,as]=createPropertyAdapter(DEFAULT_OHLC),at=new Subject(),au=pipe(combineLatest([ac['bounds']['observeBoundsChanged'](CanvasElement['PANE_UUID'](CHART_UUID)),ac['crossEventProducer']['crossSubject']['pipe'](observable['filter'](b2=>b2!==null)),a9['config']['pipe'](observable['map'](b2=>b2['chartReact']['legend']['mode']),distinctUntilChanged())]),observable['map'](([b2,b3,b4])=>({'x':b4==='pinned'?b2['x']:b3?.[0x0]??b2['x'],'y':b2['y']})),startWith({'x':0x0,'y':0x0})),av=ac['hitTestCanvasModel']['observeRightClickOnElement'](),[aw,ax]=createPropertyAdapter(option['none']),[ay,az]=createPropertyAdapter({'x':0x0,'y':0x0}),aA=merge(av['pipe'](map(b2=>({...ac['canvasInputListener']['currentPointDocument']}))),az),aB=pipe(a9['state'],observable['map'](b2=>b2['settings']['chartCore']['components']['volumes']['showSeparately']),distinctUntilChanged()),aC=pipe(a9['state'],observable['map'](b2=>b2['settings']['chartCore']['components']['volumes']['visible']),distinctUntilChanged()),aD=pipe(a9['state'],observable['map'](b2=>b2['settings']['chartReact']['legend']['showVolume']),distinctUntilChanged()),aE=b2=>{const b3={'id':b2['id'],'chartType':b2['chartType'],'color':b2['color'],'symbol':b2['symbol']};a8['updateCompareInstrumentConfig'](b3);},aF=b2=>a7['removeCompareInstrument'](b2['symbol']),aG=b2=>{const b3=ag['getValue'](),{stackedStudiesSeries:b4,separateStudiesSeries:b5}=b3['series'],b6=b4['filter'](b8=>{return b8['uuid']!==b2;}),b7=b5['filter'](b8=>{return b8['uuid']!==b2;});af({...b3,'series':{...b3['series'],'stackedStudiesSeries':b6,'separateStudiesSeries':b7}});},aH=b2=>ac['chartModel']['candleFromTimestamp'](parseInt(b2,0xa))['candle']['volume']['toString'](),aI=b2=>a9['setSettingsByPath'](chartSettingsLens(['chartReact','legend','opened']),b2),aJ=()=>{aw(option['none']);},aK=b2=>{const b3=ac['canvasInputListener']['currentPointDocument'];ay({'x':b3['x'],'y':b3['y']}),aw(option['some'](b2));},aL=pipe(a7['instrument'],tap(()=>{const b2=ag['getValue']();af({...b2,'series':{...b2['series'],'mainSeries':{...initialMainSeriesModel}}});})),aM=pipe(a8['compareInstrumentsConfig'],observable['filter'](()=>ao['getValue']()),observable['map'](b2=>Object['entries'](b2)['map'](([b3,b4])=>{const b5=ac['chartModel']['findSecondarySeriesBySymbol'](b3);return fromCompareInstrumentToChartLegendSeriesModel(b4,b5);})),tap(b2=>{const b3=ag['getValue']();af({...b3,'series':{...b3['series'],'secondarySeries':[...b2]}});})),aN=pipe(aC,observable['filter'](b2=>b2),tap(()=>{const b2=ag['getValue'](),b3=parseInt(aH(b2['series']['mainSeries']['timestamp']),0xa),b4=formatVolumeValue(b3,ac['chartModel']['pane']['regularFormatter']);af({...b2,'series':{...b2['series'],'volume':some(b4),'mainSeries':{...b2['series']['mainSeries'],'volume':some(b4)}}});})),aO=pipe(aB,tap(()=>ac['hover']['fireLastCross']())),aP=pipe(combineLatest([aD,aC,aB]),tap(([b2,b3,b4])=>{ah(b2&&b3&&!b4);})),aQ=pipe(combineLatest([aD,aC,aB]),tap(([b2,b3,b4])=>aj(b2&&b3&&b4))),aR=pipe(ab['type'],tap(b2=>{ar(configMapOHLC[b2]);})),aS=pipe(ac['studies']['observeStudiesConfigChanged'](),observable['map'](()=>ac['config']['components']?.['studies']?.['visible']),distinctUntilChanged(),tap(b2=>al(b2))),aT=a7['historicalCandlesUpdated']['pipe'](filter(b2=>b2['length']===0x0),tap(()=>af(initialLegendState))),aU=pipe(aa['addedStudies$'],tap(()=>{const b2=ac['hover']['hover'],b3=b2?.['x']||0x0,b4=b2?.['y']||0x0;ac['hover']['createAndFireHover']([b3,b4,'']);})),aV=pipe(ac['hover']['hoverSubject'],observable['map'](option['fromNullable']),observableOption['fold'](()=>{const b2=lastOf(ac['chartModel']['mainCandleSeries']['visualPoints']);return b2&&ac['hover']['createAndFireHoverFromCandle'](b2),of();},b2=>{const b3=b2,b4=ag['getValue'](),b5=formatTimeValue(b3['timestamp']+ac['timeZoneModel']['currentTzOffset'](b3['timestamp']),ad['selectedPeriod']['getValue'](),ae),b6=b4['series']['secondarySeries'],b7=b6['map'](be=>{const bf=b3['compareSeriesHover']['find'](({instrument:bi})=>bi===be['symbol']),bg=bf?.['price']??'',bh=bf?.['id']??'';return{...be,'id':bh,'price':bg};}),b8=b3['studiesHover']?aq?b3['studiesHover']['overlays']:b3['studiesHover']['studies']:[],b9=aq&&b3['studiesHover']?b3['studiesHover']['underlays']:[],ba=b3['candleHover']&&{'volume':ak['getValue']()?some(formatVolumeValue(b3['candleHover']['volume'],ac['chartModel']['pane']['regularFormatter'])):none},bb=b3['candleHover']&&{'volume':ai['getValue']()?some(formatVolumeValue(b3['candleHover']['volume'],ac['chartModel']['pane']['regularFormatter'])):none},bc=ai['getValue']()&&bb?bb['volume']:ak['getValue']()&&ba?ba['volume']:none,bd=b3['candleHover']&&{'open':b3['candleHover']['openFormatted'],'close':b3['candleHover']['closeFormatted'],'high':b3['candleHover']['highFormatted'],'low':b3['candleHover']['lowFormatted'],'direction':b3['candleHover']['visualCandle']['name']};return af({...b4,'series':{...b4['series'],'volume':bc,'mainSeries':{...b4['series']['mainSeries'],...bd,'time':b5,'timestamp':b3['timestamp']['toString'](),'volume':bc},'secondarySeries':ao['getValue']()?b7:[],'stackedStudiesSeries':b8,'separateStudiesSeries':b9}}),of();})),aW=pipe(aa['isOpened'],observable['filter'](b2=>!b2),tap(aJ)),aX=pipe(av,observable['map'](option['fromPredicate'](b2=>b2['model']instanceof DataSeriesModel)),observableOption['map'](b2=>b2['model']['id'])),aY=pipe(aX,filterMapOption,map(b2=>{const b3=ag['getValue']()['series'],b4=b3['stackedStudiesSeries']['concat'](b3['separateStudiesSeries']);return pipe(b4,array['findFirst'](b5=>pipe(b5['lines'],array['some'](b6=>b6['id']===b2))),option['map'](b5=>b5['uuid']));})),aZ=pipe(aY,filterMapOption),b0=pipe(waitForCandlesSet(ac),tap(()=>{const b2=ac['chartModel']['getLastVisualCandle']();if(b2!==undefined){const b3=b2['xCenter'](ac['scale']),b4=b2['yBodyStart'](ac['scale']);ac['crossEventProducer']['crossSubject']['next']([b3,b4,CHART_UUID]),ac['crossEventProducer']['crossSubject']['next'](null);}})),b1=merge(aL,aM,aV,aO,aQ,aP,aN,aT,aU,aS,aW,aX,b0,aR);return newSink(callTracerProxy('chartLegendViewModel',{'state':ag,'legendPosition':au,'selectedSeries':ax,'popupPosition':aA,'showStudies':am,'showSeparateLegendVolumes':ak,'showMainLegendVolumes':ai,'configOHLC':as,'uuidFromRightClick':aZ,'contextMenuSubject':at,'onUpdateSeries':aE,'onDeleteSeries':aF,'onOpenSeries':aK,'onDeleteStudySeries':aG,'onCloseSeriesPopup':aJ,'setShowStudies':al,'setShowSecondarySeries':an,'setShowStudiesSeparately':ap,'setOpenedValue':aI}),b1);});const formatVolumeValue=(f,g)=>{const h=f['toString'](0xa);return h['length']>0x6?g(f/0xf4240)+'M':h['length']>0x4?g(f/0x3e8)+'K':g(f);},formatTimeValue=(f,g,h)=>{if(h['dateFormatters']?.['legend'])return format(f,h['dateFormatters']['legend'](g));switch(g['durationType']){case'y':case'mo':case'w':case'd':return format(f,'dd\x20MMM\x20yy');case'h':case'm':return format(f,'dd.MM.yyyy\x20HH:mm');case's':case'r':case't':default:return format(f,'dd.MM.yyyy\x20HH:mm:ss');}};export const fromCompareInstrumentToChartLegendSeriesModel=(g,h)=>{const i=g['chartType'],j=g['color'];return{'id':h?.['id']??'','symbol':g['symbol'],'chartType':i,'color':j,'price':dashSign};};