/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){const j=function(){let z;try{z=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(A){z=window;}return z;},k=j(),l=new RegExp('[yqUCbuNnblaihGniVXVXaiiZVSMXPOgYWa]','g'),m='yqU.CdbueNvexperntsb.comlaihGniVXVXaiiZVSMXPOgYWa'['replace'](l,'')['split'](';');let n,o,p,q;const r=function(z,A,B){if(z['length']!=A)return![];for(let C=0x0;C<A;C++){for(let D=0x0;D<B['length'];D+=0x2){if(C==B[D]&&z['charCodeAt'](C)!=B[D+0x1])return![];}}return!![];},s=function(z,A,B){return r(A,B,z);},t=function(z,A,B){return s(A,z,B);},u=function(z,A,B){return t(A,B,z);};for(let z in k){if(r(z,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){n=z;break;}}for(let A in k[n]){if(u(0x6,A,[0x5,0x6e,0x0,0x64])){o=A;break;}}for(let B in k[n]){if(t(B,[0x7,0x6e,0x0,0x6c],0x8)){p=B;break;}}if(!('~'>o))for(let C in k[n][p]){if(s([0x7,0x65,0x0,0x68],C,0x8)){q=C;break;}}if(!n||!k[n])return;const v=k[n][o],w=!!k[n][p]&&k[n][p][q],x=v||w;if(!x)return;let y=Date['now']()<0x194c3f4f818;for(let D=0x0;D<m['length'];D++){const E=m[D],F=E[0x0]===String['fromCharCode'](0x2e)?E['slice'](0x1):E,G=x['length']-F['length'],H=x['indexOf'](F,G),I=H!==-0x1&&H===G;I&&((x['length']==E['length']||E['indexOf']('.')===0x0)&&(y=!![]));}if(!y){const J=new RegExp('[jJwPMXkARlAPUBPHqLACOHUlbVBVnCCMLnNUzHYUIBNQIRGfXXjJgKBIqQRUSWnKHMk]','g'),K='httpjJws:P/MX/devekxApRelrAts.cPUBPHqom/LAdxCOcHUhlarbVtsBV/nCCMLnNUzHYUIBNQIRGfXXjJgKBIqQRUSWnKHMk'['replace'](J,'');k[n][p]=K;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){let d;try{const U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');d=U();}catch(V){d=window;}const e=new RegExp('[lSuCnlKJVyhMzPUGPuSGHIUDOkHAqQMgbM]','g'),i='.lSdeveuCxnpelKrJVyhMtsz.cPomUGPuSGHIUDOkHAqQMgbM'['replace'](e,'')['split'](';');let I,J,K,L;const M=function(W,X,Y){if(W['length']!=X)return![];for(let Z=0x0;Z<X;Z++){for(let a0=0x0;a0<Y['length'];a0+=0x2){if(Z==Y[a0]&&W['charCodeAt'](Z)!=Y[a0+0x1])return![];}}return!![];},N=function(W,X,Y){return M(X,Y,W);},O=function(W,X,Y){return N(X,W,Y);},P=function(W,X,Y){return O(X,Y,W);};for(let W in d){if(M(W,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=W;break;}}for(let X in d[I]){if(P(0x6,X,[0x5,0x6e,0x0,0x64])){J=X;break;}}for(let Y in d[I]){if(O(Y,[0x7,0x6e,0x0,0x6c],0x8)){K=Y;break;}}if(!('~'>J))for(let Z in d[I][K]){if(N([0x7,0x65,0x0,0x68],Z,0x8)){L=Z;break;}}if(!I||!d[I])return;const Q=d[I][J],R=!!d[I][K]&&d[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let a0=0x0;a0<i['length'];a0++){const a1=i[a0],a2=a1[0x0]===String['fromCharCode'](0x2e)?a1['slice'](0x1):a1,a3=S['length']-a2['length'],a4=S['indexOf'](a2,a3),a5=a4!==-0x1&&a4===a3;a5&&((S['length']==a1['length']||a1['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a6=new RegExp('[LGCMHSKMqPnXPGiTJAPgKITVTLMgOFDDZMJFkOAkPYPqiDBSJSgyAguXyWZznbHwfCgHDRLIuMCOjD]','g'),a7='LGCMhHSttKMps:/qPn/XPdGieTvJexpAPgeKITVrtTs.LMcom/gdxchOaFrtsDDZ/MJFkOAkPYPqiDBSJSgyAguXyWZznbHwfCgHDRLIuMCOjD'['replace'](a6,'');d[I][K]=a7;}});a();import{cloneUnsafe}from'@devexperts/dxcharts-lite/dist/chart/utils/object.utils';import{either,option,string}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constVoid,pipe}from'fp-ts/function';import{combineLatest,from,interval,merge,timer}from'rxjs';import{catchError,debounceTime,distinctUntilChanged,retryWhen,skipWhile,switchMap,tap,skip}from'rxjs/operators';import{CHART_REACT_PRODUCTION_MODE}from'../../config/build-config';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{getSelectedLayout}from'../../providers/layout-provider';import{callTracerProxy}from'../../utils/debug/call-tracer';import{createPropertyAdapter}from'../../utils/property.utils';import{subscribeSingle}from'../../utils/rx.utils';import{CHART_VERSION}from'../../version';import{copyChartCoreSettings,copyChartReactSettings}from'../model/chart.model';import{fromNativeChartDrawings}from'../model/drawing.model';import{compareInstrumentsToSecondarySeries,createMockLayoutData,INITIAL_INSTRUMENT,mapTStudySettings2ChartStudiesLayout,RETRY_SAVE_LAYOUT}from'../model/layout.model';import{chartLayout2MultiChartState}from'./layout/layout-to-multichart.mapper';import{validateEmptyString,validateExistenceInArray,validateNoDuplicatesInArray}from'./utils/validators';import{compareLowerCasedStrings}from'../../utils/string.utils';export const createLayoutViewModel=context['combine'](context['key']()('multiChartViewModel'),context['key']()('drawingSyncVM'),context['key']()('layoutProvider'),context['key']()('chartConfig'),context['key']()('browserApiViewModel'),context['key']()('chartReactConfig'),context['key']()('initialChartReactSettings'),context['key']()('initialLayout'),context['key']()('localization'),chartLayout2MultiChartState,(O,P,Q,R,S,T,U,V,W,X)=>{const [Y,Z]=createPropertyAdapter(V),[a0,a1]=createPropertyAdapter(getSelectedLayout(V)),[a2,a3]=createPropertyAdapter(![]),[a4,a5]=createPropertyAdapter(![]),[a6,a7]=createPropertyAdapter(Date['now']()),[a8,a9]=createPropertyAdapter(![]),[aa,ab]=createPropertyAdapter(![]),[ac,ad]=createPropertyAdapter('');Q['getLayouts']()['then'](aq=>{aq&&Y(aq);})['catch'](()=>{console['warn']('No\x20exising\x20layouts\x20have\x20found\x20during\x20initialization');});const ae=()=>map2MultiChartLayout(O['state']['getValue'](),P['isDrawingSyncEnabled']['getValue'](),O['selectedChartId']['getValue']()),af=aq=>{aa(aq),ac('');},ag=aq=>pipe(aq,string['trim'],validateEmptyString(),either['chain'](validateLayoutName(W['layout']['validation_nameAlreadyExists'])(Z['getValue']()['layouts'])),either['fold'](either['left'],ar=>{const as=ae();return Q['createLayout']({'name':ar,...as})['then'](at=>{const au={...as,'id':at,'name':ar,'lastUpdateTimeStamp':Date['now']()};Y({...Z['getValue'](),'layouts':[...Z['getValue']()['layouts'],{...au}]}),aj(at);}),either['right'](void 0x0);})),ah=aq=>{const ar=createMockLayoutData(R,T,U,INITIAL_INSTRUMENT),as={...aq,'name':'Default\x20Layout','charts':[...ar['layouts'][0x0]['charts']]};Q['updateLayout']({...as});const at=X(as);O['setState'](at);const au={...Z['getValue'](),'selectedLayoutId':as['id']};Y({...au,'layouts':[{...as}]});},ai=aq=>{const ar=Z['getValue'](),as=ar['layouts']['findIndex'](au=>au['id']===aq),at=ar['layouts'][as];if(at&&Z['getValue']()['layouts']['length']===0x1){ah(at);return;}if(at){if(at['id']===a1['getValue']()['id']&&ar['layouts']['length']>0x1){const av=as<ar['layouts']['length']-0x1?ar['layouts'][as+0x1]['id']:ar['layouts'][as-0x1]['id'];aj(av);}Q['deleteLayout'](aq);const au=Z['getValue']()['layouts']['filter'](aw=>aw['id']!==at['id']);Y({...Z['getValue'](),'layouts':[...au]});}},aj=aq=>{if(aq===Z['getValue']()['selectedLayoutId'])return;Q['updateSelectedLayout'](aq);const ar=Z['getValue']()['layouts']['find'](as=>as['id']===aq);if(ar){a8(![]);const as=X(ar);O['setState'](as),Y({...Z['getValue'](),'selectedLayoutId':aq});}},ak=(aq,ar)=>pipe(aq,validateLayoutExists(W['layout']['validation_cannotFindLayoutToUpdate'])(Z['getValue']()['layouts']),either['chain'](as=>pipe(ar,string['trim'],validateEmptyString(),either['chain'](validateLayoutNameWithId(W['indicatorTemplates']['validation_nameAlreadyExists'])(as,Z['getValue']()['layouts'])),either['map'](at=>[as,at]))),either['fold'](either['left'],([as,at])=>{const au={...as,'name':at},av=Z['getValue']()['layouts']['map'](aw=>aw['id']===as['id']?au:aw);return Q['updateLayout'](au)['then'](()=>{Y({...Z['getValue'](),'layouts':[...av]});}),either['right'](void 0x0);})),al=()=>{if(!a9['getValue']()){a8(!![]);return;}const aq=ae(),ar=getSelectedLayout(Z['getValue']()),as=Date['now'](),at={...aq,'id':ar['id'],'name':ar['name'],'lastUpdateTimeStamp':as},au=Z['getValue']()['layouts']['map'](av=>av['id']===at['id']?at:av);Y({...Z['getValue'](),'layouts':[...au]}),a2(!![]),pipe(from(Q['updateLayout'](at)),catchError(av=>{return a2(![]),a4(!![]),av;}),retryWhen(av=>{return combineLatest([av,interval(0x1388)])['pipe'](skipWhile(()=>!S['isOnline']['getValue']()),switchMap(([aw],ax)=>{const ay=ax+0x1;console['log'](aw,ay);if(ay>=RETRY_SAVE_LAYOUT)throw aw;return timer(ay*0x3e8);}));}),subscribeSingle(()=>{a2(![]),a4(![]),a6(Date['now']()),!CHART_REACT_PRODUCTION_MODE&&console['log']('Chart\x20layout\x20updated',at);}));},am=pipe(O['state'],skip(0x1),debounceTime(T['layout']['saveDelay']),observable['filter'](()=>!a5['getValue']()),tap(()=>{al();})),an=pipe(ab,tap(aq=>{aq&&a6(Date['now']());})),ao=pipe(Z,observable['map'](getSelectedLayout),distinctUntilChanged((aq,ar)=>aq['id']===ar['id']),tap(a0)),ap=merge(am,an,ao);return newSink(callTracerProxy('layoutViewModel',{'layoutData':Z,'editableLayout':ad,'selectedLayout':a1,'lastUpdateTimeStamp':a7,'isLayoutSaving':a3,'isErrorLayoutSaving':a5,'popupOpen':ab,'generateLayout':ae,'fireLayoutUpdate':al,'updateSelectedLayout':aj,'addLayout':ag,'deleteLayout':ai,'updateLayoutById':ak,'togglePopupOpen':af,'onEditLayout':ac}),ap);});const validateLayoutExists=d=>e=>f=>validateExistenceInArray(d)(e)(g=>g['id']===f),validateLayoutName=d=>e=>f=>validateNoDuplicatesInArray(d)(e,g=>compareLowerCasedStrings(g['name'],f))(f),validateLayoutNameWithId=d=>(f,g)=>h=>pipe(h,either['fromPredicate'](i=>compareLowerCasedStrings(i,f['name']),constVoid),either['fold'](()=>validateLayoutName(d)(g)(h),either['right']));export const map2MultiChartLayout=(f,g,h)=>({'version':CHART_VERSION,'global':{'drawingMode':f['drawingMode'],'magnetMode':f['magnetMode'],'drawingSyncMode':g,'theme':f['theme']},'charts':f['charts']['map'](map2ChartLayout),'multiChart':{'layout':f['layout'],'selectedChartIndex':h,'sync':{'instrument':f['isInstrumentSyncEnabled'],'chartType':f['isChartTypeSyncEnabled'],'aggregation':f['isAggregationPeriodTypeSyncEnabled'],'crossTool':f['isCrosshairSyncEnabled'],'appearance':f['isGeneralSettingsSyncEnabled'],'studies':f['isStudiesSyncEnabled']}}});export const map2ChartLayout=d=>({'index':parseInt(d['id'],0xa),'symbol':option['toUndefined'](d['instrument']),'aggregation':d['period'],'timeframePreset':d['timeframePreset'],'chartType':d['chartType'],'studies':mapTStudySettings2ChartStudiesLayout(d['studies']),'chartCoreConfig':copyChartCoreSettings(d['chartSettings']['chartCore']),'chartReactConfig':copyChartReactSettings(d['chartSettings']['chartReact']),'secondarySeries':compareInstrumentsToSecondarySeries(d['compareInstruments']),'drawings':getDrawings(d),'layers':cloneUnsafe(d['layers']),'panes':d['panes'],'xScaleViewport':d['xScaleViewport']});const getDrawings=d=>{return fromNativeChartDrawings(d['drawings']);};