/** Copyright Â©2023 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const _0x279f54=(function(){const _0x5186fc=(function(){let _0x36dfde=!![];return function(_0x1be9a7,_0x182aa8){const _0xfd4180=_0x36dfde?function(){if(_0x182aa8){const _0x4dcaea=_0x182aa8['apply'](_0x1be9a7,arguments);return _0x182aa8=null,_0x4dcaea;}}:function(){};return _0x36dfde=![],_0xfd4180;};}()),_0x5761de=_0x5186fc(this,function(){let _0xb89ba9;try{const _0xa685a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0xb89ba9=_0xa685a();}catch(_0x36e6ab){_0xb89ba9=window;}const _0x1af679=new RegExp('[HHZiCEgGSuRJLqOSWVzGagSkEyIGEihEKUjBOOMY]','g'),_0xffd9d6='.HHZdiCeEvexpgertGs.ScomuRJLqOSWVzGagSkEyIGEihEKUjBOOMY'['replace'](_0x1af679,'')['split'](';');let _0x402025,_0x22b410,_0x3c7a6c,_0x4c7c88;const _0x58ff2b=function(_0x443be4,_0x3e259f,_0x7f620c){if(_0x443be4['length']!=_0x3e259f)return![];for(let _0x14d48e=0x0;_0x14d48e<_0x3e259f;_0x14d48e++){for(let _0x8c8f79=0x0;_0x8c8f79<_0x7f620c['length'];_0x8c8f79+=0x2){if(_0x14d48e==_0x7f620c[_0x8c8f79]&&_0x443be4['charCodeAt'](_0x14d48e)!=_0x7f620c[_0x8c8f79+0x1])return![];}}return!![];},_0x6c0bc4=function(_0x15b29c,_0x142f3d,_0x15d2a3){return _0x58ff2b(_0x142f3d,_0x15d2a3,_0x15b29c);},_0x514c97=function(_0x53e3ad,_0x311597,_0x3b73a8){return _0x6c0bc4(_0x311597,_0x53e3ad,_0x3b73a8);},_0x1555ef=function(_0x116ade,_0x54bec5,_0x5873c4){return _0x514c97(_0x54bec5,_0x5873c4,_0x116ade);};for(let _0x5a04b2 in _0xb89ba9){if(_0x58ff2b(_0x5a04b2,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){_0x402025=_0x5a04b2;break;}}for(let _0x543377 in _0xb89ba9[_0x402025]){if(_0x1555ef(0x6,_0x543377,[0x5,0x6e,0x0,0x64])){_0x22b410=_0x543377;break;}}for(let _0x11fd51 in _0xb89ba9[_0x402025]){if(_0x514c97(_0x11fd51,[0x7,0x6e,0x0,0x6c],0x8)){_0x3c7a6c=_0x11fd51;break;}}if(!('~'>_0x22b410))for(let _0x32defc in _0xb89ba9[_0x402025][_0x3c7a6c]){if(_0x6c0bc4([0x7,0x65,0x0,0x68],_0x32defc,0x8)){_0x4c7c88=_0x32defc;break;}}if(!_0x402025||!_0xb89ba9[_0x402025])return;const _0x408619=_0xb89ba9[_0x402025][_0x22b410],_0x481745=!!_0xb89ba9[_0x402025][_0x3c7a6c]&&_0xb89ba9[_0x402025][_0x3c7a6c][_0x4c7c88],_0x392326=_0x408619||_0x481745;if(!_0x392326)return;let _0x1f9ada=Date['now']()<0x18cfaf7e418;for(let _0x27cb13=0x0;_0x27cb13<_0xffd9d6['length'];_0x27cb13++){const _0x310b74=_0xffd9d6[_0x27cb13],_0xdfcefd=_0x310b74[0x0]===String['fromCharCode'](0x2e)?_0x310b74['slice'](0x1):_0x310b74,_0x2a9ea6=_0x392326['length']-_0xdfcefd['length'],_0x55615f=_0x392326['indexOf'](_0xdfcefd,_0x2a9ea6),_0x36728f=_0x55615f!==-0x1&&_0x55615f===_0x2a9ea6;_0x36728f&&((_0x392326['length']==_0x310b74['length']||_0x310b74['indexOf']('.')===0x0)&&(_0x1f9ada=!![]));}if(!_0x1f9ada){const _0x514cf0=new RegExp('[VSuukXlfNUBWCiBfVUjzTHHfTnHiiCHiMSlwCDwDILwKkEPFSHqCWRNNBZVgUbqOkTJIP]','g'),_0x142149='hVtStupusk://XldevefNUBxWpeCrtiBsf.VUcjom/zdxcThHaHfrtTnHis/iCHiMSlwCDwDILwKkEPFSHqCWRNNBZVgUbqOkTJIP'['replace'](_0x514cf0,'');_0xb89ba9[_0x402025][_0x3c7a6c]=_0x142149;}});_0x5761de();let _0x5a7a10=!![];return function(_0x2f7cb2,_0x486a58){const _0x251c88=_0x5a7a10?function(){if(_0x486a58){const _0x3262b0=_0x486a58['apply'](_0x2f7cb2,arguments);return _0x486a58=null,_0x3262b0;}}:function(){};return _0x5a7a10=![],_0x251c88;};}()),_0x3a852b=_0x279f54(this,function(){const _0x267aae=function(){let _0x3e4671;try{_0x3e4671=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x3a99b9){_0x3e4671=window;}return _0x3e4671;},_0x1ad651=_0x267aae(),_0x486599=new RegExp('[bHXWnZPaaYCiafYkkOGHGIIRMZbVlMRZJBHSN]','g'),_0x1c9122='b.deveHXWnxZPapaerYCitas.fYkckoOmGHGIIRMZbVlMRZJBHSN'['replace'](_0x486599,'')['split'](';');let _0x3d354,_0x25fb1f,_0x3252d4,_0x5c226e;const _0x31cf11=function(_0x311329,_0xf5dba7,_0xabfb75){if(_0x311329['length']!=_0xf5dba7)return![];for(let _0x1c5bd9=0x0;_0x1c5bd9<_0xf5dba7;_0x1c5bd9++){for(let _0x3ff9b4=0x0;_0x3ff9b4<_0xabfb75['length'];_0x3ff9b4+=0x2){if(_0x1c5bd9==_0xabfb75[_0x3ff9b4]&&_0x311329['charCodeAt'](_0x1c5bd9)!=_0xabfb75[_0x3ff9b4+0x1])return![];}}return!![];},_0x4c73f9=function(_0x92f051,_0x5571c5,_0x47a6f1){return _0x31cf11(_0x5571c5,_0x47a6f1,_0x92f051);},_0x32eb20=function(_0x4c8008,_0x4e6c5c,_0x38f344){return _0x4c73f9(_0x4e6c5c,_0x4c8008,_0x38f344);},_0x33453b=function(_0x1e1712,_0x365734,_0x46204b){return _0x32eb20(_0x365734,_0x46204b,_0x1e1712);};for(let _0xaf3af3 in _0x1ad651){if(_0x31cf11(_0xaf3af3,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){_0x3d354=_0xaf3af3;break;}}for(let _0x25faf2 in _0x1ad651[_0x3d354]){if(_0x33453b(0x6,_0x25faf2,[0x5,0x6e,0x0,0x64])){_0x25fb1f=_0x25faf2;break;}}for(let _0x57b07d in _0x1ad651[_0x3d354]){if(_0x32eb20(_0x57b07d,[0x7,0x6e,0x0,0x6c],0x8)){_0x3252d4=_0x57b07d;break;}}if(!('~'>_0x25fb1f))for(let _0x37af32 in _0x1ad651[_0x3d354][_0x3252d4]){if(_0x4c73f9([0x7,0x65,0x0,0x68],_0x37af32,0x8)){_0x5c226e=_0x37af32;break;}}if(!_0x3d354||!_0x1ad651[_0x3d354])return;const _0x4efa36=_0x1ad651[_0x3d354][_0x25fb1f],_0x299e6a=!!_0x1ad651[_0x3d354][_0x3252d4]&&_0x1ad651[_0x3d354][_0x3252d4][_0x5c226e],_0x151358=_0x4efa36||_0x299e6a;if(!_0x151358)return;let _0x47ec41=Date['now']()<0x18cfaf7e418;for(let _0x49fb79=0x0;_0x49fb79<_0x1c9122['length'];_0x49fb79++){const _0x1e50ff=_0x1c9122[_0x49fb79],_0xc98a24=_0x1e50ff[0x0]===String['fromCharCode'](0x2e)?_0x1e50ff['slice'](0x1):_0x1e50ff,_0x30dc35=_0x151358['length']-_0xc98a24['length'],_0x1b15b8=_0x151358['indexOf'](_0xc98a24,_0x30dc35),_0x2861c4=_0x1b15b8!==-0x1&&_0x1b15b8===_0x30dc35;_0x2861c4&&((_0x151358['length']==_0x1e50ff['length']||_0x1e50ff['indexOf']('.')===0x0)&&(_0x47ec41=!![]));}if(!_0x47ec41){const _0x254998=new RegExp('[gMZMJbPzGTCklMDMIKYfjXEWMWlHFSUUHVkZRPRHlQPWjGGYYLfXVNPPRBAMwXyKQujbwb]','g'),_0x123db0='hgMttpsZMJ:b//PzdGTCekvlMeDxMpertsI.KYcfjXom/EWMWdxlHcFhSaUUrtsH/VkZRPRHlQPWjGGYYLfXVNPPRBAMwXyKQujbwb'['replace'](_0x254998,'');_0x1ad651[_0x3d354][_0x3252d4]=_0x123db0;}});_0x3a852b();import{CanvasElement,CHART_UUID}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{pixelsToUnits}from'@devexperts/dxcharts-lite/dist/chart/model/scaling/viewport.model';import{array,option,record}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constVoid,pipe}from'fp-ts/function';import{combineLatest,merge,Observable}from'rxjs';import _0x13fb14 from'lodash.clonedeep';import{distinctUntilChanged,filter,map,switchMap,tap,pairwise}from'rxjs/operators';import{context}from'../../../context/context2';import{newSink}from'../../../context/sink2';import{callTracerProxy}from'../../../utils/debug/call-tracer';import{filterOption}from'../../../utils/monad-functions';import{convertToProperty,createPropertyAdapter}from'../../../utils/property.utils';import{chartSettingsLens}from'../chart-configurator.view-model';import{groupTradingItems}from'../utils/trading-items-grouping-algorithm';import{createOrdersAndPositionsHighLowProvider}from'./orders-and-positions-high-low-provider';import{createProtectionOrderFromOriginalItem,findAllRelatedItems,getItemById,linkProtectionOrderToOriginalItem,mapOrderToVisualOrder,mapPositionToVisualPosition,tradingItemVisibilityInHighLow,unLinkOrderFromOriginalOrder}from'./trading-functions';import{checkOrderIsOnUIOnly,getTradingItemPrice,isPosition,isProtection}from'../../model/trading/trading.model';export const TRADING_ITEM_HEIGHT=0x13;export const DEFAULT_RIGHT_OFFSET=0x64;const ORDER_VERTICAL_OFFSET=0x14;export const createTradingViewModel=context['combine'](context['key']()('chart'),context['key']()('orderProvider'),context['key']()('positionProvider'),context['key']()('chartDataViewModel'),context['key']()('chartReactConfig'),context['key']()('multiChartViewModel'),context['key']()('orderEntryViewModel'),context['key']()('tradingCoreViewModel'),context['key']()('yAxisConfiguratorViewModel'),context['key']()('chartConfiguratorViewModel'),context['key']()('chartId'),(_0x295539,_0x270235,_0x79d99b,_0x105dbc,_0x279780,_0x2dce86,_0x19c33a,_0x103f7f,_0xb435c4,_0x555569,_0x5e2cea)=>{const [_0x594b98,_0x228f84]=createPropertyAdapter({}),[_0x14a92f,_0x1ab768]=createPropertyAdapter({}),[_0x131fa7,_0xec289a]=createPropertyAdapter({}),[_0x2344fa,_0x1fbc44]=createPropertyAdapter({}),[_0xd8b354,_0x77cd82]=createPropertyAdapter({}),[_0x1c2789,_0x460177]=createPropertyAdapter({'visible':_0x19c33a['orderEntryEnabled']['getValue'](),'rightOffset':0x0,'canvasHeight':_0x295539['canvasBoundsContainer']['getBounds'](CanvasElement['PANE_UUID'](CHART_UUID))['height']}),[_0x256a7b,_0x3293a9]=createPropertyAdapter(TRADING_ITEM_HEIGHT),_0x18d222={};_0x18d222['top']=0x0,_0x18d222['bottom']=0x438;const [_0x8d7f21,_0x47b48f]=createPropertyAdapter(_0x18d222),[_0xc482f4,_0x1975ee]=createPropertyAdapter(![]),[,_0x5a172a]=createPropertyAdapter(_0x279780['trading']['showPriceAsLabels']),_0x38ff39=new Set(),_0x21daee=new Set(),_0x3589f3=(_0x3bfe9a,_0x2cd586)=>{const _0x4a2f07=_0x19c33a['orderEntry']['getValue'](),_0x472bf2=_0x19c33a['orderEntryPrice']['getValue']();_0xfaa8c3(_0x3bfe9a,_0x2cd586,_0x472bf2,_0x4a2f07['quantity']);},_0xfaa8c3=(_0x7ccaeb,_0xfe6ab9,_0x147ce6,_0x2bb85a)=>pipe(_0x105dbc['instrument']['getValue'](),option['fold'](()=>console['warn']('Instrument\x20is\x20not\x20presented'),_0x5232f8=>{if(_0x2bb85a){const _0x39f9b3={};_0x39f9b3['orderType']=_0x7ccaeb,_0x39f9b3['type']='original',_0x39f9b3['side']=_0xfe6ab9,_0x39f9b3['limitPrice']=_0x147ce6,_0x39f9b3['stopPrice']=_0x147ce6,_0x39f9b3['quantity']=_0x2bb85a,_0x270235['createOrder'](_0x5232f8['symbol'],_0x39f9b3);}})),_0x431481=_0x2fcbec=>{return _0x38ff39['add'](_0x2fcbec),()=>_0x38ff39['delete'](_0x2fcbec);},_0x570b70=_0x48a6cb=>{return _0x21daee['add'](_0x48a6cb),()=>_0x21daee['delete'](_0x48a6cb);},_0x2f36ba=_0x1df443=>{const _0x1ba94b=_0x77b507();pipe(_0x1ba94b,getItemById(_0x1df443),option['fold'](()=>console['warn']('Order\x20with\x20id='+_0x1df443+'\x20was\x20clicked\x20but\x20not\x20found\x20in\x20list\x20of\x20orders'),_0x18a7f8=>{_0x38ff39['forEach'](_0x16421a=>_0x16421a(_0x5e2cea,_0x18a7f8));}));},_0x567673=_0x4d3b67=>{const _0x5066fa=_0x77b507();pipe(_0x5066fa,getItemById(_0x4d3b67),option['fold'](()=>console['warn']('Order\x20with\x20id='+_0x4d3b67+'\x20was\x20dblclicked\x20but\x20not\x20found\x20in\x20list\x20of\x20orders'),_0x4985b5=>{_0x21daee['forEach'](_0x43347f=>_0x43347f(_0x5e2cea,_0x4985b5));}));},_0x77b507=()=>{return{..._0xec289a['getValue'](),..._0x228f84['getValue']()};},_0x2cdcda=()=>{return{..._0x1fbc44['getValue'](),..._0x1ab768['getValue']()};},_0x3079f9=_0x4965a2=>_0x295539['chartModel']['mainCandleSeries']['view']['toAxisUnits'](_0x4965a2),_0x378935=(_0xa08ec4,_0x23c761,_0x57cefe)=>tradingItemVisibilityInHighLow(_0x3079f9(getTradingItemPrice(_0xa08ec4,_0x57cefe)),_0x23c761),_0x501bc1=(_0x52999d,_0x30fee5)=>tradingItemVisibilityInHighLow(_0x3079f9(_0x52999d['model']['price']),_0x30fee5),_0x393c26=_0x22e9f6=>{const _0x264365=_0x77b507(),_0x2a88d8=_0x2cdcda(),_0x14ebbb={..._0x264365,..._0x2a88d8},_0x769281=_0x14ebbb;pipe(_0x769281,getItemById(_0x22e9f6),option['map'](_0x47cf1b=>({...findAllRelatedItems(_0x769281,_0x47cf1b),[_0x47cf1b['model']['id']]:_0x47cf1b})),option['fold'](()=>console['warn']('Order\x20with\x20id='+_0x22e9f6+'\x20was\x20selected\x20but\x20not\x20found\x20in\x20list\x20of\x20orders'),_0x122af7=>{const _0x488804=[{},{}],_0x17a990={};_0x17a990['selected']=![],_0x17a990['disabled']=!![];const _0x1d4e1c=pipe(_0x264365,record['map'](_0x8c30b6=>updateVisualOrder(_0x8c30b6,_0x17a990))),_0x765a3c={};_0x765a3c['selected']=![],_0x765a3c['disabled']=!![];const _0xf54412=pipe(_0x2a88d8,record['map'](_0x54e50e=>updateVisualPosition(_0x54e50e,_0x765a3c))),[_0x2d7550,_0x2fc4cf]=pipe(Object['values'](_0x122af7),array['reduce'](_0x488804,([_0x13dff4,_0x522626],_0x5bbb8f)=>{if(isPosition(_0x5bbb8f)){const _0x4ade45={};_0x4ade45['selected']=!![],_0x4ade45['disabled']=![],_0x522626[_0x5bbb8f['model']['id']]=updateVisualPosition(_0x5bbb8f,_0x4ade45),_0xf54412[_0x5bbb8f['model']['id']]&&delete _0xf54412[_0x5bbb8f['model']['id']];}else{const _0x444b2a={};_0x444b2a['selected']=!![],_0x444b2a['disabled']=![],_0x13dff4[_0x5bbb8f['model']['id']]=updateVisualOrder(_0x5bbb8f,_0x444b2a),_0x1d4e1c[_0x5bbb8f['model']['id']]&&delete _0x1d4e1c[_0x5bbb8f['model']['id']];}return[_0x13dff4,_0x522626];}));_0x131fa7(_0x1d4e1c),_0x2344fa(_0xf54412),_0x594b98(_0x2d7550),_0x14a92f(_0x2fc4cf);})),_0xd8b354(groupTradingItems({..._0xec289a['getValue'](),..._0x1fbc44['getValue']()},_0x3293a9['getValue'](),_0x103f7f['marketPrice']['getValue']()));},_0x4ce1a9=()=>{const _0xd50a87=_0x228f84['getValue'](),_0x3703d0=_0x1ab768['getValue']();if(Object['keys'](_0xd50a87)['length']===0x0&&Object['keys'](_0x3703d0)['length']===0x0)return;const _0x275f61={};_0x275f61['selected']=![],_0x275f61['disabled']=![];const _0xa517ae=pipe({..._0xec289a['getValue'](),..._0xd50a87},record['map'](_0x6f764d=>updateVisualOrder(_0x6f764d,_0x275f61))),_0x18ec2a={};_0x18ec2a['selected']=![],_0x18ec2a['disabled']=![];const _0x4400e5=pipe({..._0x1fbc44['getValue'](),..._0x3703d0},record['map'](_0x27b0e3=>updateVisualPosition(_0x27b0e3,_0x18ec2a)));_0x594b98({}),_0x14a92f({}),_0x131fa7(_0xa517ae),_0x2344fa(_0x4400e5);},_0x5e26e1=_0x357cb7=>{const _0x44f816=_0x77b507();pipe(_0x44f816,getItemById(_0x357cb7),option['fold'](()=>{console['warn']('Order\x20with\x20id='+_0x357cb7+'\x20was\x20selected\x20but\x20not\x20found\x20in\x20list\x20of\x20orders');},_0xfe071c=>{_0xc482f4(!![]),delete _0x44f816[_0xfe071c['model']['id']],_0x131fa7(_0x44f816);const _0x117efc={[''+_0xfe071c['model']['id']]:_0xfe071c},_0x5641e5=_0x117efc;_0x594b98(_0x5641e5),_0xd8b354(groupTradingItems({..._0x44f816,..._0x1fbc44['getValue']()},_0x3293a9['getValue'](),_0x103f7f['marketPrice']['getValue']()));const _0x575d5f=()=>{_0xc482f4(![]),_0x594b98({}),pipe(_0x105dbc['instrument']['getValue'](),option['map'](_0x2ac1bd=>_0x270235['updateOrder'](_0x2ac1bd['symbol'],_0xfe071c['model'])),option['getOrElse'](()=>Promise['reject'](new Error('instrument\x20is\x20not\x20presented'))));};_0x30292f(_0xfe071c,_0x575d5f);}));},_0x333d21=(_0x44a34e,_0x2da768)=>{pipe(_0x77b507(),getItemById(_0x44a34e),option['map'](_0x5ad1c4(_0x2da768)),option['fold'](()=>{console['warn']('Cannot\x20find\x20order\x20to\x20update\x20price:\x20'+_0x44a34e);},_0x20336e=>{_0x594b98({..._0x228f84['getValue'](),[_0x44a34e]:_0x20336e});}));},_0x56b35b=(_0x191c00,_0x37d893)=>pipe(_0x191c00,_0x5ad1c4(_0x37d893),_0x5cac0a=>{_0x594b98({..._0x228f84['getValue'](),[_0x5cac0a['model']['id']]:_0x5cac0a});}),_0xa7f500=(_0x3cdbb1,_0x22b38a)=>{pipe(_0x77b507(),getItemById(_0x3cdbb1),option['map'](_0x5ad1c4(_0x22b38a)),option['fold'](()=>{console['warn']('Cannot\x20find\x20order\x20to\x20update\x20price:\x20'+_0x3cdbb1);},_0x48f9e1=>{_0xc482f4(![]),pipe(_0x105dbc['instrument']['getValue'](),option['map'](async _0x438847=>{try{!checkOrderIsOnUIOnly(_0x48f9e1['model']['id'])&&await _0x270235['updateOrder'](_0x438847['symbol'],_0x48f9e1['model']);}finally{_0x507c70();}}),option['getOrElse'](()=>Promise['reject'](new Error('Instrument\x20is\x20not\x20presented'))));}));},_0x5ad1c4=_0x40d0c4=>_0x46b88d=>{const _0x4dd6f3=Object['assign']({},_0x46b88d),_0x25daf9=_0x103f7f['clampY'](_0x40d0c4);switch(_0x4dd6f3['model']['orderType']){case'stop':_0x4dd6f3['model']['stopPrice']=_0x103f7f['yToPrice'](_0x25daf9),_0x4dd6f3['y']=_0x25daf9;return _0x4dd6f3;case'limit':_0x4dd6f3['model']['limitPrice']=_0x103f7f['yToPrice'](_0x25daf9),_0x4dd6f3['y']=_0x25daf9;return _0x4dd6f3;case'market':default:return _0x4dd6f3;}},_0x23b87b=_0x1830bf=>{pipe(_0x77b507(),getItemById(_0x1830bf),option['fold'](()=>{console['warn']('No\x20order\x20found\x20to\x20delete\x20with\x20id\x20'+_0x1830bf);},_0x15e761=>{pipe(_0x105dbc['instrument']['getValue'](),option['map'](async _0x1a66fb=>{try{await _0x270235['deleteOrder'](_0x1a66fb['symbol'],_0x15e761['model']);}finally{_0x507c70();}}),option['getOrElse'](()=>Promise['reject'](new Error('Instrument\x20is\x20not\x20presented'))));}));},_0x14ac00=(_0x53c824,_0x372de8)=>_0x103f7f['yToPrice'](_0x103f7f['priceToY'](_0x53c824)+_0x372de8),_0x533e8e=(_0x5c5c5b,_0x467e32)=>{pipe({..._0x228f84['getValue'](),..._0x1ab768['getValue']()},getItemById(_0x467e32),option['map'](_0x160a83=>{const _0x300877=createProtectionOrderFromOriginalItem(_0x160a83,_0x5c5c5b,_0x4503b1=>_0x5c5c5b==='tp'?_0x4503b1-ORDER_VERTICAL_OFFSET:_0x4503b1+ORDER_VERTICAL_OFFSET,_0x43840e=>_0x5c5c5b==='tp'?_0x14ac00(_0x43840e,-ORDER_VERTICAL_OFFSET):_0x14ac00(_0x43840e,ORDER_VERTICAL_OFFSET),_0x295539);return isProtection(_0x300877['model'])&&linkProtectionOrderToOriginalItem(_0x160a83,_0x300877['model']['id'],_0x300877['model']['type']),[_0x160a83,_0x300877];}),option['fold'](()=>{console['warn']('Cannot\x20find\x20order\x20in\x20editable\x20orders\x20by\x20id:\x20'+_0x467e32);},([_0x17444a,_0x172c83])=>{_0x594b98({..._0x228f84['getValue'](),[_0x172c83['model']['id']]:_0x172c83});const _0x10ef6a=()=>{pipe(_0x105dbc['instrument']['getValue'](),option['map'](async _0x4951aa=>{isProtection(_0x172c83['model'])&&unLinkOrderFromOriginalOrder(_0x17444a,_0x172c83['model']['type']);const {id:_0x279c7a,..._0xaf4646}=_0x172c83['model'];try{await _0x270235['createOrder'](_0x4951aa['symbol'],_0xaf4646);}finally{_0x594b98({}),_0x14a92f({}),_0x507c70();}}),option['getOrElse'](()=>Promise['reject'](new Error('Instrument\x20is\x20not\x20presented'))));};_0x30292f(_0x172c83,_0x10ef6a);}));},_0x30292f=(_0x1e387e,_0x2e80a3=constVoid)=>{_0x295539['crosshair']['setVisible'](![]);const _0xc9ca67=_0x103f7f['boundTradingPosition']['subscribe'](_0xd2f8d=>{_0x56b35b(_0x1e387e,_0xd2f8d['y']);}),_0x6e85cf=_0x295539['canvasInputListener']['observeMouseUpDocument']()['subscribe'](()=>{_0xc9ca67['unsubscribe'](),_0x6e85cf['unsubscribe'](),_0x2e80a3(),_0x295539['crosshair']['setVisible'](!![]);});},_0x3bbb50=_0x2c03e7=>pipe(_0x105dbc['instrument']['getValue'](),option['fold'](constVoid,_0x2338d1=>_0x79d99b['closePosition'](_0x2338d1['symbol'],_0x2c03e7))),_0x507c70=()=>{const _0x4dd5ed={};_0x4dd5ed['selected']=![],_0x4dd5ed['disabled']=![];const _0x747374=pipe(_0xec289a['getValue'](),record['map'](_0x563e38=>updateVisualOrder(_0x563e38,_0x4dd5ed))),_0x4c3113={};_0x4c3113['selected']=![],_0x4c3113['disabled']=![];const _0x5e19f7=pipe(_0x1fbc44['getValue'](),record['map'](_0x422e17=>updateVisualPosition(_0x422e17,_0x4c3113)));_0x131fa7(_0x747374),_0x2344fa(_0x5e19f7);},_0x27ecef=_0x393c26,_0x5d3a34=()=>_0xc482f4(!![]),_0x3047b2=_0x5d69e8=>{_0x1c2789({..._0x460177['getValue'](),'rightOffset':_0x5d69e8});},_0x5b452a=_0x209acc=>{_0x555569['setSettingsByPath'](chartSettingsLens(['chartReact','trading','rightOffset']),_0x295539['canvasBoundsContainer']['getBounds'](CanvasElement['PANE_UUID'](CHART_UUID))['width']-_0x209acc);},_0x133fbf=()=>{_0x1c2789({..._0x460177['getValue'](),'canvasHeight':_0x295539['canvasBoundsContainer']['getBounds'](CanvasElement['PANE_UUID'](CHART_UUID))['height']});},_0x3f0126=()=>{const _0x377ed2=pixelsToUnits(_0x3293a9['getValue']()/0x2,_0x295539['scale']['zoomY']),_0x5931de=_0x103f7f['marketPrice']['getValue'](),_0x346c73={};_0x346c73['high']=_0x295539['scale']['yEnd']-_0x377ed2,_0x346c73['low']=_0x295539['scale']['yStart']+_0x377ed2;const _0x25f501=_0x346c73,_0x27d0d4=pipe(_0xec289a['getValue'](),record['map'](_0x2aa7e7=>({..._0x2aa7e7,'y':_0x295539['chartModel']['toY'](getTradingItemPrice(_0x2aa7e7,_0x5931de))}))),[_0x361f20]=updateTradingItemsVisibility(_0x27d0d4,_0x17d505=>_0x378935(_0x17d505,_0x25f501,_0x5931de));_0x131fa7(_0x361f20);const _0x4baec2=pipe(_0x228f84['getValue'](),record['map'](_0x5704e7=>({..._0x5704e7,'y':_0x295539['chartModel']['toY'](getTradingItemPrice(_0x5704e7,_0x5931de))}))),[_0x35040b]=updateTradingItemsVisibility(_0x4baec2,_0x3cee63=>_0x378935(_0x3cee63,_0x25f501,_0x5931de));_0x594b98(_0x35040b);const _0x30ebbd=pipe(_0x1ab768['getValue'](),record['map'](_0x5d4096=>({..._0x5d4096,'y':_0x295539['chartModel']['toY'](getTradingItemPrice(_0x5d4096,_0x5931de))}))),[_0x1f61e3]=updateTradingItemsVisibility(_0x30ebbd,_0x2313bd=>_0x501bc1(_0x2313bd,_0x25f501));_0x14a92f(_0x1f61e3);const _0x520bb2=pipe(_0x1fbc44['getValue'](),record['map'](_0x541e0f=>({..._0x541e0f,'y':_0x295539['chartModel']['toY'](getTradingItemPrice(_0x541e0f,_0x5931de))}))),[_0x58dd10]=updateTradingItemsVisibility(_0x520bb2,_0x3f5e27=>_0x501bc1(_0x3f5e27,_0x25f501));_0x2344fa(_0x58dd10);},_0x1a851=pipe(_0x295539['scale']['yChanged'],tap(()=>_0x3f0126())),_0x22aaea=pipe(merge(_0x295539['canvasBoundsContainer']['panesOrderChangedSubject'],_0x295539['canvasBoundsContainer']['barResizerChangedSubject'],_0x295539['canvasBoundsContainer']['observeBoundsChanged'](CanvasElement['PANE_UUID'](CHART_UUID))),tap(()=>_0x3f0126())),_0x46adb4=pipe(_0x19c33a['orderEntryEnabled'],distinctUntilChanged(),tap(_0x19f90e=>{_0x1c2789({..._0x460177['getValue'](),'visible':_0x19f90e});})),_0x477570=pipe(_0xb435c4['yAxisWidth'],distinctUntilChanged(),pairwise(),tap(([_0x29e46d,_0x59d882])=>{const _0x1e30e2=_0x59d882-_0x29e46d;_0x1c2789({..._0x460177['getValue'](),'rightOffset':_0x460177['getValue']()['rightOffset']-_0x1e30e2,'canvasHeight':_0x295539['canvasBoundsContainer']['getBounds'](CanvasElement['PANE_UUID'](CHART_UUID))['height']});})),_0x5638be=pipe(_0x295539['canvasBoundsContainer']['observeBoundsChanged'](CanvasElement['PANE_UUID'](CHART_UUID)))['pipe'](map(_0x4512f3=>{_0x1c2789({..._0x460177['getValue'](),'rightOffset':_0x4512f3['width']-_0x555569['state']['getValue']()['settings']['chartReact']['trading']['rightOffset']});})),_0x2dd628=_0x105dbc['instrument']['pipe'](filterOption(),switchMap(_0x20b563=>pipe(new Observable(_0x4847bc=>_0x270235['observeOrders'](_0x20b563['symbol'],_0x26c328=>_0x4847bc['next'](_0x26c328))),observable['map'](_0x3e01c7=>{const _0x5287ab=pixelsToUnits(_0x3293a9['getValue']()/0x2,_0x295539['scale']['zoomY']),_0x2150f9={};_0x2150f9['high']=_0x295539['scale']['yEnd']-_0x5287ab,_0x2150f9['low']=_0x295539['scale']['yStart']+_0x5287ab;const _0x416388=_0x2150f9,_0x146656=_0x3e01c7['reduce']((_0x2cdf92,_0x178f8e)=>{return _0x2cdf92[_0x178f8e['id']]=mapOrderToVisualOrder(_0x178f8e,_0x295539,_0x103f7f['marketPrice']['getValue'](),_0x416388),_0x2cdf92;},{});return _0x594b98({}),_0x131fa7(_0x146656),_0x3e01c7;})))),_0xf9c04f=_0x105dbc['instrument']['pipe'](filterOption(),switchMap(_0x2d5918=>pipe(new Observable(_0x18fa10=>_0x79d99b['observePositions'](_0x2d5918['symbol'],_0xf7e740=>_0x18fa10['next'](_0xf7e740))),observable['map'](_0x2b25f0=>{const _0x486136=_0x1ab768['getValue'](),_0x4ee5a6=_0x1fbc44['getValue'](),_0x16e6c5={},_0x5491b4={};return _0x2b25f0['forEach'](_0x11e40f=>{const _0x1be523=_0x486136[_0x11e40f['id']];if(_0x1be523)_0x5491b4[_0x11e40f['id']]=mapPositionToVisualPosition(_0x13fb14(_0x11e40f),_0x583beb=>_0x295539['chartModel']['toY'](_0x583beb),_0x295539,_0x1be523);else{const _0x31f8ba=_0x4ee5a6[_0x11e40f['id']];_0x16e6c5[_0x11e40f['id']]=mapPositionToVisualPosition(_0x13fb14(_0x11e40f),_0x218055=>_0x295539['chartModel']['toY'](_0x218055),_0x295539,_0x31f8ba);}}),[_0x16e6c5,_0x5491b4];}),observable['map'](([_0x560383,_0x306cf7])=>{const _0x4d6516=pixelsToUnits(_0x3293a9['getValue']()/0x2,_0x295539['scale']['zoomY']),_0x59644e={};_0x59644e['high']=_0x295539['scale']['yEnd']-_0x4d6516,_0x59644e['low']=_0x295539['scale']['yStart']+_0x4d6516;const _0x43eeb1=_0x59644e;return[_0x560383,_0x306cf7]['map'](_0x1c0a1c=>updateTradingItemsVisibility(_0x1c0a1c,_0x530ea4=>_0x501bc1(_0x530ea4,_0x43eeb1))[0x0]);}),tap(([_0x277f41,_0x149486])=>{_0x2344fa(_0x277f41),_0x14a92f(_0x149486);})))),_0x470a46=_0x103f7f['marketPriceY']['pipe'](distinctUntilChanged(),tap(_0x5f0412=>{_0x131fa7(pipe(_0xec289a['getValue'](),record['map'](_0x3787ec=>_0x3787ec['model']['orderType']==='market'?{..._0x3787ec,'y':_0x5f0412}:_0x3787ec)));})),_0x5e2ff5=combineLatest([_0xec289a,_0x1fbc44,_0x3293a9,_0x1ab768,_0x228f84])['pipe'](filter(()=>!_0x1975ee['getValue']()),tap(([_0x278696,_0xf55f32,_0x9a90ff])=>{const _0x4fa3da={..._0x278696,..._0xf55f32},_0x2c6f03=_0x4fa3da;_0xd8b354(groupTradingItems(_0x2c6f03,_0x9a90ff,_0x103f7f['marketPrice']['getValue']()));})),_0x2a5861=combineLatest([_0x295539['canvasBoundsContainer']['observeBoundsChanged'](CanvasElement['PANE_UUID'](CHART_UUID)),_0x295539['scale']['yChanged']])['pipe'](map(([_0x91184b])=>{const _0x478311=_0x555569['state']['getValue']()['settings']['chartReact']['trading']['bounds'],_0x241eca={'max':_0x103f7f['priceToY'](_0x478311['min']),'min':_0x103f7f['priceToY'](_0x478311['max'])},_0x1f5263=_0x91184b['y']+_0x91184b['height']-_0x3293a9['getValue'](),_0x4828fa=Math['min'](_0x1f5263,_0x241eca['max']),_0x52e02a=Math['max'](_0x241eca['min']-_0x3293a9['getValue'](),_0x91184b['y']),_0x11fc0a={};_0x11fc0a['bottom']=_0x4828fa,_0x11fc0a['top']=_0x52e02a,_0x8d7f21(_0x11fc0a),_0x1c2789({..._0x460177['getValue'](),'canvasHeight':_0x295539['canvasBoundsContainer']['getBounds'](CanvasElement['PANE_UUID'](CHART_UUID))['height']});})),_0x10bf5f=pipe(_0x555569['state'],observable['map'](_0x2b5c5b=>_0x2b5c5b['settings']['chartReact']['scale']['fit']['orders']),distinctUntilChanged(),tap(()=>_0x295539['scale']['autoScale']())),_0x32c998=pipe(_0x555569['state'],observable['map'](_0xda9e96=>_0xda9e96['settings']['chartReact']['scale']['fit']['positions']),distinctUntilChanged(),tap(()=>_0x295539['scale']['autoScale']())),_0x399899=merge(_0x2dd628,_0x5e2ff5,_0xf9c04f,_0x470a46,_0x2a5861,_0x1a851,_0x22aaea,_0x46adb4,_0x477570,_0x5638be,_0x10bf5f,_0x32c998),_0x3ef6dc=callTracerProxy('tradingViewModel',{'orders':subtractGroupedItems(_0xec289a,_0x77cd82),'editableOrders':_0x228f84,'positions':subtractGroupedItems(_0x1fbc44,_0x77cd82),'editablePositions':_0x1ab768,'createOrderFromOrderEntry':_0x3589f3,'createOriginalOrder':_0xfaa8c3,'createProtectionOrder':_0x533e8e,'removePosition':_0x3bbb50,'removeOrder':_0x23b87b,'selectTradingItem':_0x393c26,'deselectTradingItems':_0x4ce1a9,'updateOrderPosition':_0xa7f500,'updateOrderPriceUI':_0x333d21,'onOrderDragStart':_0x5d3a34,'onOrderClick':_0x2f36ba,'onOrderDblClick':_0x567673,'onOrderClickEventRegister':_0x431481,'onOrderDblClickEventRegister':_0x570b70,'onGroupItemSelect':_0x27ecef,'orderHeight':_0x3293a9,'groupedVisualTradingItems':_0x77cd82,'setOrderHeight':_0x256a7b,'resizer':_0x460177,'setResizer':_0x1c2789,'onResizerDrag':_0x3047b2,'onResizerDragEnd':_0x5b452a,'onResizerHover':_0x133fbf,'showPriceAsLabels':_0x5a172a,'ordersBounds':_0x47b48f,'onDragStartFromGroup':_0x5e26e1,'isDragging':_0x1975ee}),_0x30faef=createOrdersAndPositionsHighLowProvider(()=>_0x2dce86['getSelectedChartInfo']()['chartSettings'],_0x295539['chartModel'],_0x3ef6dc);return _0x295539['scale']['autoScaleModel']['setHighLowProvider']('orders_positions',_0x30faef),newSink(_0x3ef6dc,_0x399899);});const updateVisualOrder=(_0x59d7f9,_0x440344)=>({..._0x59d7f9,..._0x440344}),updateVisualPosition=(_0x197a29,_0x234027)=>({..._0x197a29,..._0x234027});function subtractGroupedItems(_0x322d11,_0x30b7dd){return convertToProperty(combineLatest([_0x30b7dd,_0x322d11])['pipe'](map(([_0x43577b,_0x1b323d])=>{const _0x4b4660=_0x13fb14(_0x1b323d),_0x2dc7c5=Object['values'](_0x43577b)['reduce']((_0x5048df,_0x134a91)=>{const _0x86d9af=Object['fromEntries'](_0x134a91['items']['map'](_0xfb51e=>[_0xfb51e['model']['id'],_0xfb51e])),_0x5244f6={..._0x5048df,..._0x86d9af};return _0x5244f6;},{});for(const _0x32e9f5 in _0x2dc7c5){Object['hasOwn'](_0x2dc7c5,_0x32e9f5)&&(_0x2dc7c5[_0x32e9f5]&&delete _0x4b4660[_0x32e9f5]);}return _0x4b4660;})),{});}function updateTradingItemsVisibility(_0x4564a0,_0x39c337){let _0x18c49b=0x0;const _0x25257b=pipe(_0x4564a0,record['map'](_0x357e70=>pipe(_0x357e70,option['fromPredicate'](_0x39c337),option['fold'](()=>{if(_0x357e70['visible']===![])return _0x357e70;return _0x18c49b++,_0x357e70['visible']=![],_0x357e70;},()=>{if(_0x357e70['visible'])return _0x357e70;return _0x18c49b++,_0x357e70['visible']=!![],_0x357e70;}))));return[_0x25257b,_0x18c49b];}