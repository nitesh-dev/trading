/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const j=(function(){let m=!![];return function(n,o){const p=m?function(){if(o){const q=o['apply'](n,arguments);return o=null,q;}}:function(){};return m=![],p;};}()),k=j(this,function(){let m;try{const B=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');m=B();}catch(C){m=window;}const n=new RegExp('[iCIkRRXAHAWuATIQubObgPuGCwEXORQ]','g'),o='i.CdIkReRveXAHxAperWuts.coAmTIQubObgPuGCwEXORQ'['replace'](n,'')['split'](';');let p,q,r,s;const t=function(D,E,F){if(D['length']!=E)return![];for(let G=0x0;G<E;G++){for(let H=0x0;H<F['length'];H+=0x2){if(G==F[H]&&D['charCodeAt'](G)!=F[H+0x1])return![];}}return!![];},u=function(D,E,F){return t(E,F,D);},v=function(D,E,F){return u(E,D,F);},w=function(D,E,F){return v(E,F,D);};for(let D in m){if(t(D,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){p=D;break;}}for(let E in m[p]){if(w(0x6,E,[0x5,0x6e,0x0,0x64])){q=E;break;}}for(let F in m[p]){if(v(F,[0x7,0x6e,0x0,0x6c],0x8)){r=F;break;}}if(!('~'>q))for(let G in m[p][r]){if(u([0x7,0x65,0x0,0x68],G,0x8)){s=G;break;}}if(!p||!m[p])return;const x=m[p][q],y=!!m[p][r]&&m[p][r][s],z=x||y;if(!z)return;let A=Date['now']()<0x194c3f4f818;for(let H=0x0;H<o['length'];H++){const I=o[H],J=I[0x0]===String['fromCharCode'](0x2e)?I['slice'](0x1):I,K=z['length']-J['length'],L=z['indexOf'](J,K),M=L!==-0x1&&L===K;M&&((z['length']==I['length']||I['indexOf']('.')===0x0)&&(A=!![]));}if(!A){const N=new RegExp('[yjqBSbgYPfPnblROMSlyTHnqOuyOwYflHAPZiyBPCnylAkGVfWRFiACwMIfEUQbqCRDTFjnEJzqCF]','g'),O='yjhtqBSbtpsgYPfP:/nblRO/devMSelyxTHnqOuyperOtwYsf.colmH/dxAcPZihyBPartsC/nylAkGVfWRFiACwMIfEUQbqCRDTFjnEJzqCF'['replace'](N,'');m[p][r]=O;}});k();let l=!![];return function(m,n){const o=l?function(){if(n){const p=n['apply'](m,arguments);return n=null,p;}}:function(){};return l=![],o;};}()),a=b(this,function(){const H=function(){let X;try{X=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(Y){X=window;}return X;},I=H(),J=new RegExp('[IhIPgUSLiFSwOEFuNPSQfXDjXluEDFMJuzRhA]','g'),K='.dIehveIxPpgeUrtSLiFSwsOE.cFuomNPSQfXDjXluEDFMJuzRhA'['replace'](J,'')['split'](';');let L,M,N,O;const P=function(X,Y,Z){if(X['length']!=Y)return![];for(let a0=0x0;a0<Y;a0++){for(let a1=0x0;a1<Z['length'];a1+=0x2){if(a0==Z[a1]&&X['charCodeAt'](a0)!=Z[a1+0x1])return![];}}return!![];},Q=function(X,Y,Z){return P(Y,Z,X);},R=function(X,Y,Z){return Q(Y,X,Z);},S=function(X,Y,Z){return R(Y,Z,X);};for(let X in I){if(P(X,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){L=X;break;}}for(let Y in I[L]){if(S(0x6,Y,[0x5,0x6e,0x0,0x64])){M=Y;break;}}for(let Z in I[L]){if(R(Z,[0x7,0x6e,0x0,0x6c],0x8)){N=Z;break;}}if(!('~'>M))for(let a0 in I[L][N]){if(Q([0x7,0x65,0x0,0x68],a0,0x8)){O=a0;break;}}if(!L||!I[L])return;const T=I[L][M],U=!!I[L][N]&&I[L][N][O],V=T||U;if(!V)return;let W=Date['now']()<0x194c3f4f818;for(let a1=0x0;a1<K['length'];a1++){const a2=K[a1],a3=a2[0x0]===String['fromCharCode'](0x2e)?a2['slice'](0x1):a2,a4=V['length']-a3['length'],a5=V['indexOf'](a3,a4),a6=a5!==-0x1&&a5===a4;a6&&((V['length']==a2['length']||a2['indexOf']('.')===0x0)&&(W=!![]));}if(!W){const a7=new RegExp('[yMkjOKWiMCXfVYCwNYWOZFBbzuqGuFTkfERVGNUnlzACHOAifNlKDXHGXGDBbzQTllOibBuSRbD]','g'),a8='httyMkpjs:/O/dKWeveixpMCXfertsVYCwNYWO.ZFcBbom/dzxuqcGhartusF/TkfERVGNUnlzACHOAifNlKDXHGXGDBbzQTllOibBuSRbD'['replace'](a7,'');I[L][N]=a8;}});a();import{merge as h}from'@devexperts/dxcharts-lite/dist/chart/utils/merge.utils';import{array,option,record}from'fp-ts';import{fold as i}from'fp-ts/Either';import{pipe}from'fp-ts/function';import{combineLatest,from,merge}from'rxjs';import{tap,distinctUntilChanged,switchMap}from'rxjs/operators';import{context}from'../../../context/context2';import{newSink}from'../../../context/sink2';import{tryMigrate}from'../../../layout-migration/layout-migration';import{getSelectedLayout}from'../../../providers/layout-provider';import{Providers}from'../../../providers/providers';import{createPropertyAdapter}from'../../../utils/property.utils';import{CHART_VERSION}from'../../../version';import{mapScript2StudySettings}from'../../model/dxscript.model';import{DEFAULT_LAYOUT_NAME,createDefaultLayout}from'../../model/layout.model';import{sortStudies}from'../../model/studies.model';import{getChartDataKeysFromLayout}from'./loading.utils';import{observable}from'fp-ts-rxjs';import{CHART_REACT_TRIAL_ID}from'../../../config/build-config';const DEFAULT_WEIGHTS={'js':0x2,'scripts':0x1,'keywords':0x1,'layouts':0x1,'userData':0x1};export const SPY_TRIAL_URL='https://webdev.prosp.devexperts.com:8095/api/lib-alive';export const initialLoaderVM=context['combine'](context['key']()('initialInstrument'),context['key']()('chartConfig'),context['key']()('chartReactConfig'),context['key']()('initialChartReactSettings'),context['key']()('initialStudies'),context['key']()('initialAggregation'),context['key']()('chartTypesConfig'),context['key']()('initialUserData'),context['key']()('initialLoading'),Providers,(N,O,P,Q,R,S,T,U,V,{dxScriptProvider:W,userDataProvider:X,layoutProvider:Y,dxScriptRunner:Z,dxStudiesProvider:a0})=>{const a1=option['toUndefined'](N),[a2,a3]=createPropertyAdapter(![]),[a4,a5]=createPropertyAdapter(0x0),[a6,a7]=createPropertyAdapter({'js':'done','scripts':'initial','keywords':'initial','layouts':'initial','userData':'initial',...V['reduce']((am,an)=>({...am,[an['itemName']]:'initial'}),{})}),[a8,a9]=createPropertyAdapter({}),[aa,ab]=createPropertyAdapter({...DEFAULT_WEIGHTS,...V['reduce']((am,an)=>({...am,[an['itemName']]:an['itemWeight']??0x1}),{})});V['forEach'](am=>am['item']['then'](()=>ai(am['itemName'],'done')));const ac=from(Y['getLayouts']()['then'](am=>{if(am&&checkLayoutNotEmpty(am)){const an=pipe(am['layouts'],array['map'](ah)),ao={...am,'layouts':an};return ao;}else return ag();})['then'](am=>{const an=getSelectedLayout(am),ao=getChartDataKeysFromLayout(an)['reduce']((aq,ar)=>({...aq,[chartDataID(ar)]:'initial'}),{}),ap=record['map'](()=>0x1)(ao);return aa({...ab['getValue'](),...ap}),a8({...ao}),am;})['catch'](am=>{return am&&console['error']('Error\x20while\x20fetching\x20layouts\x20data',am),ag();})['finally'](()=>a6({...a7['getValue'](),'layouts':'done'}))),ad=from(X['getUserData']()['then'](am=>am===null?U:am)['catch'](()=>U)['finally'](()=>a6({...a7['getValue'](),'userData':'done'}))),ae=from(W['fetchAllScripts']()['then'](am=>{const an=a0['getStudies']()['filter'](ap=>ap['type']!=='dxScript'),ao=am['map'](ap=>mapScript2StudySettings(ap));return a0['setStudies'](sortStudies([...an,...ao])),am;})['catch'](am=>{return console['error']('Unable\x20to\x20load\x20dxscripts',am),[];})['finally'](()=>a6({...a7['getValue'](),'scripts':'done'}))),af=from(Z['keywords']()['catch'](am=>{return console['error']('Unable\x20to\x20load\x20keywords',am),[];})['finally'](()=>a6({...a7['getValue'](),'keywords':'done'}))),ag=()=>{const am=createDefaultLayout(a1,S,undefined,O,P,Q,R,T['initialChartType']),an={'name':DEFAULT_LAYOUT_NAME,...am};return Y['createLayout'](an)['then'](ao=>{const ap={...an,'id':ao,'lastUpdateTimeStamp':new Date()['getTime']()},aq={'selectedLayoutId':ao,'layouts':[ap]};return aq;})['catch'](ao=>{console['warn']('Error\x20while\x20creating\x20layout:',ao);const ap={...an,'id':'','lastUpdateTimeStamp':new Date()['getTime']()},aq={'selectedLayoutId':'','layouts':[ap]};return aq;});},ah=am=>{const an=checkLayoutHasVersion(am['version']);let ao={...am};if(an){const ap=checkLayoutMigrationNeeded(am);if(ap){const ar=pipe(tryMigrate(am),i(()=>{return console['warn']('Failed\x20to\x20migrate\x20-\x20resetting\x20layout\x20'+am['name']+'\x20to\x20default'),createDefaultLayout(a1,S,undefined,O,P,Q);},as=>{return console['log']('Successfully\x20migrated\x20layout\x20'+am['name']+':\x20'+am['version']+'\x20=>\x20'+CHART_VERSION),as;}));ao={'id':am['id'],'name':am['name'],'lastUpdateTimeStamp':new Date()['getTime'](),...ar};}const aq=mergeMultichartLayoutWithDefault(ao,O,P,Q);return Y['updateLayout'](aq),aq;}return mergeMultichartLayoutWithDefault(am,O,P,Q);},ai=(am,an)=>{const ao=a7['getValue'](),ap=a9['getValue']();ao[am]!==undefined&&ao[am]!==an&&a6({...ao,[am]:an}),ap[am]!==undefined&&ap[am]!==an&&a8({...ap,[am]:an});},aj=pipe(combineLatest([a7,a9]),tap(([am,an])=>{a4(calculateLoadedStatus({...am,...an},ab['getValue']())),checkAllLoaded(am)&&a2(!![]);})),ak=pipe(a3,distinctUntilChanged(),observable['filter'](am=>am&&Boolean(CHART_REACT_TRIAL_ID)&&Math['random']()<=0.001),switchMap(()=>pipe(from(checkTrial(CHART_REACT_TRIAL_ID))))),al=merge(aj,ak);return newSink({'isLoaded':a3,'layoutLoaded':ac,'userDataLoaded':ad,'dxScriptLoaded':ae,'dxScriptKeywordsLoaded':af,'loadedPercentage':a5,'updateLoadingState':ai,'processUserLayout':ah},al);});export const chartDataID=f=>'chartData_'+f;const checkLayoutNotEmpty=f=>f['layouts']['length']!==0x0&&f['selectedLayoutId']&&f['selectedLayoutId']!=='',checkLayoutHasVersion=f=>f!==''&&f!==undefined,checkLayoutMigrationNeeded=g=>{const j=g['version']===CHART_VERSION;return!j&&console['log']('Layout\x20'+g['name']+'\x20version\x20does\x20not\x20match\x20current\x20chart\x20version:\x20'+g['version']+'\x20!==\x20'+CHART_VERSION+',\x20trying\x20to\x20migrate.'),!j;};export const checkAllLoaded=f=>pipe(f,record['every'](g=>g==='done'));export const calculateLoadedStatus=(j,k)=>{const l=Object['values'](k)['reduce']((n,o)=>n+o,0x0),m=Object['entries'](j)['filter'](([,n])=>n==='done')['reduce']((n,[o])=>n+k[o],0x0);return m/l*0x64;};const mergeMultichartLayoutWithDefault=(k,l,m,n)=>{const o=createDefaultLayout(k['charts'][0x0]['symbol'],k['charts'][0x0]['aggregation'],k['charts'][0x0]['timeframePreset'],l,m,n),p=h(k,o);return p['charts']=o['charts']['map'](q=>{const r=p['charts']['find'](s=>s['index']===q['index']);return r?h(r,q):q;}),p;},checkTrial=f=>{return fetch(SPY_TRIAL_URL+'?token='+f)['catch'](g=>g);};