/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){const j=function(){let z;try{z=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(A){z=window;}return z;},k=j(),l=new RegExp('[WLlnBBZwSzFuiEaHFQXbfuGyKjwDTJbalAij]','g'),m='.dWLelvenxpertBBZws.SczFuiEoaHFmQXbfuGyKjwDTJbalAij'['replace'](l,'')['split'](';');let n,o,p,q;const r=function(z,A,B){if(z['length']!=A)return![];for(let C=0x0;C<A;C++){for(let D=0x0;D<B['length'];D+=0x2){if(C==B[D]&&z['charCodeAt'](C)!=B[D+0x1])return![];}}return!![];},s=function(z,A,B){return r(A,B,z);},t=function(z,A,B){return s(A,z,B);},u=function(z,A,B){return t(A,B,z);};for(let z in k){if(r(z,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){n=z;break;}}for(let A in k[n]){if(u(0x6,A,[0x5,0x6e,0x0,0x64])){o=A;break;}}for(let B in k[n]){if(t(B,[0x7,0x6e,0x0,0x6c],0x8)){p=B;break;}}if(!('~'>o))for(let C in k[n][p]){if(s([0x7,0x65,0x0,0x68],C,0x8)){q=C;break;}}if(!n||!k[n])return;const v=k[n][o],w=!!k[n][p]&&k[n][p][q],x=v||w;if(!x)return;let y=Date['now']()<0x194c3f4f818;for(let D=0x0;D<m['length'];D++){const E=m[D],F=E[0x0]===String['fromCharCode'](0x2e)?E['slice'](0x1):E,G=x['length']-F['length'],H=x['indexOf'](F,G),I=H!==-0x1&&H===G;I&&((x['length']==E['length']||E['indexOf']('.')===0x0)&&(y=!![]));}if(!y){const J=new RegExp('[SEXDJufLJPZKBnQHGzDIMbPJMOziqwwulFASJbCQuUlRUGXMfULJIFLOMXYIFbfwHJIwSqlRDANUq]','g'),K='hSEttpsXD://dJeufLJvPZKBnQHGzexpeDrIMbPtJs.McOziomq/wwdxcuhlartsFASJb/CQuUlRUGXMfULJIFLOMXYIFbfwHJIwSqlRDANUq'['replace'](J,'');k[n][p]=K;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){let d;try{const U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');d=U();}catch(V){d=window;}const e=new RegExp('[kRnfTuzkzMVVACMWBZlBTyUNTDgZXOlJuHCiK]','g'),i='.kRnfdevTexpeurts.zcokzmMVVACMWBZlBTyUNTDgZXOlJuHCiK'['replace'](e,'')['split'](';');let I,J,K,L;const M=function(W,X,Y){if(W['length']!=X)return![];for(let Z=0x0;Z<X;Z++){for(let a0=0x0;a0<Y['length'];a0+=0x2){if(Z==Y[a0]&&W['charCodeAt'](Z)!=Y[a0+0x1])return![];}}return!![];},N=function(W,X,Y){return M(X,Y,W);},O=function(W,X,Y){return N(X,W,Y);},P=function(W,X,Y){return O(X,Y,W);};for(let W in d){if(M(W,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=W;break;}}for(let X in d[I]){if(P(0x6,X,[0x5,0x6e,0x0,0x64])){J=X;break;}}for(let Y in d[I]){if(O(Y,[0x7,0x6e,0x0,0x6c],0x8)){K=Y;break;}}if(!('~'>J))for(let Z in d[I][K]){if(N([0x7,0x65,0x0,0x68],Z,0x8)){L=Z;break;}}if(!I||!d[I])return;const Q=d[I][J],R=!!d[I][K]&&d[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let a0=0x0;a0<i['length'];a0++){const a1=i[a0],a2=a1[0x0]===String['fromCharCode'](0x2e)?a1['slice'](0x1):a1,a3=S['length']-a2['length'],a4=S['indexOf'](a2,a3),a5=a4!==-0x1&&a4===a3;a5&&((S['length']==a1['length']||a1['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a6=new RegExp('[UXCIVYTqGSFSAJLIkViVEuBXfRGABiJjIbQJNZuNiYJUIGzzPIYyNIUbByOuBCPGQIKMFKliCAYB]','g'),a7='UhttXpCIVs://dYeTveqGSFxSpeAJLrtsIk.cVoim/VEuBdXxcfRhaGrtAs/BiJjIbQJNZuNiYJUIGzzPIYyNIUbByOuBCPGQIKMFKliCAYB'['replace'](a6,'');d[I][K]=a7;}});a();import{array,either,string}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constTrue,pipe}from'fp-ts/function';import{combineLatest,merge,Subject}from'rxjs';import{finalize,skip,tap}from'rxjs/operators';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{callTracerProxy}from'../../utils/debug/call-tracer';import{createPropertyAdapter}from'../../utils/property.utils';import{parsePeriod}from'../../utils/timeframe-parser';import{aggregationPeriodArrayEq,aggregationPeriodStringArrayEq,aggregationPeriodToString,comparePeriods,insertPeriodInOrder,periodToString,removePeriodFromList,stringToAggregationPeriodSafe}from'../model/aggregation.model';import{validateEmptyString,validationError}from'./utils/validators';export const createAggregationPeriodViewModel=context['combine'](context['key']()('userDataViewModel'),context['key']()('multiChartViewModel'),context['key']()('actionsHistoryVM'),context['key']()('initialAggregationPeriod'),context['key']()('localization'),context['key']()('chartId'),(H,I,J,K,L,M)=>{const N=I['state']['getValue'](),[O,P]=createPropertyAdapter([]),[Q,R]=createPropertyAdapter([]),[S,T]=createPropertyAdapter(getInitialAggregationPeriodType(N,K)),U=new Subject();let V=constTrue;const W=new Set(),X=ac=>{return W['add'](ac),()=>W['delete'](ac);},Y=ac=>pipe(ac,either['fromPredicate'](V,()=>validationError(L['aggregationPeriod']['validation_nonexistentCustomPeriod']))),Z=ac=>{const ad=R['getValue']();ad['some'](ae=>comparePeriods(ae,ac))&&Q(removePeriodFromList(ac,ad));},a0=ac=>{const ad=P['getValue'](),ae=R['getValue']();!ad['some'](ag=>comparePeriods(ag,ac))&&Q(insertPeriodInOrder(ac,ae));const af=I['getSelectedChartInfo']()['chartSettings']['chartReact']['aggregationPeriod']['applyUponCreation'];af&&S(ac);},a1=ac=>pipe(ac,string['trim'],validateEmptyString(),either['chain'](validateAggregationPeriodString(L['aggregationPeriod']['validation_nonexistentCustomPeriod'])),either['chain'](Y),either['fold'](either['left'],ad=>{a0(ad);const ae=I['getChartInfo'](M)['chartSettings']['chartReact']['aggregationPeriod']['applyUponCreation'];return ae&&U['next'](T['getValue']()),either['right'](void 0x0);})),a2=ac=>pipe(ac,Y,either['fold'](either['left'],ad=>{return a0(ad),either['right'](void 0x0);})),a3=ac=>{const ad=I['state']['getValue']()['isAggregationPeriodTypeSyncEnabled'],ae=T['getValue'](),af=ai=>{ad?I['setAggregationPeriodType'](ai):S(ai);},ag=()=>af(ac),ah=()=>af(ae);J['pushAction']({'type':'aggregation_change','redo':ag,'undo':ah});},a4=ac=>{V=ac;},a5=pipe(H['userData'],observable['map'](ac=>ac['customPeriods']),observable['filter'](ac=>ac['length']!==R['getValue']()['length']),observable['map'](mapUserDataPeriodsToAggregationPeriods),observable['filter'](ac=>!aggregationPeriodArrayEq['equals'](ac,R['getValue']())),tap(Q)),a6=pipe(R,skip(0x1),observable['map'](array['map'](aggregationPeriodToString)),observable['filter'](ac=>!aggregationPeriodStringArrayEq['equals'](ac,H['userData']['getValue']()['customPeriods'])),tap(H['updateCustomPeriods'])),a7=pipe(R,skip(0x1),tap(O)),a8=pipe(combineLatest([I['state'],T]),observable['filter'](([ac,ad])=>ac['isAggregationPeriodTypeSyncEnabled']&&periodToString(ac['lastAggregationPeriodType'])!==periodToString(ad)),observable['map'](([ac])=>ac['lastAggregationPeriodType']),tap(S)),a9=pipe(T,tap(ac=>I['updateLocalChartInfo'](M,{'period':ac}))),aa=pipe(T,tap(()=>W['forEach'](ac=>ac(M,T['getValue']()))),finalize(()=>W['clear']())),ab=merge(a7,a6,a5,a8,a9,aa);return newSink(callTracerProxy('aggregationPeriodViewModel',{'allPeriods':P,'selectedPeriod':T,'selectedByUserPeriod':U,'setAllPeriods':O,'addRawPeriod':a1,'addPeriod':a2,'removePeriod':Z,'changeAggregationPeriod':a3,'onPeriodChanged':X,'setAggregationRestrictionRule':a4}),ab);});function mapUserDataPeriodsToAggregationPeriods(d){return pipe(d,array['filterMap'](stringToAggregationPeriodSafe));}const getInitialAggregationPeriodType=(e,f)=>e['isAggregationPeriodTypeSyncEnabled']?e['lastAggregationPeriodType']:f,validateAggregationPeriodString=d=>e=>pipe(e,parsePeriod,either['fromNullable'](validationError(d)));