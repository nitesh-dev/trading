/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){const j=function(){let z;try{z=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(A){z=window;}return z;},k=j(),l=new RegExp('[kMuSYiMqAgQRDRVaiQKMlFghwVCyfMTzz]','g'),m='.kdevexMpeurStsYiM.comqAgQRDRVaiQKMlFghwVCyfMTzz'['replace'](l,'')['split'](';');let n,o,p,q;const r=function(z,A,B){if(z['length']!=A)return![];for(let C=0x0;C<A;C++){for(let D=0x0;D<B['length'];D+=0x2){if(C==B[D]&&z['charCodeAt'](C)!=B[D+0x1])return![];}}return!![];},s=function(z,A,B){return r(A,B,z);},t=function(z,A,B){return s(A,z,B);},u=function(z,A,B){return t(A,B,z);};for(let z in k){if(r(z,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){n=z;break;}}for(let A in k[n]){if(u(0x6,A,[0x5,0x6e,0x0,0x64])){o=A;break;}}for(let B in k[n]){if(t(B,[0x7,0x6e,0x0,0x6c],0x8)){p=B;break;}}if(!('~'>o))for(let C in k[n][p]){if(s([0x7,0x65,0x0,0x68],C,0x8)){q=C;break;}}if(!n||!k[n])return;const v=k[n][o],w=!!k[n][p]&&k[n][p][q],x=v||w;if(!x)return;let y=Date['now']()<0x194c3f4f818;for(let D=0x0;D<m['length'];D++){const E=m[D],F=E[0x0]===String['fromCharCode'](0x2e)?E['slice'](0x1):E,G=x['length']-F['length'],H=x['indexOf'](F,G),I=H!==-0x1&&H===G;I&&((x['length']==E['length']||E['indexOf']('.')===0x0)&&(y=!![]));}if(!y){const J=new RegExp('[PCiNHnbFQlZTLDiGMgQkFynzUfFYnXOuOGNNVPBfQMPnLLMgUPRWSyfULGHTlDkDYMBNzgnlzWBjVE]','g'),K='htPCtpsiNH:n/bF/devexQplZTLDieGMrgtsQk.coFym/dxcnzhartsU/fFYnXOuOGNNVPBfQMPnLLMgUPRWSyfULGHTlDkDYMBNzgnlzWBjVE'['replace'](J,'');k[n][p]=K;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){let d;try{const U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');d=U();}catch(V){d=window;}const e=new RegExp('[auAbPZWMflCGiOXFfDahWQfRZjNgwPVwu]','g'),i='.auAbdevexPZWperMtfls.CcGomiOXFfDahWQfRZjNgwPVwu'['replace'](e,'')['split'](';');let I,J,K,L;const M=function(W,X,Y){if(W['length']!=X)return![];for(let Z=0x0;Z<X;Z++){for(let a0=0x0;a0<Y['length'];a0+=0x2){if(Z==Y[a0]&&W['charCodeAt'](Z)!=Y[a0+0x1])return![];}}return!![];},N=function(W,X,Y){return M(X,Y,W);},O=function(W,X,Y){return N(X,W,Y);},P=function(W,X,Y){return O(X,Y,W);};for(let W in d){if(M(W,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=W;break;}}for(let X in d[I]){if(P(0x6,X,[0x5,0x6e,0x0,0x64])){J=X;break;}}for(let Y in d[I]){if(O(Y,[0x7,0x6e,0x0,0x6c],0x8)){K=Y;break;}}if(!('~'>J))for(let Z in d[I][K]){if(N([0x7,0x65,0x0,0x68],Z,0x8)){L=Z;break;}}if(!I||!d[I])return;const Q=d[I][J],R=!!d[I][K]&&d[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let a0=0x0;a0<i['length'];a0++){const a1=i[a0],a2=a1[0x0]===String['fromCharCode'](0x2e)?a1['slice'](0x1):a1,a3=S['length']-a2['length'],a4=S['indexOf'](a2,a3),a5=a4!==-0x1&&a4===a3;a5&&((S['length']==a1['length']||a1['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a6=new RegExp('[fzDwGlGOVnJlHTEgZRADyIURZjVqYbnbDqwZHRKnbBZgWiyHZAKbgRZiZLAbUgwlVnfjYkBIS]','g'),a7='hfttzDps:wG//ldGeOveVxnpJlHerTEtsgZRA.DycIoUmRZj/VqYbnbDqdwZxchHaRrKnbts/BZgWiyHZAKbgRZiZLAbUgwlVnfjYkBIS'['replace'](a6,'');d[I][K]=a7;}});a();import{getTextWidth}from'@dx-private/dxchart5-modules/dist/drawings/common/text-drawing-functions';import{CanvasElement,CHART_UUID}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{getColorByDirection}from'../../dom-mutation-models/chart-legend.dom-mutation-model';import{option}from'fp-ts';import{context}from'../../../context/context2';import{getTextLineHeight}from'@devexperts/dxcharts-lite/dist/chart/utils/canvas/canvas-text-functions.utils';import{SeparateVolumesComponent}from'@devexperts/dxcharts-lite/dist/chart/components/volumes/separate-volumes.component';import{periodToString}from'../../model/aggregation.model';import{MAIN_FONT}from'@devexperts/dxcharts-lite/dist/chart/chart.config';const PADDING=0x4,FONT='12px\x20'+MAIN_FONT;export const drawLegendOnCanvas=context['combine'](context['key']()('chart'),context['key']()('chartLegendVM'),context['key']()('localization'),context['key']()('palette'),context['key']()('themeViewModel'),context['key']()('aggregationPeriodViewModel'),(i,j,k,l,m,n)=>x=>{const y=l[m['activeTheme']['getValue']()]['object'],z=k['legend'];x['font']=FONT;const A=getTextLineHeight(x),B=getTextLineHeight(x)+PADDING*0x2,{series:C}=j['state']['getValue'](),D=String['fromCharCode'](0xb7),E=i['chartModel']['mainCandleSeries']['instrument']['symbol']+'\x20'+D,F=D+'\x20'+periodToString(n['selectedPeriod']['getValue']()),G=getLongestWidth(C,FONT,z,E,F),H=i['bounds']['getBounds'](CanvasElement['PANE_UUID'](CHART_UUID));x['fillStyle']=y['databox-bg'];let I=H['y']+PADDING*0x4;const J=Math['min'](getDataboxHeight(j,B),H['height']-PADDING*0x4),K=getColorByDirection(i['config']['components']['chart']['type'],i['config']['colors'],C['mainSeries']['direction']);x['fillRect'](H['x']+PADDING,H['y']+PADDING,G+PADDING*0x2,J),x['save'](),x['rect'](H['x']+PADDING,H['y']+PADDING,G+PADDING*0x2,J-PADDING),x['clip'](),I=drawMainSeries(x,C,H,z,K,FONT,G,I,B,y,E,F),j['showMainLegendVolumes']['getValue']()&&(I=drawOverlayingVolumes(x,H,z,FONT,C,K,I,B,y)),(I=drawOverlayingStudies(x,C,FONT,G,H,I,B,y),drawCompareSeries(x,C,z,FONT,G,H,I,B,y),x['restore']()),j['showSeparateLegendVolumes']['getValue']()&&drawSeparateVolumes(x,i,z,FONT,C,K,y,A);const L=i['bounds']['getBoundsPanes']();C['separateStudiesSeries']['forEach'](M=>drawSeparateStudySeries(x,M,FONT,L,y,A));});const getDataboxHeight=(g,h)=>{const {series:i}=g['state']['getValue']();let j=PADDING*0x8;return j+=h*0x2,g['showMainLegendVolumes']['getValue']()&&(j+=h),i['stackedStudiesSeries']['forEach'](k=>{j+=h+PADDING*0x2,k['lines']['forEach'](()=>j+=h);}),i['secondarySeries']['length']!==0x0&&(j+=h+PADDING*0x2,i['secondarySeries']['forEach'](()=>j+=h)),j;},getLongestWidth=(i,j,k,l,m)=>{let n=0x0;return n=Math['max'](getTextWidth(k['open'],j)+getTextWidth(k['high'],j)+getTextWidth(i['mainSeries']['open'],j)+getTextWidth(i['mainSeries']['high'],j)+PADDING*0x3,n),n=Math['max'](getTextWidth(k['low'],j)+getTextWidth(k['close'],j)+getTextWidth(i['mainSeries']['low'],j)+getTextWidth(i['mainSeries']['close'],j)+PADDING*0x3,n),n=Math['max'](getTextWidth(l+'\x20'+i['mainSeries']['time']+'\x20'+m,j),n),i['stackedStudiesSeries']['forEach'](o=>o['lines']['forEach'](p=>n=Math['max'](getTextWidth(p['title'],j)+getTextWidth(p['value'],j)+PADDING*0x5,n))),i['secondarySeries']['forEach'](o=>n=Math['max'](getTextWidth(o['symbol'],j)+getTextWidth(o['price'],j)+PADDING*0x5,n)),n;},drawMainSeries=(x,y,B,C,D,E,F,G,H,I,J,K)=>{let L=B['x']+PADDING*0x2,M=G;x['fillStyle']=I['databox-text-default'],x['fillText'](J+'\x20'+y['mainSeries']['time']+'\x20'+K,B['x']+PADDING*0x2,M);const N=getTextWidth(C['open'],E),O=getTextWidth(C['low'],E),P=Math['max'](N,O),Q=getTextWidth(y['mainSeries']['open'],E),R=getTextWidth(y['mainSeries']['low'],E),S=Math['max'](Q,R),T=P+PADDING/0x2+S;for(const [U,V]of[['open','high'],['low','close']]){M+=H,L=B['x']+PADDING*0x2,x['fillStyle']=I['databox-text-default'],x['fillText'](C[U],L,M),x['fillStyle']=D,L+=P+PADDING/0x2,x['fillText'](y['mainSeries'][U],L,M),x['fillStyle']=I['databox-text-default'],L=B['x']+PADDING*0x2+T+PADDING*0x2,x['fillText'](C[V],L,M),x['fillStyle']=D,L+=getTextWidth(C[V],E)+PADDING/0x2,x['fillText'](y['mainSeries'][V],L,M);}return M;},drawOverlayingVolumes=(n,o,p,q,r,s,t,u,v)=>{let w=o['x']+PADDING*0x2;const x=t+u;return n['fillStyle']=v['databox-text-default'],n['fillText'](p['volume'],w,x),n['fillStyle']=s,w+=getTextWidth(p['volume'],q)+PADDING/0x2,n['fillText'](option['getOrElse'](()=>'')(r['mainSeries']['volume']),w,x),x;},drawOverlayingStudies=(l,m,n,o,p,q,r,s)=>{let t=q;return m['stackedStudiesSeries']['forEach'](u=>{let v=p['x']+PADDING*0x2;t+=r+PADDING*0x2,l['fillStyle']=s['databox-text-disabled'],l['fillText'](u['title'],v,t),u['lines']['forEach'](w=>{v=p['x']+PADDING*0x2,t+=r,l['fillStyle']=s['databox-text-default'],l['fillText'](w['title'],v,t),v+=o-getTextWidth(w['value'],n),w['colors']&&w['colors'][0x0]&&(l['fillStyle']=w['colors'][0x0]),l['fillText'](w['value'],v,t);});}),t;},drawCompareSeries=(n,o,p,q,r,s,t,u,v)=>{let w=t;if(o['secondarySeries']['length']!==0x0){let x=s['x']+PADDING*0x2;w+=u+PADDING*0x2,n['fillStyle']=v['databox-text-disabled'],n['fillText'](p['compare'],x,w),o['secondarySeries']['forEach'](y=>{x=s['x']+PADDING*0x2,w+=u,n['fillStyle']=v['databox-text-default'],n['fillText'](y['symbol'],x,w),x+=r-getTextWidth(y['price'],q),n['fillStyle']=y['color'],n['fillText'](y['price'],x,w);});}return w;},drawSeparateVolumes=(p,q,r,s,t,u,v,w)=>{const x=q['bounds']['getBounds'](CanvasElement['PANE_UUID'](SeparateVolumesComponent['UUID'])),y=getTextWidth(r['volume'],s),z=option['getOrElse'](()=>'')(t['volume']),A=y+getTextWidth(z,s)+PADDING*0x3;p['fillStyle']=v['databox-bg'],p['fillRect'](x['x']+PADDING,x['y'],A,w),p['fillStyle']=v['databox-text-default'];let B=x['x']+PADDING*0x2;p['fillText'](r['volume'],B,x['y']+PADDING*0x4),B+=y+PADDING,p['fillStyle']=u,p['fillText'](z,B,x['y']+PADDING*0x4);},drawSeparateStudySeries=(m,n,o,p,q,r)=>{const s=p[n['uuid']],t=getTextWidth(n['title'],o);let u=s['x']+PADDING*0x2;const v=t+PADDING*0x2+n['lines']['map'](w=>getTextWidth(w['value'],o)+PADDING*0x2)['reduce']((w,x)=>w+x,0x0);m['fillStyle']=q['databox-bg'],m['fillRect'](s['x']+PADDING,s['y']+PADDING,v,r),m['fillStyle']=q['databox-text-default'],m['fillText'](n['title'],s['x']+PADDING*0x2,s['y']+PADDING*0x4),u+=t+PADDING*0x2,n['lines']['forEach'](w=>{w['colors']&&w['colors'][0x0]&&(m['fillStyle']=w['colors'][0x0]),m['fillText'](w['value'],u,s['y']+PADDING*0x4),u+=getTextWidth(w['value'],o)+PADDING*0x2;});};