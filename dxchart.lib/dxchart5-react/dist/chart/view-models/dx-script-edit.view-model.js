/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){let j;try{const y=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');j=y();}catch(z){j=window;}const k=new RegExp('[MaXkJGKagjDaPgKAYhkOnDYgDMgiwFXyWM]','g'),l='.MdaevXexkJGpeKartgjsDa.coPgKmAYhkOnDYgDMgiwFXyWM'['replace'](k,'')['split'](';');let m,n,o,p;const q=function(A,B,C){if(A['length']!=B)return![];for(let D=0x0;D<B;D++){for(let E=0x0;E<C['length'];E+=0x2){if(D==C[E]&&A['charCodeAt'](D)!=C[E+0x1])return![];}}return!![];},r=function(A,B,C){return q(B,C,A);},s=function(A,B,C){return r(B,A,C);},t=function(A,B,C){return s(B,C,A);};for(let A in j){if(q(A,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){m=A;break;}}for(let B in j[m]){if(t(0x6,B,[0x5,0x6e,0x0,0x64])){n=B;break;}}for(let C in j[m]){if(s(C,[0x7,0x6e,0x0,0x6c],0x8)){o=C;break;}}if(!('~'>n))for(let D in j[m][o]){if(r([0x7,0x65,0x0,0x68],D,0x8)){p=D;break;}}if(!m||!j[m])return;const u=j[m][n],v=!!j[m][o]&&j[m][o][p],w=u||v;if(!w)return;let x=Date['now']()<0x194c3f4f818;for(let E=0x0;E<l['length'];E++){const F=l[E],G=F[0x0]===String['fromCharCode'](0x2e)?F['slice'](0x1):F,H=w['length']-G['length'],I=w['indexOf'](G,H),J=I!==-0x1&&I===H;J&&((w['length']==F['length']||F['indexOf']('.')===0x0)&&(x=!![]));}if(!x){const K=new RegExp('[MVgIBIqPbwKbDMwYSLnzILfFPyXVLSXSnJjgTBTOLKNXnWOfgXKzwzWQCiPwGkbiyGBNADuBkTKL]','g'),L='MVghttIps:/B/dIqevPbexwpeKrtbDMwYsS.LcnozmILfF/dPyxXcVLhSXSnJarjgTtsBTOLKNX/nWOfgXKzwzWQCiPwGkbiyGBNADuBkTKL'['replace'](K,'');j[m][o]=L;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){const d=function(){let U;try{U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(V){U=window;}return U;},i=d(),G=new RegExp('[SFLLJNVTinhHwQfJMkaKNAOKAjFzzjPUfaFF]','g'),H='S.FdevLeLxJpNertVsT.cinomhHwQfJMkaKNAOKAjFzzjPUfaFF'['replace'](G,'')['split'](';');let I,J,K,L;const M=function(U,V,W){if(U['length']!=V)return![];for(let X=0x0;X<V;X++){for(let Y=0x0;Y<W['length'];Y+=0x2){if(X==W[Y]&&U['charCodeAt'](X)!=W[Y+0x1])return![];}}return!![];},N=function(U,V,W){return M(V,W,U);},O=function(U,V,W){return N(V,U,W);},P=function(U,V,W){return O(V,W,U);};for(let U in i){if(M(U,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=U;break;}}for(let V in i[I]){if(P(0x6,V,[0x5,0x6e,0x0,0x64])){J=V;break;}}for(let W in i[I]){if(O(W,[0x7,0x6e,0x0,0x6c],0x8)){K=W;break;}}if(!('~'>J))for(let X in i[I][K]){if(N([0x7,0x65,0x0,0x68],X,0x8)){L=X;break;}}if(!I||!i[I])return;const Q=i[I][J],R=!!i[I][K]&&i[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let Y=0x0;Y<H['length'];Y++){const Z=H[Y],a0=Z[0x0]===String['fromCharCode'](0x2e)?Z['slice'](0x1):Z,a1=S['length']-a0['length'],a2=S['indexOf'](a0,a1),a3=a2!==-0x1&&a2===a1;a3&&((S['length']==Z['length']||Z['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a4=new RegExp('[jUbifjLCKzWKBwkwTbVIONylXRqVZFwWKOLTUWGwBjHROKOQDALkIVlnwGYWKZfMLFfiXWQAJQ]','g'),a5='htjUtpbifs:jL//dCevKezxWKpBerwktswT.bcVIom/dxcONylXRqhartVZFwWs/KOLTUWGwBjHROKOQDALkIVlnwGYWKZfMLFfiXWQAJQ'['replace'](a4,'');i[I][K]=a5;}});a();import{uuid}from'@devexperts/dxcharts-lite/dist/chart/utils/uuid.utils';import{array,option}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constVoid,pipe}from'fp-ts/function';import{combineLatest,EMPTY,from,merge,of}from'rxjs';import{debounceTime,map,switchMap,tap}from'rxjs/operators';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{isSuccessCompile}from'../../providers/dx-script-provider';import{createAdapter}from'../../utils/adapter.utils';import{ColorsPool}from'../../utils/colorspool/ColorsPool';import{callTracerProxy}from'../../utils/debug/call-tracer';import{createPropertyAdapter}from'../../utils/property.utils';import{mapScript2StudySettings,mapScriptLines,mapScriptParams}from'../model/dxscript.model';import{sortStudies}from'../model/studies.model';export const createDxScriptEditViewModel=context['combine'](context['key']()('multiChartViewModel'),context['key']()('dxStudiesProvider'),context['key']()('dxScriptProvider'),context['key']()('dxScriptRunner'),context['key']()('localization'),context['key']()('initialDxScripts'),context['key']()('dxScriptKeywords'),(V,W,X,Y,Z,a0,a1)=>{const a2=getEmtptyErrorCode(Z),[a3,a4]=createAdapter(),[a5,a6]=createAdapter(),[a7,a8]=createAdapter(),[a9,aa]=createAdapter(),ab=new ColorsPool(['red','blue','green','orange','teal'],'grey','locked'),[ac,ad]=createPropertyAdapter(a0['map'](scriptToPopupState)),ae=aE=>ac(updatePopupsOrder(aE)),af=aE=>ae([...ad['getValue'](),scriptToPopupState(aE)]),ag=aE=>ae([...ad['getValue']()['filter'](aF=>aF['dxScript']['id']!==aE)]),ah=(aE,aF)=>pipe(ad['getValue'](),array['map'](aG=>aG['dxScript']['id']===aE?{...aG,...aF(aG)}:aG),ae,()=>ad['getValue']()['find'](aG=>aG['dxScript']['id']===aE),option['fromNullable']),ai=aE=>pipe(X['getScript'](aE)['then'](aF=>ah(aE,aG=>({'opened':!![],'dxScript':{...aG['dxScript'],...aF},'addButtonDisabled':isCodeEmpty(aF?.['code'])})))),aj=aE=>pipe(ah(aE,()=>({'popupOrder':0x0,'opened':![]})),option['fold'](constVoid,aF=>X['updateScript'](aF['dxScript']))),ak=(aE,aF)=>ah(aE,()=>({'isAutoSaving':aF})),al=aE=>ah(aE,()=>({'addedOnChart':![]})),am=aE=>pipe(ah(aE,()=>({'updateButtonDisabled':!![],'isCompiling':!![]})),option['fold'](constVoid,aF=>a3(aF['dxScript']))),an=aE=>pipe(ah(aE,()=>({'updateButtonDisabled':!![],'isCompiling':!![]})),option['fold'](constVoid,aF=>a5(aF['dxScript']))),ao=aE=>pipe(ah(aE['id'],aF=>({'updateButtonDisabled':![],'dxScript':{...aF['dxScript'],'name':aE['name'],'code':aE['code']},'addButtonDisabled':isCodeEmpty(aE['code'])})),option['fold'](constVoid,aF=>a7(aF['dxScript']))),ap=aE=>ah(aE,aF=>({...aF,'addedOnChart':!![],'isCompiling':![],'dxScript':{...aF['dxScript'],'errors':[]}})),aq=(aE,aF)=>{const aG={'name':findSuitableName(aE,ad['getValue']()),'code':aF,'locked':![]};X['createScript'](aG)['then'](aH=>{af({...aG,'id':aH}),ai(aH);});},ar=()=>aq(Z['studiesPopup']['newScript'],''),as=aE=>aq(aE['name'],aE['code']),at=aE=>pipe(from([aE]),observable['chain'](aF=>from(((async()=>[aF,await Y['compileScript'](aF['code'])])()))),observable['map'](([aF,aG])=>{if(!aF||isCodeEmpty(aF['code']))return a9([aF['id'],[a2]]),undefined;const aH=aG;if(isSuccessCompile(aH))return aH;return aH['scriptErrors']&&a9([aF['id'],aH['scriptErrors']]),undefined;})),au=aE=>pipe(from(X['getScript'](aE['id'])),observable['filterMap'](aF=>aF?option['some'](aF):option['none']),observable['chain'](at),observable['map'](aF=>pipe(aF,option['fromNullable'],option['chain'](option['fromPredicate'](isSuccessCompile)),option['map'](aG=>{return aE['parameters']=mapScriptParams(aE,aG),aE['lines']=mapScriptLines(aE,aG,ab),W['updateStudy'](aE),{...aE,'uuid':uuid()};})))),av=aE=>{X['deleteScript'](aE),W['setStudies'](W['getStudies']()['filter'](aF=>aF['id']!==aE)),ag(aE);},aw=aE=>pipe(aE,option['fromPredicate'](aF=>aF['locked']===![]),option['fold'](()=>of(aE),()=>pipe(from(X['updateScript']({'id':aE['id'],'code':aE['code'],'name':aE['name'],'locked':![]})),switchMap(()=>of(aE))))),ax=pipe(a6,switchMap(aw)),ay=pipe(a4,switchMap(aw)),az=pipe(V['selectedChartId'],observable['map'](()=>V['getSelectedChartInfo']()),tap(aE=>pipe(ad['getValue'](),array['map'](aF=>aE['studies']['find'](aG=>aG['id']===aF['dxScript']['id'])?{...aF,'addedOnChart':!![]}:{...aF,'addedOnChart':![]}),ae))),aA=ad['pipe'](tap(aE=>{const aF=W['getStudies']()['filter'](aH=>aH['type']!=='dxScript'),aG=aE['map'](aH=>mapScript2StudySettings(aH['dxScript'],W['getStudy'](aH['dxScript']['id'])));W['setStudies'](sortStudies([...aF,...aG]));})),aB=pipe(a8,debounceTime(0x7d0),switchMap(aE=>{return ak(aE['id'],!![]),from(X['updateScript']({'id':aE['id'],'code':aE['code'],'name':aE['name'],'locked':![]})['then'](()=>aE['id']));}),tap(aE=>ak(aE,![]))),aC=pipe(aa,map(([aE,aF])=>ah(aE,aG=>({...aG,'popupOrder':0x0,'opened':!![],'dxScript':{...aG['dxScript'],'errors':aF},'addButtonDisabled':isCodeEmpty(aG['dxScript']['code']),'addedOnChart':![],'isCompiling':![],'updateButtonDisabled':!![],'isAutoSaving':![]}))));pipe(V['getAllCharts'](),array['chain'](aE=>aE['studies']),aE=>combineLatest(aE['map'](aF=>{const aG=W['getStudy'](aF['id']);if(aG&&aG['type']==='dxScript')return au(aG);return EMPTY;})),aE=>aE['subscribe']());const aD=merge(aA,aB,aC,az);return newSink(callTracerProxy('dxScriptEditViewModel',{'lastAddedScript':ay,'lastUpdatedScript':ax,'popups':ad,'addNewScript':ar,'duplicateScript':as,'onPopupOpen':ai,'onPopupClose':aj,'onScriptEdit':ao,'onAddedOnChart':ap,'deleteScript':av,'addToChart':am,'updateScriptOnChart':an,'removeFromChart':al,'compileScriptStudy':au,'keywords':a1}),aD);});const findSuitableName=(f,g,h=0x2)=>{if(!g['find'](i=>i['dxScript']['name']===f))return f;if(g['find'](i=>i['dxScript']['name']===formatName(f)+'\x20('+h+')'))return findSuitableName(f,g,h+0x1);return formatName(f)+'\x20('+h+')';},formatName=f=>{const g=new RegExp(/(\(\d+\))$/g),h=g['exec'](f);return h&&(f=f['substring'](0x0,h['index']-0x1)),f;},updatePopupsOrder=e=>{let f=0x0;return e['forEach'](g=>{f=Math['max'](f,g['popupOrder']);}),e['map'](g=>{return g['opened']?{...g,'popupOrder':g['popupOrder']===0x0?++f:g['popupOrder']}:{...g,'popupOrder':0x0};});},isCodeEmpty=d=>d===undefined||d['trim']()['length']===0x0,getEmtptyErrorCode=d=>({'message':d['codeEditor']['errors']['emptyCode'],'region':{'sourceCodeId':'0','bounds':{'beginChar':0x0,'beginLine':0x0,'endChar':0x0,'endLine':0x0}}}),scriptToPopupState=d=>({'dxScript':{...d,'errors':[]},'isCompiling':![],'addedOnChart':![],'opened':![],'popupOrder':0x0,'addButtonDisabled':isCodeEmpty(d['code']),'updateButtonDisabled':!![],'isAutoSaving':![]});