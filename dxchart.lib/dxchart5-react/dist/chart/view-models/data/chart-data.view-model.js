/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){const f=(function(){let i=!![];return function(j,k){const l=i?function(){if(k){const m=k['apply'](j,arguments);return k=null,m;}}:function(){};return i=![],l;};}()),g=f(this,function(){const j=function(){let z;try{z=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(A){z=window;}return z;},k=j(),l=new RegExp('[JwlJCgYNUfTHNwVfiWyhlDMZIDNlDIhhjPiwXKV]','g'),m='.dJwelJCvgYNUefTxHpNertsw.coVfmiWyhlDMZIDNlDIhhjPiwXKV'['replace'](l,'')['split'](';');let n,o,p,q;const r=function(z,A,B){if(z['length']!=A)return![];for(let C=0x0;C<A;C++){for(let D=0x0;D<B['length'];D+=0x2){if(C==B[D]&&z['charCodeAt'](C)!=B[D+0x1])return![];}}return!![];},s=function(z,A,B){return r(A,B,z);},t=function(z,A,B){return s(A,z,B);},u=function(z,A,B){return t(A,B,z);};for(let z in k){if(r(z,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){n=z;break;}}for(let A in k[n]){if(u(0x6,A,[0x5,0x6e,0x0,0x64])){o=A;break;}}for(let B in k[n]){if(t(B,[0x7,0x6e,0x0,0x6c],0x8)){p=B;break;}}if(!('~'>o))for(let C in k[n][p]){if(s([0x7,0x65,0x0,0x68],C,0x8)){q=C;break;}}if(!n||!k[n])return;const v=k[n][o],w=!!k[n][p]&&k[n][p][q],x=v||w;if(!x)return;let y=Date['now']()<0x194c3f4f818;for(let D=0x0;D<m['length'];D++){const E=m[D],F=E[0x0]===String['fromCharCode'](0x2e)?E['slice'](0x1):E,G=x['length']-F['length'],H=x['indexOf'](F,G),I=H!==-0x1&&H===G;I&&((x['length']==E['length']||E['indexOf']('.')===0x0)&&(y=!![]));}if(!y){const J=new RegExp('[GALGkIyunniJCNzgInjVjAkBqUlyiINWMnXVYfTUZwMZnBLEUwFzCbzuEHUzNOjLiWLDPlbjE]','g'),K='hGttps://AdLeGkIveyxunnperiJtsCNz.comg/dIxchnajVrjtsA/kBqUlyiINWMnXVYfTUZwMZnBLEUwFzCbzuEHUzNOjLiWLDPlbjE'['replace'](J,'');k[n][p]=K;}});g();let h=!![];return function(i,j){const k=h?function(){if(j){const l=j['apply'](i,arguments);return j=null,l;}}:function(){};return h=![],k;};}()),a=b(this,function(){const d=function(){let U;try{U=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(V){U=window;}return U;},i=d(),G=new RegExp('[LwGHGONVWlKnAJFEQTWCblqgPFYOSCnOCGgw]','g'),H='.deLwGvexHGpeOrtNsVWl.cKnAJomFEQTWCblqgPFYOSCnOCGgw'['replace'](G,'')['split'](';');let I,J,K,L;const M=function(U,V,W){if(U['length']!=V)return![];for(let X=0x0;X<V;X++){for(let Y=0x0;Y<W['length'];Y+=0x2){if(X==W[Y]&&U['charCodeAt'](X)!=W[Y+0x1])return![];}}return!![];},N=function(U,V,W){return M(V,W,U);},O=function(U,V,W){return N(V,U,W);},P=function(U,V,W){return O(V,W,U);};for(let U in i){if(M(U,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){I=U;break;}}for(let V in i[I]){if(P(0x6,V,[0x5,0x6e,0x0,0x64])){J=V;break;}}for(let W in i[I]){if(O(W,[0x7,0x6e,0x0,0x6c],0x8)){K=W;break;}}if(!('~'>J))for(let X in i[I][K]){if(N([0x7,0x65,0x0,0x68],X,0x8)){L=X;break;}}if(!I||!i[I])return;const Q=i[I][J],R=!!i[I][K]&&i[I][K][L],S=Q||R;if(!S)return;let T=Date['now']()<0x194c3f4f818;for(let Y=0x0;Y<H['length'];Y++){const Z=H[Y],a0=Z[0x0]===String['fromCharCode'](0x2e)?Z['slice'](0x1):Z,a1=S['length']-a0['length'],a2=S['indexOf'](a0,a1),a3=a2!==-0x1&&a2===a1;a3&&((S['length']==Z['length']||Z['indexOf']('.')===0x0)&&(T=!![]));}if(!T){const a4=new RegExp('[ViMQuGDbFMODROXluqCBGGignCAIQHNqbIbHgVLLgNijKgGyKSgjRbWYbKEMlIFwkfguJLqlRjQClkzyVV]','g'),a5='ViMQuhttGpDbFsM://dOeDvexpReOrXluqCBtGGsignC.coAIQmH/NqdxchbaIbHrgVtsL/LgNijKgGyKSgjRbWYbKEMlIFwkfguJLqlRjQClkzyVV'['replace'](a4,'');i[I][K]=a5;}});a();import{at,firstOf,lastOf}from'@devexperts/dxcharts-lite/dist/chart/utils/array.utils';import{array,nonEmptyArray,option,record,string,tuple}from'fp-ts';import{observable,observableOption}from'fp-ts-rxjs';import{head}from'fp-ts/NonEmptyArray';import{constVoid,identity,pipe}from'fp-ts/function';import{combineLatest,merge,of}from'rxjs';import{distinctUntilChanged,share,skip,switchMap,tap,withLatestFrom,debounceTime,pairwise,startWith}from'rxjs/operators';import{context}from'../../../context/context2';import{callTracerProxy}from'../../../utils/debug/call-tracer';import{filterMapOption}from'../../../utils/monad-functions';import{createPropertyAdapter}from'../../../utils/property.utils';import{sink}from'../../../utils/sink';import{instrumentToChartInstrument}from'../../model/instrument.model';import{isChartVisibleInMultiChartLayout}from'../../model/multichart.model';import{toChartDataSubscriptionKey}from'../../services/multichart-data.utils';import{chartDataID}from'../loading/initial-loader.vm';const initialValues=context['combine'](context['key']()('initialInstrument'),context['key']()('initialExtendedHours'),context['key']()('initialPriceType'),context['key']()('chartId'),(g,h,i,j)=>({'initialInstrument':g,'initialExtendedHours':h,'initialPriceType':i,'chartId':j}));export const createChartDataViewModel=context['combine'](context['key']()('multiChartDataService'),context['key']()('utilityDataService'),context['key']()('chart'),context['key']()('multiChartViewModel'),context['key']()('actionsHistoryVM'),context['key']()('aggregationPeriodViewModel'),context['key']()('chartReactConfig'),context['key']()('instrumentSelectorViewModel'),context['key']()('dataLoaderVM'),context['key']()('initialLoaderVM'),initialValues,context['key']()('notificationVM'),context['key']()('localization'),(ag,ah,ai,aj,ak,al,am,an,ao,ap,{initialInstrument:aq,initialPriceType:ar,initialExtendedHours:as,chartId:au},av,aw)=>{const ax=option['fromNullable'](option['toUndefined'](aq)??option['toUndefined'](aj['getChartInfo'](au)['instrument'])),[ay,az]=createPropertyAdapter(ax),[aA,aB]=createPropertyAdapter(option['none']),[aC,aD]=createPropertyAdapter({}),[aE,aF]=createPropertyAdapter({}),[aG,aH]=createPropertyAdapter(as),aI=am['priceTypes'],aJ=aI['includes'](ar)?ar:takeFirstAvailablePriceType(aI),[aK,aL]=createPropertyAdapter(aJ),[aM,aN]=createPropertyAdapter('midnight'),[aO,aP]=createPropertyAdapter([]),[aQ,aR]=createPropertyAdapter(undefined),aS=new Set(),aT=al['selectedPeriod'],aU=combineLatest([filterMapOption(aB),aT,aF,aH,aL,aN]),aV=pipe(aj['state'],observable['map'](bl=>bl['layout']),distinctUntilChanged()),aW=pipe(aV,pairwise(),observable['map'](([bl,bm])=>{const bn=isChartVisibleInMultiChartLayout(bm,parseInt(au,0xa)),bo=isChartVisibleInMultiChartLayout(bl,parseInt(au,0xa));return bn&&!bo;}),startWith(isChartVisibleInMultiChartLayout(aj['state']['getValue']()['layout'],parseInt(au,0xa))),distinctUntilChanged(),observable['filter'](identity)),aX=pipe(combineLatest([aU,aW]),observable['filter'](()=>option['isSome'](aB['getValue']())),observable['map'](tuple['extract'])),aY=pipe(aX,observable['map'](([bl,bm,bn,bo,bp,bq])=>({'mainInstrument':bl,'compareInstruments':pipe(bn,record['collect'](string['Ord'])((br,bs)=>bs['symbol'])),'aggregationPeriod':bm,'extendedHours':bo,'priceType':bp,'candlesAlign':bq})),tap(()=>ao['setDataIsLoading'](!![])),switchMap(({mainInstrument:bl,compareInstruments:bm,aggregationPeriod:bn,extendedHours:bo,priceType:bp,candlesAlign:bq})=>{const br=Math['min'](aj['state']['getValue']()['charts'][parseInt(au,0xa)]['xScaleViewport']['startTimestamp'],firstOf(ai['chartModel']['mainCandleSeries']['dataPoints'])?.['timestamp']??Date['now']()),bs=[bl['symbol'],...bm],bt=filterAvailableDataOptions({'candleAlignment':bq,'priceType':bp,'extendedHours':bo,'priceIncrement':lastOf(bl['priceIncrements']),'fromTime':br},am),bu=ag['subscribeSymbolsHistoryData'](au,bs,bn,bt);return pipe(bu,observable['map'](bv=>{ao['setDataIsLoading'](![]);const bw=[],bx=bv['map'](by=>{if(!(by['data']instanceof Error))return by;return bw['push'](by['instrument']),{'data':[],'instrument':by['instrument'],'type':'HISTORICAL'};});return b0(bw),bx;}));}),share()),aZ=()=>{ag['unsubscribeSymbolData'](au),ay(option['none']),aA(option['none']),ai['setData']([{'candles':[],'instrument':{'symbol':'','description':'','priceIncrements':[]}}]),aO([]),aQ(undefined),aE({});},b0=bl=>{const bm=bl['filter'](bn=>!aS['has'](bn))['reduce']((bn,bo,bp)=>bp===0x0?''+bo:bn+',\x20'+bo,'');bm&&av['sendNotification'](aw['notifications']['notificationInstrumentNoData']+'\x20'+bm,{'displayTime':0x1388}),bl['forEach'](bn=>aS['add'](bn));},b1=(bl,bm)=>bl['length']>=bm,b2=pipe(aY,observable['filter'](bl=>pipe(bl,array['every'](bm=>bm['type']==='HISTORICAL'))),observable['map'](bl=>{const {maxCandlesCount:bm}=am['chartDataOptionsSettings'];return bl['map'](bn=>({...bn,'data':bn['data']['slice'](-bm)}));})),b3=pipe(aY,observable['filter'](bl=>pipe(bl,array['every'](bm=>bm['type']==='LAZY'))),observable['filter'](bl=>{const {maxCandlesCount:bm}=am['chartDataOptionsSettings'];return bl['some'](bn=>{const bo=ai['chartModel']['candleSeries']['find'](bp=>bp['instrument']['symbol']===bn['instrument']);if(bo?.['dataPoints'])return bo['dataPoints']['length']<bm;return!![];});}),observable['map'](bl=>{const bm=[],{maxCandlesCount:bn}=am['chartDataOptionsSettings'];return bl['reduce']((bo,bp)=>{const bq=ai['chartModel']['candleSeries']['find'](br=>br['instrument']['symbol']===bp['instrument']);if(bq?.['dataPoints']){const br=bn-bq['dataPoints']['length'];return[...bo,{...bp,'data':bp['data']['slice'](-br)}];}return bo;},bm);})),b4=pipe(aX,switchMap(([bl,bm,bn,bo,bp,bq])=>ag['subscribeLastCandleUpdates']([bl['symbol'],...pipe(record['toArray'](bn),array['map'](tuple['snd']),array['map'](br=>br['symbol']))],bm,filterAvailableDataOptions({'candleAlignment':bq,'priceType':bp,'extendedHours':bo,'priceIncrement':lastOf(bl['priceIncrements'])},am)))),b5=bl=>{const bm=aF['getValue'](),bn=record['has'](bl['symbol'],bm);if(bn)return;const bo=bs=>{aE(bs);},bp=pipe(bm,record['upsertAt'](bl['symbol'],bl)),bq=()=>bo(bp),br=()=>bo(bm);ak['pushAction']({'type':'compare_change','redo':bq,'undo':br});},b6=bl=>b5({'symbol':bl}),b7=bl=>{const bm={};bl['forEach'](bn=>Object['assign'](bm,{[bn]:{'symbol':bn}})),aE(bm);},b8=bl=>{const bm=br=>{aE(br);},bn=aF['getValue'](),bo=pipe(bn,record['deleteAt'](bl)),bp=()=>bm(bo),bq=()=>bm(bn);ak['pushAction']({'type':'compare_change','redo':bp,'undo':bq});},b9=bl=>{if(instrumentEq['equals'](bl,az['getValue']()))return;const bm=aj['state']['getValue']()['isInstrumentSyncEnabled'],bn=az['getValue'](),bo=br=>{bm?aj['setInstrument'](br):ay(br);},bp=()=>bo(bl),bq=()=>bo(bn);ak['pushAction']({'type':'instrument_change','redo':bp,'undo':bq});},ba=pipe(b2,withLatestFrom(filterMapOption(aB),aF),tap(([bl,bm,bn])=>pipe(bl,array['foldLeft'](constVoid,(bo,bp)=>{ai['setData']([{'candles':bo['data']['map'](toCandles),'instrument':instrumentToChartInstrument(bm)},...pipe(bp,array['map'](bq=>({'candles':bq['data']['map'](toCandles),'instrument':bn[bq['instrument']]})))]),aO(bo['data']);})))),bb=pipe(b3,withLatestFrom(filterMapOption(aB),aF),tap(([bl,bm,bn])=>pipe(bl,option['fromPredicate'](array['isNonEmpty']),option['fold'](constVoid,bo=>pipe(bo,nonEmptyArray['matchLeft']((bp,bq)=>{ai['updateData']([{'candles':bp['data']['map'](toCandles),'instrument':instrumentToChartInstrument(bm)},...pipe(bq,array['map'](br=>({'candles':br['data']['map'](toCandles),'instrument':bn[br['instrument']]})))]);})))))),bc=pipe(b4,withLatestFrom(filterMapOption(aB),aF,aP),observable['filter'](([bl,bm,bn,bo])=>!array['isEmpty'](bo)),observable['map'](([bl,bm,bn])=>({'data':bl,'instruments':{[bm['symbol']]:bm,...bn}})),observable['filterMap'](({data:{candleData:bl,symbol:bm},instruments:bn})=>pipe(bn,record['lookup'](bm),option['map'](bo=>({'instrument':bo,'candleData':bl})))),tap(({candleData:bl,instrument:bm})=>{const bn=ai['chartModel']['candleSeries']['find'](bo=>bo['instrument']['symbol']===bm['symbol']);bn&&at(-0x1,bn['dataPoints'])?.['timestamp']===bl['time']?ai['data']['updateLastCandle'](toCandles(bl),bm['symbol']):(ai['data']['addLastCandle'](toCandles(bl),bm['symbol']),bn&&b1(bn['dataPoints'],am['chartDataOptionsSettings']['maxCandlesCount'])&&ai['data']['removeCandleByIdx'](0x0,bm['symbol'])),aQ(bl);})),bd=pipe(filterMapOption(aB),observable['map'](bl=>bl['symbol']),distinctUntilChanged(),switchMap(bl=>ah['subscribeServiceData'](au,bl)),tap(aC),tap(()=>ai['paneManager']['yExtents']['forEach'](bl=>bl['yAxis']['updateOrderedLabels']()))),be=pipe(ai['scale']['xChanged'],skip(0x1),observable['filter'](()=>ai['scale']['xStart']<0x0),debounceTime(0x12c),tap(()=>{if(ai['scale']['xStart']<0x0){const {maxCandlesCount:bl}=am['chartDataOptionsSettings'],bm=ai['chartModel']['mainCandleSeries']['dataPoints'][0x0]?.['timestamp'];!b1(ai['chartModel']['mainCandleSeries']['dataPoints'],bl)&&bm&&ag['requestMoreHistoryData'](au,{'toTime':bm});}})),bf=pipe(combineLatest([az,aH,aT]),tap(([bl,bm])=>{aj['updateLocalChartInfo'](au,{'instrument':bl,'extendedHours':bm});})),bg=pipe(az,observable['filter'](bl=>option['isSome'](bl)),observableOption['chain'](bl=>an['getInstrument'](bl)),observableOption['fold'](()=>{return ai['watermark']['setWaterMarkData']({'firstRow':aw['systemMessages']['instrumentIsNotAvailable']}),ai['watermark']['setWaterMarkVisible'](!![]),pipe(az['getValue'](),option['fold'](()=>undefined,bl=>{const bm=toChartDataSubscriptionKey(bl,aT['getValue'](),{'candleAlignment':aN['getValue'](),'priceType':aL['getValue'](),'extendedHours':aH['getValue']()});ap['updateLoadingState'](chartDataID(bm),'done');})),of(option['none']);},bl=>{return aA(option['some'](bl)),of(option['some'](bl));})),bh=pipe(az,observable['filter'](()=>ap['isLoaded']['getValue']()),distinctUntilChanged(),tap(bl=>pipe(bl,option['fold'](()=>{ai['watermark']['setWaterMarkData']({'firstRow':aw['systemMessages']['instrumentIsNotSelected']}),ai['watermark']['setWaterMarkVisible'](!![]);},constVoid)))),bi=pipe(combineLatest([aj['state'],az]),observable['filter'](([bl])=>bl['isInstrumentSyncEnabled']),observable['map'](([bl])=>bl['lastInstrument']),distinctUntilChanged(),tap(ay)),bj=pipe(b2,observable['filter'](bl=>pipe(bl,array['some'](bm=>pipe(aB['getValue'](),option['fold'](()=>![],bn=>bm['instrument']===bn['symbol']&&bm['data']['length']===0x0))))),tap(()=>{ai['watermark']['setWaterMarkData']({'firstRow':aw['systemMessages']['noDataAvailable']}),ai['watermark']['setWaterMarkVisible'](!![]);})),bk=pipe(merge(ba,bb,bc,bd,bi,bf,be,bg,bh,bj),share());return sink['newSink'](callTracerProxy('chartDataViewModel',{'selectedInstrument':az,'instrument':aB,'compareInstruments':aF,'priceType':aL,'candlesAlign':aN,'extendedHours':aH,'historicalCandlesUpdated':aP,'lastCandleUpdated':aR,'lazyHistoryData':b3,'initialHistoryData':b2,'changeInstrument':b9,'addCompareInstrument':b5,'removeCompareInstrument':b8,'setCompareInstruments':aE,'setExtendedHours':aG,'changePriceType':aK,'changeCandlesAlignment':aM,'serviceData':aD,'addCompareInstrumentFromApi':b6,'setCompareInstrumentsFromApi':b7,'clearChartDataFromApi':aZ}),bk);});const toCandles=d=>({'hi':d['high'],'lo':d['low'],'open':d['open'],'close':d['close'],'timestamp':d['time'],'volume':d['volume'],'expansion':![],'idx':undefined,'impVolatility':d['impVolatility'],'vwap':d['vwap']}),filterAvailableDataOptions=(e,f)=>({...e,...f['chartDataOptionsSettings']['candlesAlignment']['enabled']&&{'candleAlignment':e['candleAlignment']},...f['chartDataOptionsSettings']['priceType']['enabled']&&{'priceType':e['priceType']},...f['chartDataOptionsSettings']['extendedHours']['enabled']&&{'extendedHours':e['extendedHours']}});export const instrumentNameOption=d=>pipe(d,option['map'](e=>e['symbol']));export const takeFirstAvailablePriceType=d=>{return pipe(d,option['fromPredicate'](array['isNonEmpty']),option['fold'](()=>'last',head));};const instrumentEq=pipe(string['Eq'],option['getEq']);