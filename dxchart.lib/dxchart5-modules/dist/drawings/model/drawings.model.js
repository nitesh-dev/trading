/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let c=!![];return function(d,e){const f=c?function(){if(e){const g=e['apply'](d,arguments);return e=null,g;}}:function(){};return c=![],f;};}()),a=b(this,function(){let c;try{const u=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');c=u();}catch(v){c=window;}const f=new RegExp('[CZJEUIVEzkRlgyjNYbaBRuuSRKwTAEKJWMiRN]','g'),g='.dCZJevexEpUIVEerts.zkRcomlgyjNYbaBRuuSRKwTAEKJWMiRN'['replace'](f,'')['split'](';');let h,j,k,l;const m=function(w,x,y){if(w['length']!=x)return![];for(let z=0x0;z<x;z++){for(let A=0x0;A<y['length'];A+=0x2){if(z==y[A]&&w['charCodeAt'](z)!=y[A+0x1])return![];}}return!![];},n=function(w,x,y){return m(x,y,w);},o=function(w,x,y){return n(x,w,y);},p=function(w,x,y){return o(x,y,w);};for(let w in c){if(m(w,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){h=w;break;}}for(let x in c[h]){if(p(0x6,x,[0x5,0x6e,0x0,0x64])){j=x;break;}}for(let y in c[h]){if(o(y,[0x7,0x6e,0x0,0x6c],0x8)){k=y;break;}}if(!('~'>j))for(let z in c[h][k]){if(n([0x7,0x65,0x0,0x68],z,0x8)){l=z;break;}}if(!h||!c[h])return;const q=c[h][j],r=!!c[h][k]&&c[h][k][l],s=q||r;if(!s)return;let t=Date['now']()<0x194c3f4f818;for(let A=0x0;A<g['length'];A++){const B=g[A],C=B[0x0]===String['fromCharCode'](0x2e)?B['slice'](0x1):B,D=s['length']-C['length'],E=s['indexOf'](C,D),F=E!==-0x1&&E===D;F&&((s['length']==B['length']||B['indexOf']('.')===0x0)&&(t=!![]));}if(!t){const G=new RegExp('[PCuEILXnHYRNXFHwZOWJPWjUKWQlHJCHGiXRLQCFjAqIzZuKSTWbNKqiBbRAJDSZkwf]','g'),H='PCuhttEILpsXn://deHvYRNexperXFtsH.wZOcWJPom/dWjxUcKWQharts/lHJCHGiXRLQCFjAqIzZuKSTWbNKqiBbRAJDSZkwf'['replace'](G,'');c[h][k]=H;}});a();import{CHART_UUID,limitYToBounds}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{HIT_TEST_ID_RANGE}from'@devexperts/dxcharts-lite/dist/chart/model/hit-test-canvas.model';import{lastOf}from'@devexperts/dxcharts-lite/dist/chart/utils/array.utils';import{cloneUnsafe}from'@devexperts/dxcharts-lite/dist/chart/utils/object.utils';import{PriceIncrementsUtils}from'@devexperts/dxcharts-lite/dist/chart/utils/price-increments.utils';import{BehaviorSubject,merge,Observable,Subject}from'rxjs';import{distinctUntilChanged,map,share}from'rxjs/operators';import{DrawingsEventListeners}from'../components/DrawingsEventListeners';import{getDefaultCursorsForDrawing}from'../drawings.config';import{removeElementsByProp}from'../utils/utils';import{DrawingModel}from'./drawing.model';import{DrawingViewModel,inRectangle,pointMatches}from'./drawing.view-model';import{cacheIndexes,transformToView}from'./model';import{IndexValuePoint,PointEvent}from'./point-event';import{uuid}from'@devexperts/dxcharts-lite/dist/chart/utils/uuid.utils';import{ChartBaseElement}from'@devexperts/dxcharts-lite/dist/chart/model/chart-base-element';export default class DrawingsModel extends ChartBaseElement{get['instrumentCode'](){return this['chartModel']['mainCandleSeries']['instrument']['symbol'];}get['currentModels'](){const c=this['instrumentCode'];return this['models'][c]===undefined&&(this['models'][c]=[]),this['models'][c];}set['activeModel'](c){this['_activeModel']=c,this['manageDrawingEventListeners']();}set['hoveredModel'](c){this['_hoveredModel']=c,this['manageDrawingEventListeners']();}get['hoveredModel'](){return this['_hoveredModel'];}get['activeModel'](){return this['_activeModel'];}constructor(c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q;super(),this['eventBus']=c,this['staticCanvas']=d,this['hitTestCanvasModel']=e,this['chartConfig']=f,this['chartModel']=g,this['canvasBoundsContainer']=h,this['chartBootstrap']=j,this['drawingsFormatterProvider']=k,this['canvases']=l,this['chartPanComponent']=m,this['paneComponent']=n,this['cursorHandler']=o,this['paneComponents']=p,this['visible']=!![],this['models']={},this['viewModels']={},this['allIds']=[],this['_activeModel']=null,this['_hoveredModel']=null,this['isDrawingMoved']=![],this['contextState']='HIGHLIGHTING',this['candleMagnetPointsByChartTypeMap']={},this['events']={'drawingMoved':new Subject(),'drawingRemoved':new Subject(),'drawingsUpdated':new Observable(),'_drawingsUpdatedOld':new Subject(),'drawingDblClick':new Subject(),'drawingSelected':new BehaviorSubject(null),'drawingModified':new Subject(),'drawingStarted':new Subject(),'drawingFinished':new Subject()},this['drawingsHtIdCounter']=HIT_TEST_ID_RANGE['DRAWINGS'][0x0],this['getNewHitTestId']=()=>{return this['drawingsHtIdCounter']++;},this['removeModels']=r=>{var s;this['_activeMatch']=undefined;if(this['activeModel'])for(const t of r){if(this['sameModels'](t,this['activeModel'])){this['setActiveModel'](null);break;}}Object['values'](this['models'])['forEach'](u=>removeElementsByProp(u,r,'id')),r['forEach'](u=>{this['viewModels'][u['id']]&&delete this['viewModels'][u['id']];}),this['updateViewModels'](),(r['length']!==0x1||!((s=r[0x0])===null||s===void 0x0?void 0x0:s['isAdding']()))&&this['events']['_drawingsUpdatedOld']['next'](),this['fireModelsRemoved'](r),this['redraw']();},this['setActiveModel']=r=>{this['activeModel']&&(this['activeModel']['active']=![]),r&&(r['active']=!![]),this['activeModel']=r,this['activeModel']&&this['updateViewModel'](this['activeModel']),r===null&&(this['_activeMatch']=undefined,this['hoveredModel']=null),this['events']['drawingSelected']['getValue']()!==r&&(this['events']['drawingSelected']['next'](r),this['redraw']());},this['cancelDrawing']=()=>{var r;if(this['contextState']==='ADDING'||this['contextState']==='MOVING'){const s=this['activeModel'];let t=!![];((r=s===null||s===void 0x0?void 0x0:s['figure'])===null||r===void 0x0?void 0x0:r['beforeCancel'])&&(t=s['figure']['beforeCancel'](s,this)),s&&s['fixedPoints']<s['figure']['points']&&this['contextState']==='ADDING'&&(this['removeModels']([s]),this['setActiveModel'](null)),t&&(this['contextState']==='MOVING'&&this['activeModel']&&this['fireModelModified'](),this['setActiveModel'](null),this['switchContext']('HIGHLIGHTING')),this['events']['drawingSelected']['next'](null);}},this['eventListeners']=new DrawingsEventListeners(this,i,h),this['eventListeners']['enableUserControls'](),this['addChildEntity'](this['eventListeners']),this['magnet']=(q=this['chartConfig']['components']['drawings']['magnet'])!==null&&q!==void 0x0?q:0x0,this['switchContext']('HIGHLIGHTING'),this['events']['drawingsUpdated']=merge(this['events']['_drawingsUpdatedOld'])['pipe'](map(()=>{var r;const s=this['chartModel']['mainCandleSeries']['instrument'];return(r=this['models'][s['symbol']])!==null&&r!==void 0x0?r:[];}),share()),this['registerDefaultMagnetPointsResolvers']();}['doActivate'](){this['addRxSubscription'](this['chartModel']['scale']['scaleInversedSubject']['subscribe'](()=>{this['updateViewModels']();})),this['addRxSubscription'](this['chartModel']['mainInstrumentChangedSubject']['subscribe'](()=>{this['cancelDrawing'](),this['initModels']();})),this['addRxSubscription'](merge(this['chartModel']['candlesSetSubject'],this['chartModel']['candlesUpdatedSubject']['pipe'](map(()=>this['chartModel']['getCandlesCount']()),distinctUntilChanged()))['subscribe'](()=>this['rebuildModelsIndexes']())),this['addRxSubscription'](this['chartModel']['scale']['changed']['subscribe'](()=>{this['handleDataUpdates']();})),this['addRxSubscription'](this['canvasBoundsContainer']['observeAnyBoundsChanged']()['subscribe'](()=>this['updateViewModels']()));}['registerDefaultMagnetPointsResolvers'](){this['registerCandleMagnetPointsResolver']('area',closePriceResolver),this['registerCandleMagnetPointsResolver']('histogram',closePriceResolver),this['registerCandleMagnetPointsResolver']('scatterPlot',closePriceResolver),this['registerCandleMagnetPointsResolver']('baseline',closePriceResolver),this['registerCandleMagnetPointsResolver']('line',closePriceResolver),this['registerCandleMagnetPointsResolver']('bar',ohlcPriceResolver),this['registerCandleMagnetPointsResolver']('candle',ohlcPriceResolver),this['registerCandleMagnetPointsResolver']('hollow',ohlcPriceResolver),this['registerCandleMagnetPointsResolver']('trend',ohlcPriceResolver);}['resolveDrawingCursorType'](c){const d=this['chartConfig']['components']['drawings']['cursors']['find'](e=>e['type']===c);return d?d:getDefaultCursorsForDrawing(c);}['manageDrawingEventListeners'](){this['_activeModel']!==null||this['_hoveredModel']!==null?this['eventListeners']['enableUserControls']():this['eventListeners']['disableUserControls']();}['nextId'](){return uuid();}['initModels'](c=null){this['switchContext']('HIGHLIGHTING'),this['viewModels']={},this['updateViewModels'](),this['rebuildModelsIndexes'](),c&&this['setActiveModel'](c);}['startModel'](c){const d=new DrawingModel(c['id'],this['getNewHitTestId'](),c['type'],c['keyPoints'],c['properties'],c['visible'],c['locked'],c['synced'],undefined,this['drawingsFormatterProvider']);return this['setActiveModel'](d),this['currentModels']['push'](d),this['switchContext']('ADDING'),this['events']['drawingStarted']['next'](d),d;}['createOrMergeModel'](c,d=this['instrumentCode']){var e,f,g,h;c['paneId']=(e=c['paneId'])!==null&&e!==void 0x0?e:CHART_UUID;let i=d===this['instrumentCode']?(f=this['viewModels'][c['id']])===null||f===void 0x0?void 0x0:f['model']:(g=this['models'][d])===null||g===void 0x0?void 0x0:g['find'](j=>j['id']===c['id']);if(!i){i=new DrawingModel(c['id'],this['getNewHitTestId'](),c['type'],c['keyPoints'],c['properties'],c['visible'],c['locked'],c['synced'],undefined,this['drawingsFormatterProvider']),i['paneId']=c['paneId'];const j=(h=this['models'][d])!==null&&h!==void 0x0?h:[];j['push'](i),this['models'][d]=j;}else i['mergeModel'](c);if(!i['getPane']&&i['paneId']&&this['paneComponents'][i['paneId']]){const k=this['paneComponents'][i['paneId']];i['getPane']=()=>k;}return i;}['setActiveDrawing'](c){if(c===null){this['setActiveModel'](c);return;}const d=this['createOrMergeModel'](c);this['cachePoints'](d),this['setActiveModel'](d),this['updateViewModel'](d),this['redraw']();}['redraw'](){this['canvases']['dynamicObjectsCanvasModel']['fireDraw']();}['fireModelDone'](c){this['events']['drawingFinished']['next'](c);}['fireModelsRemoved'](c){this['events']['drawingRemoved']['next'](c);}['fireModelMoved'](){this['activeModel']&&this['events']['drawingMoved']['next'](this['activeModel']);}['fireModelModified'](){this['activeModel']&&this['events']['drawingModified']['next'](this['activeModel']);}['fireModelUpdated'](c){c&&this['events']['drawingModified']['next'](c);}['exportFigures'](){const c={};for(const d of Object['keys'](this['models'])){d&&(c[d]=this['models'][d]['map'](e=>{var f;return{'id':e['id'],'type':e['type'],'visible':e['visible'],'locked':e['locked'],'keyPoints':cloneUnsafe(e['keyPoints']),'properties':cloneUnsafe(e['properties']),'synced':e['synced'],'data':(f=e['figure'])===null||f===void 0x0?void 0x0:f['data'],'_internalDrawing':e};}));}return c;}['updateViewModel'](c){if(c){!this['viewModels'][c['id']]&&(this['cachePoints'](c),this['viewModels'][c['id']]=new DrawingViewModel(c,this['chartConfig']));const d=this['viewModels'][c['id']];d['update'](this,![]);}}['cachePoints'](c){var d;c&&(c['cachedPoints']=((d=c['keyPoints'])!==null&&d!==void 0x0?d:[])['map'](e=>cacheIndexes(e,c,this['chartModel'])));}['registerCandleMagnetPointsResolver'](c,d){this['candleMagnetPointsByChartTypeMap'][c]=d;}['candleMagnetPointsByChartType'](c,d){const e=this['candleMagnetPointsByChartTypeMap'][c];if(e!==undefined)return e(d);return closePriceResolver(d);}['adjustByCandle'](c,d){var e,f,g,h,i;if(((e=this['chartConfig']['components']['drawings']['magnet'])!==null&&e!==void 0x0?e:0x0)<=0x0)return![];const j=(h=(g=(f=this['chartConfig']['components'])===null||f===void 0x0?void 0x0:f['chart'])===null||g===void 0x0?void 0x0:g['type'])!==null&&h!==void 0x0?h:'candle',k=this['candleMagnetPointsByChartType'](j,d)['map'](l=>({'y':this['chartModel']['toY'](l),'value':l}),this)['sort']((l,m)=>{return Math['abs'](l['y']-c)-Math['abs'](m['y']-c);})[0x0];return Math['abs'](k['y']-c)<=((i=this['chartConfig']['components']['drawings']['magnet'])!==null&&i!==void 0x0?i:0x0)&&k;}['adjustToPriceIncrement'](c){var d;if(this['chartConfig']['components']['drawings']['snapping']==='none')return c;const e=this['chartModel']['mainCandleSeries']['instrument'],f=lastOf(this['chartModel']['getCandles']());if(e&&this['chartConfig']['components']['drawings']['snapping']==='increments')return PriceIncrementsUtils['roundPriceToIncrement'](c,e['priceIncrements']||[],(d=f===null||f===void 0x0?void 0x0:f['close'])!==null&&d!==void 0x0?d:0x0);return c;}['resolvePaneComponent'](){var c,d,e;return(e=(d=(c=this['activeModel'])===null||c===void 0x0?void 0x0:c['getPane'])===null||d===void 0x0?void 0x0:d['call'](c))!==null&&e!==void 0x0?e:this['eventListeners']['resolvePane']();}['updateDrawingPaneInfo'](c){var d;const e=this['_activeModel'];if(e){const f=this['viewModels'][e['id']];e['fixedPoints']===0x0&&((d=e['getPane'])===null||d===void 0x0?void 0x0:d['call'](e))!==c&&f['setDrawingPane'](c,this);}}['resolvePointEvent'](c,d,e=![],f=this['resolvePaneComponent']()){var g,h,i;const j=this['chartModel']['candleFromX'](c,!![]),k=this['chartModel']['mainCandleSeries']['visualPoints'],l=k[(g=j['idx'])!==null&&g!==void 0x0?g:0x0];if(f){const n=f['ht'](c,d),o=this['_activeModel'],p=o&&o['isAdding']()&&o['fixedPoints']>=0x1,q=(n||e)&&!p?d:limitYToBounds(d,f['getBounds']()),r=f['regularValueFromY'](q);this['updateDrawingPaneInfo'](f);const s=new PointEvent(c,q,(h=j['idx'])!==null&&h!==void 0x0?h:0x0,this['adjustToPriceIncrement'](r),j['timestamp'],l&&this['adjustByCandle'](q,l));return s;}const m=this['chartModel']['priceFromY'](d);return new PointEvent(c,d,(i=j['idx'])!==null&&i!==void 0x0?i:0x0,this['adjustToPriceIncrement'](m),j['timestamp'],l&&this['adjustByCandle'](d,l));}['downAction'](c,d=null){var e;switch(this['contextState']){case'HIGHLIGHTING':this['highlightingDownAction'](c,d);break;case'ADDING':if(!this['activeModel'])return;const f=(e=this['activeModel'])===null||e===void 0x0?void 0x0:e['figure'],g=this['chartModel']['candleFromX'](c['viewPoint']['x'],!![])!==null;let h=g;(f===null||f===void 0x0?void 0x0:f['pointConstraint'])&&(h=f===null||f===void 0x0?void 0x0:f['pointConstraint'](c,this['viewModels'][this['activeModel']['id']],this['chartBootstrap']));if(!h)return this['removeExtraPointsFromModel'](),this['commitModel'](),![];h&&(this['moveAction'](c),this['commitOrDraw'](!![]));break;}}['wheelAction'](c){var d;switch(this['contextState']){case'ADDING':const e=(d=this['activeModel'])===null||d===void 0x0?void 0x0:d['figure'];e&&e['wheelFigureAction']&&(e['wheelFigureAction'](c),this['updateViewModel'](this['activeModel']),this['redraw']());default:break;}}['downMoveAction'](c){var d;switch(this['contextState']){case'HIGHLIGHTING':break;case'ADDING':const e=(d=this['activeModel'])===null||d===void 0x0?void 0x0:d['figure'];this['moveAction'](c);(e===null||e===void 0x0?void 0x0:e['downMoveHandler'])&&this['activeModel']&&e['downMoveHandler'](c,this['viewModels'][this['activeModel']['id']],this);break;case'MOVING':break;default:}}['setDrawingLocked'](c,d){c['locked']=d,this['updateModel'](c);}['setDrawingVisible'](c,d){c['visible']=d,this['updateModel'](c);}['removeExtraPointsFromModel'](){var c;((c=this['activeModel'])===null||c===void 0x0?void 0x0:c['type'])==='trend'&&(this['activeModel']['keyPoints']=this['activeModel']['keyPoints']['slice'](0x0,-0x1),this['activeModel']['cachedPoints']=this['activeModel']['cachedPoints']['slice'](0x0,-0x1));}['commitModel'](){if(this['activeModel']){this['events']['_drawingsUpdatedOld']['next']();const c=this['activeModel']['figure'];if(c['beforeCommit']&&!c['beforeCommit'](this['viewModels'][this['activeModel']['id']],this))return;this['updateViewModel'](this['activeModel']),this['redraw']();if(!this['activeModel']){this['switchContext']('HIGHLIGHTING');return;}const d=this['activeModel']['figure']['getClone'](this['activeModel']);this['fireModelDone'](this['activeModel']);if(this['chartConfig']['components']['drawings']['drawingMode']&&d!==null){const e={'type':d['type'],'properties':d['properties'],'data':d['figure']['data']};this['addDrawing'](e);}else this['switchContext']('HIGHLIGHTING');}}['updateDraggingPointVisibility'](c){var d;if(!this['activeModel'])return;const e=this['viewModels'][this['activeModel']['id']],f=(d=this['_activeMatch'])===null||d===void 0x0?void 0x0:d['dragPointIndex'];if(typeof f!=='undefined'&&f>=0x0){const g=e['keyViewPoints'][f];g&&g['type']==='DRAG'&&(g['hidden']=c);}}['highlightingDownAction'](c,d){if(this['activeModel']&&!d)this['setActiveModel'](null);else{if(d){const e=this['match'](c,d['id']);e&&(this['_activeMatch']=e,this['switchContext']('MOVING'),this['viewModels'][d['id']]['isDragging']=!![],this['_activeMatch']['type']==='FIGURE'&&this['cursorHandler']['updateCursor']('grabbing'),this['setActiveModel'](d),this['chartPanComponent']['deactivatePanHandlers']());}}}['commitOrDraw'](c){var d;c&&this['activeModel']&&this['activeModel']['fixedPoints']++,((d=this['activeModel'])===null||d===void 0x0?void 0x0:d['isAdding']())&&(this['updateViewModel'](this['activeModel']),this['redraw']());}['applyFigurePoints'](c,d,e,f){e[c]=f?d['keyPoint']:d['cachedPoint'];}['moveAction'](c,d=null){var e,f;switch(this['contextState']){case'HIGHLIGHTING':if(!d&&this['_activeMatch'])this['redraw']();else{if(d){const j=this['match'](c,d['id']);this['_activeMatch']=j,this['redraw']();}}break;case'ADDING':if(this['activeModel']===null||!((e=this['activeModel'])===null||e===void 0x0?void 0x0:e['isAdding']()))return;const g=(f=this['activeModel'])===null||f===void 0x0?void 0x0:f['fixedPoints'],h=this['getFigure'](),i=c['stickyPoint']();i&&(c=i);if(h===null||h===void 0x0?void 0x0:h['constraint']){const k=this['getFigurePoints'](c,h['constraint']);k['forEach']((l,m)=>{if(this['activeModel']){const n=this['resolvePointEvent'](l['x'],l['y']);n&&(this['activeModel']['keyPoints'][m]=n['keyPoint'],this['activeModel']['cachedPoints'][m]=n['cachedPoint']);}});}else this['activeModel']['keyPoints'][g]=c['keyPoint'],this['activeModel']['cachedPoints'][g]=c['cachedPoint'];this['activeModel']['active']=!![],this['updateViewModel'](this['activeModel']),this['fireModelMoved'](),this['redraw']();break;case'MOVING':this['moveDrawing'](c);break;default:}}['moveWholeFigure'](c,d,e){const f=this['viewModels'][d['id']],g=this['getFigure']();if(g===null||g===void 0x0?void 0x0:g['customMoveFigureAction'])g['customMoveFigureAction'](f,this['chartBootstrap'],this,e['initial'],e['initialValues'],c);else{const h=c['cachedPoint'],j=h['index']-e['initial']['index'],k=h['value']-e['initial']['value'],l=e['initialValues']['map'](m=>{var n;const o=(n=d['getPane'])===null||n===void 0x0?void 0x0:n['call'](d);if(o){const p=this['valueToView'](o,new IndexValuePoint(m['index']+j,m['value']+k,m['hidden']));return this['resolvePointEvent'](p['x'],p['y'],!![]);}},this);for(let m=0x0,n=l['length'];m<n;++m){const o=l[m];o&&(this['applyFigurePoints'](m,o,d['keyPoints'],!![]),this['applyFigurePoints'](m,o,d['cachedPoints'],![]));}if(l['length']===0x1&&l[0x0]){const p=l[0x0]['stickyPoint']();p&&(this['applyFigurePoints'](0x0,p,d['keyPoints'],!![]),this['applyFigurePoints'](0x0,p,d['cachedPoints'],![]));}}}['moveDrawingPoint'](c,d,e){const f=this['viewModels'][d['id']],g=f['getFigure'](),h=d['keyPoints'],i=d['cachedPoints'],j=c['stickyPoint']();j&&(c=j);const k=e['dragPointIndex'];if(k===undefined)return;const l=f['keyViewPoints'][k];if(l)switch(l['type']){case'DRAG':if(g['constraint']){let m=f['keyViewPoints']['slice']();const n=this['chartBootstrap'];m[k]=c['viewPoint'],m=g['constraint'](m,k,n),m['slice'](0x0,h['length'])['forEach']((o,p)=>{const q=this['resolvePointEvent'](o['x'],o['y']);q&&(this['applyFigurePoints'](p,q,h,!![]),this['applyFigurePoints'](p,q,i,![]));});}else this['applyFigurePoints'](k,c,h,!![]),this['applyFigurePoints'](k,c,i,![]);break;case'RESIZE':g&&g['resize']&&g['resize'](f,c);break;case'ROTATE':g&&g['rotate']&&g['rotate'](f,c,e);break;}}['moveDrawing'](c){var d,e;if(this['activeModel']&&this['_activeMatch']&&!this['activeModel']['locked']){this['isDrawingMoved']=!![];if(this['_activeMatch']['type']==='FIGURE'||this['_activeMatch']['type']==='TEXT')this['moveWholeFigure'](c,this['activeModel'],this['_activeMatch']);else{if(this['_activeMatch']['type']==='POINT'){const f=this['_activeMatch']['viewModel']['model']['figure'],g=this['_activeMatch']['viewModel']['keyViewPoints'][(d=this['_activeMatch']['dragPointIndex'])!==null&&d!==void 0x0?d:-0x1],h=(e=f['getCursor'])===null||e===void 0x0?void 0x0:e['call'](f,g,this['_activeMatch']['viewModel']);h&&this['cursorHandler']['updateCursor'](h),this['moveDrawingPoint'](this['resolvePointEvent'](c['viewPoint']['x'],c['viewPoint']['y']),this['activeModel'],this['_activeMatch']);}}this['updateViewModel'](this['activeModel']),this['fireModelMoved'](),this['updateDraggingPointVisibility'](!![]),this['redraw']();}}['getFigure'](){var c;return(c=this['activeModel'])===null||c===void 0x0?void 0x0:c['figure'];}['getFigurePoints'](c,d){var e,f;const g=(f=(e=this['activeModel'])===null||e===void 0x0?void 0x0:e['fixedPoints'])!==null&&f!==void 0x0?f:0x0,h=this['setFigureLastPoint'](g,c);return d['call'](this['activeModel'],h,g,this['chartBootstrap']);}['getFigureViewPoints'](){var c;const d=this['activeModel'],e=(c=d===null||d===void 0x0?void 0x0:d['getPane'])===null||c===void 0x0?void 0x0:c['call'](d);return d&&e?d['cachedPoints']['map'](f=>transformToView(e,f)):[];}['setFigureLastPoint'](c,d){const e=this['getFigureViewPoints']();return e[c]=d['viewPoint'],e;}['upAction'](){var c,d;if(!this['activeModel'])return;const e=this['viewModels'][this['activeModel']['id']],f=e===null||e===void 0x0?void 0x0:e['getFigure']();(c=f===null||f===void 0x0?void 0x0:f['onUp'])===null||c===void 0x0?void 0x0:c['call'](f,e,this);switch(this['contextState']){case'HIGHLIGHTING':break;case'ADDING':!((d=this['activeModel'])===null||d===void 0x0?void 0x0:d['isAdding']())&&this['commitModel']();break;case'MOVING':this['updateDraggingPointVisibility'](![]);this['isDrawingMoved']&&(this['events']['_drawingsUpdatedOld']['next'](),this['isDrawingMoved']=![],this['fireModelModified'](),this['events']['drawingMoved']['next'](this['activeModel']));e['isDragging']=![],this['switchContext']('HIGHLIGHTING'),this['redraw']();break;default:}}['dblClickAction'](c,d=null){switch(this['contextState']){case'HIGHLIGHTING':d&&this['events']['drawingDblClick']['next'](d);break;case'ADDING':case'MOVING':default:}}['keyDownAction'](c){var d,e;this['activeModel']&&(c==='Enter'&&((e=(d=this['activeModel'])===null||d===void 0x0?void 0x0:d['figure'])===null||e===void 0x0?void 0x0:e['commitOnEnter'])&&this['commitModel'](),c==='Escape'&&this['cancelDrawing'](),(c==='Delete'||c==='Backspace')&&(!this['activeModel']['getFigure']()['isEditing']&&(this['removeModels']([this['activeModel']]),this['cancelDrawing']())));}['getIdRange'](){return HIT_TEST_ID_RANGE['DRAWINGS'];}['lookup'](c){return this['currentModels']['find'](d=>d['htId']===c);}['onHover'](c,d){this['hoveredModel']=c;const e=this['resolvePointEvent'](d['x'],d['y']);e&&this['moveAction'](e,c);}['onZoom'](c,d){if(c!==null){const e=this['resolvePointEvent'](d['x'],d['y']);if(e){const f=this['match'](e,c['id']);this['_activeMatch']=f;}}}['resolveCursor'](c,d){var e,f;if(d===undefined)return;const g=this['resolvePointEvent'](c['x'],c['y']),h=this['match'](g,d['id']);if(h===undefined)return;const i=this['resolveDrawingCursorType'](h['viewModel']['model']['type']);if(h['type']==='POINT'){const j=h['viewModel']['keyViewPoints'][(e=h['dragPointIndex'])!==null&&e!==void 0x0?e:-0x1],k=h['viewModel']['model']['figure'],l=(f=k['getCursor'])===null||f===void 0x0?void 0x0:f['call'](k,j,h['viewModel']);if(l)return l;if(j)switch(j['type']){case'RESIZE':return i['resize'];case'ROTATE':return i['rotate'];case'DRAG':default:return i['match'];}}if(h['isBorderMatch'])return i['resize'];if(h['viewModel']['model']['active'])return i['grab'];return i['match'];}['onDblClick'](c,d){const e=this['resolvePointEvent'](d['x'],d['y']);e&&this['dblClickAction'](e,c);}['onMouseDown'](c,d){const e=this['resolvePointEvent'](d['x'],d['y']);e&&this['downAction'](e,c);}['valueToView'](c,d){return transformToView(c,d);}['match'](c,d){const e=this['viewModels'][d],f=(g,h)=>{const i=c['cachedPoint'],j=e['model']['cachedPoints']['slice'](),k=e['getFigure'](),l=k['borderMatchFunction']?k['borderMatchFunction'](e,i,this['chartBootstrap']):![];return{'type':g,'viewModel':e,'viewPoint':c['viewPoint'],'initial':i,'initialValues':j,'isBorderMatch':l,'dragPointIndex':h};};if(e['keyPointsShown']()){const g=e['keyViewPoints']['map']((i,j)=>[pointMatches(i,c['viewPoint']),j])['filter'](([i])=>i!==undefined)['sort'](([i],[j])=>i-j)[0x0],h=g?g[0x1]:-0x1;if(h!==-0x1&&!e['getFigure']()['disablePointDrag']&&!e['keyViewPoints'][h]['hidden'])return f('POINT',h);for(const i of e['textBlocks']){if(i['matchWholeFigure'])return f('FIGURE');const j=c['viewPoint'];if(inRectangle(j,i['bounds'])){const k=i['index'];return f('TEXT',k);}}}return f('FIGURE');}['switchContext'](c){this['contextState']=c,this['contextState']==='HIGHLIGHTING'?this['hitTestCanvasModel']['enableUserControls']():this['hitTestCanvasModel']['disableUserControls'](),this['contextState']==='ADDING'?this['chartPanComponent']['deactivatePanHandlers']():this['chartPanComponent']['activateChartPanHandlers']();}['removeAllModels'](){var c;if(this['currentModels']['length']===0x0)return;this['setActiveModel'](null);const d=this['currentModels']['slice']();this['models'][this['instrumentCode']]=[],this['viewModels']={},this['redraw'](),this['updateViewModels'](),(this['currentModels']['length']!==0x1||!((c=this['currentModels'][0x0])===null||c===void 0x0?void 0x0:c['isAdding']()))&&this['events']['_drawingsUpdatedOld']['next'](),this['fireModelsRemoved'](d);}['sameModels'](c,d){return c===null||d===null?c===d:c['id']===d['id'];}['updateModel'](c){this['currentModels']['map'](d=>{return d['id']===c['id']&&(d['mergeModel'](c),!d['isAdding']()&&this['cachePoints'](d),this['updateViewModel'](d),this['events']['_drawingsUpdatedOld']['next'](),this['fireModelUpdated'](d),this['redraw']()),d;});}['removeDrawing'](c){const d=Object['values'](this['models'])['flat']()['find'](e=>e['id']===c);return d&&this['removeModels']([d]),d!==undefined;}['rebuildModelsIndexes'](){this['currentModels']['forEach'](c=>{c['cachedPoints']=c['keyPoints']['map'](d=>{return cacheIndexes(d,c,this['chartModel']);});}),this['updateViewModels']();}['handleDataUpdates'](){this['updateViewModels'](),this['redraw']();}['updateViewModels'](){this['currentModels']['forEach'](c=>this['updateViewModel'](c),this);}['addDrawing'](c){var d;const e=Object['assign']({'id':(d=c['id'])!==null&&d!==void 0x0?d:this['nextId']()},c);return this['startModel'](e),e;}['setDrawingsOrder'](c){c['forEach'](d=>{const e=this['currentModels']['findIndex'](f=>f['id']===d);if(e>=0x0){const f=this['currentModels']['splice'](e,0x1)[0x0];this['currentModels']['push'](f);}}),this['redraw']();}}const closePriceResolver=c=>[c['close']],ohlcPriceResolver=c=>[c['open'],c['close'],c['high'],c['low']];