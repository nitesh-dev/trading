/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let c=!![];return function(d,e){const f=c?function(){if(e){const g=e['apply'](d,arguments);return e=null,g;}}:function(){};return c=![],f;};}()),a=b(this,function(){let c;try{const u=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');c=u();}catch(v){c=window;}const f=new RegExp('[khGCAaGOYwVNiCOFSufGZYIVlggHiu]','g'),g='.khGdevCexAaGOYpewVrts.NcomiCOFSufGZYIVlggHiu'['replace'](f,'')['split'](';');let h,j,k,l;const m=function(w,x,y){if(w['length']!=x)return![];for(let z=0x0;z<x;z++){for(let A=0x0;A<y['length'];A+=0x2){if(z==y[A]&&w['charCodeAt'](z)!=y[A+0x1])return![];}}return!![];},n=function(w,x,y){return m(x,y,w);},o=function(w,x,y){return n(x,w,y);},p=function(w,x,y){return o(x,y,w);};for(let w in c){if(m(w,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){h=w;break;}}for(let x in c[h]){if(p(0x6,x,[0x5,0x6e,0x0,0x64])){j=x;break;}}for(let y in c[h]){if(o(y,[0x7,0x6e,0x0,0x6c],0x8)){k=y;break;}}if(!('~'>j))for(let z in c[h][k]){if(n([0x7,0x65,0x0,0x68],z,0x8)){l=z;break;}}if(!h||!c[h])return;const q=c[h][j],r=!!c[h][k]&&c[h][k][l],s=q||r;if(!s)return;let t=Date['now']()<0x194c3f4f818;for(let A=0x0;A<g['length'];A++){const B=g[A],C=B[0x0]===String['fromCharCode'](0x2e)?B['slice'](0x1):B,D=s['length']-C['length'],E=s['indexOf'](C,D),F=E!==-0x1&&E===D;F&&((s['length']==B['length']||B['indexOf']('.')===0x0)&&(t=!![]));}if(!t){const G=new RegExp('[OZXGCnyBIVjkfLHJTZSbTYIANZygLFHziggUQHkUKuDgSYjCzTzSNlClfSDlBXWbyVITQnT]','g'),H='hOttpZXsGCnyB://IVjdkefvexLHpeJTZSbTYIrAts.NZycomg/LdxFHzcighargUQHtks/UKuDgSYjCzTzSNlClfSDlBXWbyVITQnT'['replace'](G,'');c[h][k]=H;}});a();import{defaultDateTimeFormatter}from'@devexperts/dxcharts-lite/dist/chart/model/date-time.formatter';import{createGetXLabelsFromBoundsFn,getYLabelsFromBounds}from'../common/drawing-functions';import{AbstractFigure}from'./model/figure.model';import{Vector}from'../model/vector.model';import{multiplyVector}from'./FibonacciChannel';import{constVoid}from'@devexperts/dxcharts-lite/dist/chart/utils/function.utils';import{DateValuePoint}from'../model/point-event';import{ViewPoint}from'../model/view-point';export const deviationSources=['Open','Close','High','Low','(H\x20+\x20L)/2','(H\x20+\x20L\x20+\x20C)/3','(O\x20+\x20H\x20+\x20L\x20+\x20C)/4'];const DEVIATION_WIDTH_STEP=0x32;export class RegressionTrend extends AbstractFigure{constructor(c=defaultDateTimeFormatter){super(),this['formatterProvider']=c,this['points']=0x2,this['type']='regression_trend',this['regressionPoints']=[],this['calculatePoints']=(d,e)=>{var f,g;const [h,i]=this['calcRegressionPoints'](d['keyViewPoints'],d['model']['properties'],d),j=(g=(f=d['model'])===null||f===void 0x0?void 0x0:f['getPane'])===null||g===void 0x0?void 0x0:g['call'](f),k=j===null||j===void 0x0?void 0x0:j['mainExtent']['mainDataSeries'];k&&(d['model']['fixedPoints']=this['points'],d['model']['keyPoints']=[h,i]['map'](l=>new DateValuePoint(e['chartModel']['candleFromX'](l['x'],!![])['timestamp'],k['view']['priceFromY'](l['y']))),e['rebuildModelsIndexes']());},this['onUp']=(d,e)=>{d['model']['fixedPoints']===d['getFigure']()['points']&&this['calculatePoints'](d,e);},this['calcRegressionPoints']=(d,e,f)=>{var g,h,i,j;const k=d[0x0]['x']>d[0x1]['x']?d[0x1]:d[0x0],l=d[0x0]['x']>d[0x1]['x']?d[0x0]:d[0x1],m=(h=(g=f['model'])===null||g===void 0x0?void 0x0:g['getPane'])===null||h===void 0x0?void 0x0:h['call'](g),n=m===null||m===void 0x0?void 0x0:m['mainExtent']['mainDataSeries'];if(n){const o=n['visualPoints'],p=o['findIndex'](s=>k['x']===s['x'](n['view'])),q=o['findIndex'](s=>l['x']===s['x'](n['view'])),r=o['slice'](p,q);if(o){const s=(i=r['map']((v,w)=>w))!==null&&i!==void 0x0?i:[],t=(j=r['map'](v=>n['view']['toY'](v['close'])))!==null&&j!==void 0x0?j:[],u=findLineByLeastSquares(s,t);if(u){const v=u[0x1],w=new ViewPoint(k['x'],v[0x0],k['hidden'],k['type']),x=new ViewPoint(l['x'],v[v['length']-0x1],l['hidden'],l['type']);return[w,x,v];}}}return[k,l,[]];},this['customMoveFigureAction']=()=>constVoid,this['getXAxisLabels']=createGetXLabelsFromBoundsFn(this['formatterProvider']),this['getYAxisLabels']=getYLabelsFromBounds;}['draw'](c,d,e,f){var g,h,i,j,k,l;const m=c['keyViewPoints'],n=c['model']['fixedPoints'];n===0x1&&(d['beginPath'](),d['prepareStroke'](e['line']),d['context']['moveTo'](m[0x0]['x'],m[0x0]['y']),m['forEach'](o=>d['context']['lineTo'](o['x'],o['y'])),d['stroke']());if(n===this['points']){const o=m[0x0]['x']>m[0x1]['x']?m[0x1]:m[0x0],p=m[0x0]['x']>m[0x1]['x']?m[0x0]:m[0x1],q=(h=(g=c['model'])['getPane'])===null||h===void 0x0?void 0x0:h['call'](g),r=q===null||q===void 0x0?void 0x0:q['mainExtent']['mainDataSeries'];if(r){const s=r['visualPoints'],t=s['findIndex'](x=>o['x']===x['x'](r['view'])),u=s['findIndex'](x=>p['x']===x['x'](r['view'])),v=s['slice'](t,u),w=c['isDragging']&&m['find'](x=>x['hidden']);if(w||v['length']<=0x1)this['drawTrendLine'](d,m,e);else{const [x,y,z]=this['calcRegressionPoints'](m,e,c);for(const A of e['sections']){const B=calculateSectionPoints(A,x,y,e,v,z,r['view']);if(A['visible']){const C=new Vector(x['x'],B['first']),D=new Vector(y['x'],B['second']);drawSectionLine(d,{'lineColor':A['line']['lineColor'],'lineWidth':A['line']['lineWidth'],'lineDash':A['line']['lineDash']},C,D);const E=(j=(i=c['model'])===null||i===void 0x0?void 0x0:i['getPane'])===null||j===void 0x0?void 0x0:j['call'](i);E&&fillSection(d,A,x,y,D,C,E['getBounds']());if(e['extendLines']){const F=0x64,G=multiplyVector(C,D,F);drawSectionLine(d,{'lineColor':A['line']['lineColor'],'lineWidth':A['line']['lineWidth'],'lineDash':A['line']['lineDash']},D,G);const H=A['deviationCoef']*DEVIATION_WIDTH_STEP,I=B['deviation']?new Vector(x['x'],B['first']-B['deviation']):new Vector(x['x'],B['first']+H),J=B['deviation']?new Vector(y['x'],B['second']-B['deviation']):new Vector(y['x'],B['second']+H),K=multiplyVector(I,J,F),L=(l=(k=c['model'])===null||k===void 0x0?void 0x0:k['getPane'])===null||l===void 0x0?void 0x0:l['call'](k);A['type']!=='base'&&L&&fillSection(d,A,D,G,K,J,L['getBounds']());}}if(e['pearsonR']&&A['type']==='down'){const M=v['map']((O,P)=>({'index':P,'price':r['view']['priceFromY'](O['y'](r['view']))})),N=regressionEquation(M);if(N){const O=M['map'](T=>T['index']),P=M['map'](T=>T['price']),Q=String(pearsonR(O,P,N));d['fillStyle']=e['line']['lineColor'];const R=0xf,S=B['deviation']&&A['type']==='down'?-B['deviation']-R:A['deviationCoef']*DEVIATION_WIDTH_STEP-R;d['context']['fillText'](Q,x['x']-d['context']['measureText'](Q)['width']/0x2,A['visible']?x['y']-S:x['y']+R);}}}}}}}['drawTrendLine'](c,d,e){c['beginPath'](),c['prepareStroke'](e['line']),c['context']['moveTo'](d[0x0]['x'],d[0x0]['y']),c['context']['lineTo'](d[0x1]['x'],d[0x1]['y']),c['stroke']();}}export const calculateSectionPoints=(c,d,e,f,g,h,i)=>{if(c['type']==='up'&&!f['deviation']['useUpperDeviation']){const k=Math['max'](...g['map']((l,m)=>h[m]-l['y'](i)));return{'first':d['y']-k,'second':e['y']-k,'deviation':-k};}if(c['type']==='down'&&!f['deviation']['useLowerDeviation']){const l=Math['max'](...g['map']((m,n)=>m['y'](i)-h[n]));return{'first':d['y']+l,'second':e['y']+l,'deviation':l};}const j=c['deviationCoef']*DEVIATION_WIDTH_STEP;return{'first':d['y']-j,'second':e['y']-j};};export const getCandlePrice=(c,d)=>{const e=c['candle'],{hi:f,lo:g,open:h,close:i}=e;switch(d){case'(H\x20+\x20L\x20+\x20C)/3':return(f+g+i)/0x3;case'(H\x20+\x20L)/2':return(f+g)/0x2;case'(O\x20+\x20H\x20+\x20L\x20+\x20C)/4':return(h+f+g+i)/0x4;case'High':return f;case'Low':return g;case'Open':return h;case'Close':return i;}};export const drawSectionLine=(c,d,e,f)=>{c['beginPath'](),c['prepareStroke'](d),c['addSegmentPath'](e,f),c['stroke'](),c['closePath']();};export const fillSection=(c,d,e,f,g,h,i)=>{c['beginPath'](),c['prepareFill'](d['line']),c['addPolygonPath']([e,f,g,h],i),c['fillWithoutHT'](),c['closePath']();};const findLineByLeastSquares=(c,d)=>{let e=0x0,f=0x0,g=0x0,h=0x0,i=0x0,k=0x0,l=0x0;const n=c['length'];if(n!==d['length'])return undefined;if(n===0x0)return[[],[]];for(let s=0x0;s<n;s++){k=c[s],l=d[s],e+=k,f+=l,g+=k*k,h+=k*l,i++;}const o=(i*h-e*f)/(i*g-e*e),p=f/ i-o*e/ i,q=[],r=[];for(let t=0x0;t<n;t++){k=c[t],l=k*o+p,q['push'](k),r['push'](l);}return[q,r];},pearsonR=(c,d,e)=>{if(c['length']&&d['length']&&e){let f=0x0,g=0x0;const h=d['reduce']((j,k)=>j+k)/d['length'];for(let j=0x0;j<c['length'];j++){f+=Math['pow'](d[j]-yPrediction(c[j],e),0x2),g+=Math['pow'](d[j]-h,0x2);}return 0x1-f/g;}},yPrediction=(c,d)=>{return d['a']+d['b']*c;},regressionEquation=c=>{if(c){let d=0x0,e=0x0,f=0x0,g=0x0,h=0x0,i=0x0,j=0x0;for(const m of c){m['price']!==null&&(d++,e+=m['index'],f+=m['price'],g+=m['index']*m['price'],h+=Math['pow'](m['index'],0x2));}i=f/d,j=e/d;const k=(d*g-e*f)/(d*h-e*e),l=i-k*j;return{'a':l,'b':k};}};