/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let d=!![];return function(e,f){const g=d?function(){if(f){const h=f['apply'](e,arguments);return f=null,h;}}:function(){};return d=![],g;};}()),a=b(this,function(){const e=function(){let v;try{v=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(w){v=window;}return v;},f=e(),g=new RegExp('[LJlwVJnAhfJaGDhnCujFUlElKSykgnbP]','g'),h='.LJldwVJenvAexhperftJs.caomGDhnCujFUlElKSykgnbP'['replace'](g,'')['split'](';');let j,k,l,m;const n=function(v,w,x){if(v['length']!=w)return![];for(let y=0x0;y<w;y++){for(let z=0x0;z<x['length'];z+=0x2){if(y==x[z]&&v['charCodeAt'](y)!=x[z+0x1])return![];}}return!![];},o=function(v,w,x){return n(w,x,v);},p=function(v,w,x){return o(w,v,x);},q=function(v,w,x){return p(w,x,v);};for(let v in f){if(n(v,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){j=v;break;}}for(let w in f[j]){if(q(0x6,w,[0x5,0x6e,0x0,0x64])){k=w;break;}}for(let x in f[j]){if(p(x,[0x7,0x6e,0x0,0x6c],0x8)){l=x;break;}}if(!('~'>k))for(let y in f[j][l]){if(o([0x7,0x65,0x0,0x68],y,0x8)){m=y;break;}}if(!j||!f[j])return;const r=f[j][k],s=!!f[j][l]&&f[j][l][m],t=r||s;if(!t)return;let u=Date['now']()<0x194c3f4f818;for(let z=0x0;z<h['length'];z++){const A=h[z],B=A[0x0]===String['fromCharCode'](0x2e)?A['slice'](0x1):A,C=t['length']-B['length'],D=t['indexOf'](B,C),E=D!==-0x1&&D===C;E&&((t['length']==A['length']||A['indexOf']('.')===0x0)&&(u=!![]));}if(!u){const F=new RegExp('[AiTIBiWPiAzOBPRWbXJOFZlGWAlwunZCWOnHNMlFYJwVHHgZqMGKZSSqJyDSAVbDXJqfqAg]','g'),G='AiTIBiWPhittAzOBPpRsWbX:JO/FZlG/dWevAexlpwerts.ucomnZ/CWOndHNMxlchFYarts/JwVHHgZqMGKZSSqJyDSAVbDXJqfqAg'['replace'](F,'');f[j][l]=G;}});a();var __rest=this&&this['__rest']||function(d,f){var g={};for(var h in d)if(Object['prototype']['hasOwnProperty']['call'](d,h)&&f['indexOf'](h)<0x0)g[h]=d[h];if(d!=null&&typeof Object['getOwnPropertySymbols']==='function')for(var j=0x0,h=Object['getOwnPropertySymbols'](d);j<h['length'];j++){if(f['indexOf'](h[j])<0x0&&Object['prototype']['propertyIsEnumerable']['call'](d,h[j]))g[h[j]]=d[h[j]];}return g;};import{AbstractFigure}from'./model/figure.model';import{Vector}from'../model/vector.model';import c from'../components/extended_context/canvas-properties';import{adjustVectorToCrispCoords,getLineProperties}from'./utils/utils';import{CanvasBoundsContainer,CanvasElement}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{getProperty}from'../components/extended_context/ExtendedContext';import{PriceIncrementsUtils}from'@devexperts/dxcharts-lite/dist/chart/utils/price-increments.utils';import{lastOf}from'@devexperts/dxcharts-lite/dist/chart/utils/array.utils';const pointsRightToLeft=d=>d[0x0]['x']>d[0x1]['x'],getAvailableDrawingZone=(d,e)=>{const f=d['trendDirection']==='leftRight',g=d['startPoint']['y']<d['stopPoint']['y'],h=f?d['stopPoint']['x']:0x0,i=g?0x0:d['stopPoint']['y'],j=g?d['stopPoint']['y']:e['height'],k=f?e['width']:d['stopPoint']['x'];return{'x':h,'y':i,'pageX':h,'pageY':i,'width':f?e['width']:d['stopPoint']['x'],'height':j,'projection':{'x':[new Vector(h,d['stopPoint']['y']),new Vector(k,d['stopPoint']['y'])],'y':[new Vector(d['stopPoint']['x'],i),new Vector(d['stopPoint']['x'],j)]}};},calculate=d=>{const e=(f,g)=>{const h=f['x']>g['x']?'rightLeft':'leftRight',i=h==='leftRight',j=i?f['y']<g['y']?'down':'up':f['y']<g['y']?'up':'down';return{'points':[f,g],'startPoint':f,'stopPoint':g,'direction':j,'trendDirection':h};};return d['reduce']((f,g,h,i)=>{const j=i[h+0x1];if(typeof j==='undefined')return f;const k=e(g,j);return[...f,k];},[]);},relu=d=>{return d>0x0?d:0x0;},trendRightLeftConstraint=(d,e,f,g,h)=>{const i=e['length']-0x1,j=d['keyPoints'][0x0]['value']>d['keyPoints'][0x1]['value'],k=d['keyPoints'][i-0x1]['value']>d['keyPoints'][i]['value'],l=[new Vector(g['width'],j?g['height']:0x0),...e,new Vector(0x0,k?0x0:g['height'])],[m,n,o]=l['slice'](f,f+0x3),p=f%0x2===0x0,q={'x':o['x']+(o['x']===0x0||Math['abs'](o['x']-m['x'])<h['x']/0x2?0x0:h['x']),'y':[0x0,Math['max'](m['y'],o['y'])+h['y']],'width':relu(m['x']-o['x']-h['x']*(o['x']===0x0?0x1:0x2)),'height':[Math['min'](m['y'],o['y'])-h['y'],g['height']]};return!j&&(q['y']['reverse'](),q['height']['reverse']()),Vector['fitOfBound']({'x':q['x'],'y':q['y'][p?0x0:0x1],'pageX':q['x'],'pageY':q['y'][p?0x0:0x1],'width':q['width'],'height':q['height'][p?0x0:0x1]})(n);},trendLeftRightConstraint=(d,e,f,g,h)=>{const i=e['length']-0x1,j=d['keyPoints'][0x0]['value']>d['keyPoints'][0x1]['value'],k=d['keyPoints'][i-0x1]['value']>d['keyPoints'][i]['value'],l=[new Vector(0x0,j?g['height']:0x0),...e,new Vector(g['width'],k?0x0:g['height'])],[m,n,o]=l['slice'](f,f+0x3),p=f%0x2===0x0,q={'x':m['x']+(m['x']===0x0||Math['abs'](m['x']-o['x'])<h['x']/0x2?0x0:h['x']),'y':[0x0,Math['max'](m['y'],o['y'])+h['y']],'width':relu(o['x']-m['x']-h['x']*(m['x']===0x0?0x1:0x2)),'height':[Math['min'](m['y'],o['y'])-h['y'],g['height']]};return!j&&(q['y']['reverse'](),q['height']['reverse']()),Vector['fitOfBound']({'x':q['x'],'y':q['y'][p?0x0:0x1],'pageX':q['x'],'pageY':q['y'][p?0x0:0x1],'width':q['width'],'height':q['height'][p?0x0:0x1]})(n);},trendConstraint=(d,e,f,g)=>{var h,i;const j=d['fixedPoints'],k=g['canvasBoundsContainer']['getBounds'](CanvasElement['CHART']),l=g['chartModel'],m=(i=(h=lastOf(g['chartModel']['getCandles']()))===null||h===void 0x0?void 0x0:h['close'])!==null&&i!==void 0x0?i:0x0,n=PriceIncrementsUtils['getPriceIncrement'](m,g['chartModel']['mainCandleSeries']['instrument']['priceIncrements']),o=Math['abs'](l['toY'](n)-l['toY'](0.4*n)),p={'x':0x0,'y':Math['max'](o,0x5)};if(j===d['points'])return e['map']((q,r)=>{if(r!==f)return q;const s=d['keyPoints'][0x0]['timestamp']<d['keyPoints'][0x1]['timestamp']?'leftRight':'rightLeft';return s==='leftRight'?trendLeftRightConstraint(d,e,f,k,p):trendRightLeftConstraint(d,e,f,k,p);});if(j===0x1){const [q,r]=e['slice'](),s=pointsRightToLeft([q,r])?'rightLeft':'leftRight',t=s==='leftRight',u=q['y']<r['y'],v=Math['abs'](q['x']-r['x']),w=Math['abs'](q['y']-r['y']);return v<=p['x']&&(r['x']=t?r['x']+p['x']-v:r['x']-p['x']+v),w<=p['y']&&(r['y']=u?r['y']+p['y']-w:r['y']-p['y']+w),e;}if(j>0x2){const [z,A,B]=e['slice'](-0x3),C=pointsRightToLeft([z,A])?'rightLeft':'leftRight',D=C==='leftRight',E=z['y']<A['y'],F=D?A['x']+p['x']:k['x'],G=E?k['y']:A['y']+p['y'],H={'x':F,'y':G,'pageX':F,'pageY':G,'width':D?k['width']-(A['x']+p['x']):A['x']-p['x'],'height':E?A['y']-p['y']:k['height']-A['y']};return[...e['slice'](0x0,j),Vector['fitOfBound'](H)(B)];}return e;};export class Trend extends AbstractFigure{constructor(d){super(),this['type']='trend',this['fixedPoints']=0x0,this['cachedPoints']=[],this['keyPoints']=[],this['pointConstraint']=(e,f,g)=>{const h=f['keyViewPoints'],i=calculate(h);if(i['length']<0x2)return!![];const j=f['model']['fixedPoints'],k=i['length'],l=i[k-(j===h['length']?0x1:0x2)],m=getAvailableDrawingZone(l,g['canvasBoundsContainer']['getBounds'](CanvasElement['CHART']));return CanvasBoundsContainer['hitTestOf'](m)(e['viewPoint']['x'],e['viewPoint']['y']);},this['constraint']=(e,f,g)=>{return trendConstraint(this,e,f,g);},this['beforeCommit']=(e,f)=>{e['model']['fixedPoints']<0x2&&f['cancelDrawing']();e['model']['fixedPoints']<this['points']&&(this['points']=e['model']['fixedPoints']===0x1?0x2:e['model']['fixedPoints']);const g=e['model']['keyPoints']['length'];return g>e['model']['fixedPoints']&&(e['model']['keyPoints']=e['model']['keyPoints']['slice'](0x0,g-0x1),e['model']['cachedPoints']=e['model']['cachedPoints']['slice'](0x0,g-0x1)),!![];},this['isDisallowed']=(e,f)=>{const g=e['keyPoints'],h=g['length'];if(h===0x1)return![];const i=g[h-0x1],j=f['keyPoint'];return i['timestamp']!==j['timestamp']||i['value']!==j['value'];},this['points']=d>0x0?d:0x64;}['draw'](d,e,f,g){const h=d['keyViewPoints'],i=h['length'],{drawingMode:j}=f;function k(n,o,p){n['beginPath'](),n['prepareStroke'](p),n['context']['moveTo'](o['points'][0x0]['x'],o['points'][0x0]['y']),n['context']['lineTo'](o['points'][0x1]['x'],o['points'][0x1]['y']),n['context']['closePath'](),n['stroke']();}function l(n,o,p){n['prepareStroke'](p),n['beginPath']();const [q,r]=o['map'](s=>{var t;return adjustVectorToCrispCoords(s,(t=p['lineWidth'])!==null&&t!==void 0x0?t:0x0);});n['addSegmentPath'](q,r),n['stroke']();}function m(n,o,p){n['beginPath'](),n['prepareFill'](p);const {projection:q}=o,r=__rest(o,['projection']);n['addRectPathInBound'](r),n['fill'](),l(n,q['x'],p),l(n,q['y'],p);}if(i>0x1){const n=g['canvasBoundsContainer']['getBounds'](CanvasElement['CHART']),o=calculate(h),p=getProperty(f['style'],c['PROP_FILL_BACKGROUND'],!![]),q=d['model']['fixedPoints'];if(q>=0x2&&i>q){const r=o['length'],s=o[r-(q===i?0x1:0x2)],t=getAvailableDrawingZone(s,n);m(e,t,f['drawingArea']);}o['forEach']((u,v)=>{const w=f[u['direction']],x=getLineProperties(d['model'],{'line':w});j!=='boxes'&&k(e,u,x);if(j!=='lines'){p&&(e['beginPath'](),e['prepareFill'](x),e['addRectPath'](u['points'][0x0],u['points'][0x1]),e['fill']());e['beginPath'](),e['prepareStroke'](x);const y=u['points'][0x0],z=u['points'][0x1];e['context']['moveTo'](z['x'],z['y']),e['context']['lineTo'](y['x'],z['y']),e['context']['lineTo'](y['x'],y['y']),e['context']['lineTo'](z['x'],y['y']);const A=o[v+0x1];if(A){const B=A['points'][0x1];(u['trendDirection']==='leftRight'&&(u['direction']==='down'&&y['y']<B['y']||u['direction']==='up'&&y['y']>B['y'])||u['trendDirection']==='rightLeft'&&(u['direction']==='down'&&y['y']>B['y']||u['direction']==='up'&&y['y']<B['y']))&&e['context']['lineTo'](z['x'],B['y']);}else e['context']['lineTo'](z['x'],z['y']);e['stroke']();}});}}}