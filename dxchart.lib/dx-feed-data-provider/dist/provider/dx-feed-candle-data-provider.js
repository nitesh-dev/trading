/** Copyright Â©2024 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
import{isExtendedHoursSupported}from'@dx-private/dxchart5-react/dist/chart/model/aggregation.model';import{sortChartCandle}from'@dx-private/dxchart5-react/dist/chart/model/chart.model';import{success}from'@dx-private/dxchart5-react/dist/utils/adt/remote-data.adt';import{remoteData}from'@dx-private/dxchart5-react/dist/utils/remote-data';import{addDays,addYears}from'date-fns';import{array,option}from'fp-ts';import{observable}from'fp-ts-rxjs';import{sequenceT}from'fp-ts/Apply';import{filter,fold,fromNullable,getOrElse,isSome,option as a}from'fp-ts/Option';import{constant,pipe}from'fp-ts/function';import{Subject,merge}from'rxjs';import{map,shareReplay,startWith,tap,throttleTime}from'rxjs/operators';import{instrumentFromKey}from'../data-provider.model';import{DEFAULT_LAZY_LOADING_CONFIG}from'./candle-provider-adapter';const FROM_TIME=0x3b9aca00;export const createDxFeedCandleDataProvider=(b,c=DEFAULT_LAZY_LOADING_CONFIG)=>{const d=new Map(),e=b['subscribeCandles']([],FROM_TIME),f=(p,q,r,s)=>{const t=new Subject();return{'key':toSubscriptionKey(p,q,r),'aggregation':q,'partialData':[],'subject':new Subject(),'moreDataSubject':t,'moreData':t['pipe'](throttleTime(0x3e8)),'lastCandleSubject':new Subject(),'hasCachedData':![],'inactive':![],'data':[],'border':-0x1,'mainSymbol':s};},g=p=>fromNullable(d['get'](p)),h=(p,q,r,s)=>pipe(toSubscriptionKey(p,q,r),g,filter(t=>!t['inactive']),getOrElse(()=>{const t=f(p,q,r,s),u=t['key'],v=g(u);let w=FROM_TIME;if(isSome(v)){const A=v['value']['partialData'];t['partialData']=A,t['border']=v['value']['border'],t['data']=v['value']['data'],t['hasCachedData']=v['value']['hasCachedData'];const B=A[A['length']-0x1];w=getTimeFromLastCandle(B,q),c['enabled']&&(t['partialData']=t['data']['slice'](t['border']));}e['addSymbols']([u]),e['setFromTime'](w);let x=[],y=null,z=t['hasCachedData'];return e['observable']['pipe'](observable['filter'](([C])=>C===u),tap(([C,D])=>{x=x['concat'](D),z?!y&&(y=setTimeout(()=>{k(C,x,s),y=null,x=[];},0xa)):(k(C,x,s),z=!![]);}))['subscribe'](),d['set'](t['key'],t),t;})),i=(p,q)=>pipe(g(p),fold(constant(![]),r=>{return d['set'](p,Object['assign'](Object['assign']({},r),q)),!![];})),j=p=>pipe(g(p),fold(constant(![]),q=>{e['removeSymbols']([p]);const r=g(p);return isSome(r)&&(r['value']['inactive']=!![]),q['subject']['complete'](),!![];})),k=(p,q,r)=>pipe(p,g,option['fold'](()=>console['warn']('Non-existing\x20key:\x20'+p),s=>{const t=pipe(q,array['filterMap'](toCandleFromFeed),sortChartCandle);if(Array['isArray'](t)){if(s['hasCachedData'])t['forEach']((u,v)=>{var w;checkCandleIsNew(s['data'],u)?s['data']['push'](u):updateExistingCandle(s['data'],u);const x=lastOf(t);checkCandleIsLast(s['data'],u)&&x!==undefined&&(u['time']!==((w=t[v+0x1])===null||w===void 0x0?void 0x0:w['time'])&&s['lastCandleSubject']['next'](x));});else{const u=pipe(option['fromNullable'](r),option['map'](x=>p['replace'](instrumentFromKey(p),x)),option['chain'](g),option['map'](x=>x['partialData']['length']!==0x0?x['partialData']['length']:c['firstChunkSize']),option['fold'](()=>t['length']-c['firstChunkSize'],x=>t['length']-x),x=>x>0x0?x:0x0),v=s['border']!==-0x1?s['border']:u,w=c['enabled']?t['slice'](v):t;i(p,{'hasCachedData':!![],'data':t,'partialData':w,'border':t['length']>c['firstChunkSize']?v:0x0}),s['subject']['next'](success({'data':t,'instrument':instrumentFromKey(p),'type':'HISTORICAL'}));}}})),l=(p,q,r,s)=>{const t=toSubscriptionKey(p,q,r);return pipe(t,g,filter(u=>!u['inactive']),getOrElse(()=>h(p,q,r,s)),({subject:u,moreData:v,hasCachedData:w,partialData:x})=>{return merge(u['asObservable'](),v['pipe'](tap(y=>{pipe(g(t),option['fold'](()=>console['warn']('couldn\x27t\x20update\x20sub\x20'+t),z=>i(t,{'partialData':z['data']['slice'](z['border']),'border':remoteData['isSuccess'](y)?y['value']['newBorder']:0x0})));})))['pipe'](startWith(w?remoteData['success']({'type':'HISTORICAL','data':x,'instrument':instrumentFromKey(t)}):remoteData['pending']),map(y=>pipe(g(t),option['fold'](()=>remoteData['pending'],z=>{if(remoteData['isPending'](y)&&z['hasCachedData'])return remoteData['success']({'type':'HISTORICAL','data':z['partialData'],'instrument':instrumentFromKey(t)});return y;}))),shareReplay({'bufferSize':0x1,'refCount':!![]}));});},m=(p,q,r,s)=>{return pipe(toSubscriptionKey(p,q,r),g,filter(t=>!t['inactive']),fold(()=>console['warn']('Requested\x20more\x20data\x20for\x20non-existing\x20sub'),({moreDataSubject:t,data:u,border:v,key:w,hasCachedData:x})=>{if(c['enabled']&&x){let y=0x1f4,z=Math['max'](v-c['nextChunkSize'],0x0);if(s!==undefined){y=0x0;for(let B=0x0;B<u['length'];B++){const C=u[B];z=B;if(C['time']>s)break;}}const A=u['slice'](z,v);A['length']&&setTimeout(()=>t['next'](remoteData['success']({'type':'LAZY','data':A,'instrument':instrumentFromKey(w),'newBorder':z})),y);}}));},n=(p,q,r)=>{return pipe(toSubscriptionKey(p,q,r),g,filter(s=>!s['inactive']),getOrElse(()=>h(p,q,r)),s=>{return s['lastCandleSubject']['asObservable']();});},o=(p,q,r)=>{q?j(toSubscriptionKey(p,q,r)):d['forEach'](s=>{instrumentFromKey(s['key'])===p&&(j(toSubscriptionKey(p,s['aggregation'],Object['assign'](Object['assign']({},r),{'extendedHours':!![]}))),j(toSubscriptionKey(p,s['aggregation'],Object['assign'](Object['assign']({},r),{'extendedHours':![]}))));});};return{'subscribeHistoryData':l,'subscribeLastCandleUpdates':n,'unsubscribeData':o,'requestMoreData':m};};const getTimeFromLastCandle=(b,c)=>{if(!b)return console['warn']('Last\x20candle\x20was\x20not\x20provided,\x20switching\x20to\x20max\x20time\x20for\x20aggregation'),getMaxFromTimeForAggregation(c);return b['time'];};export const periodToString=(b,c)=>{var d;return b['durationType']==='r'?b['duration']*((d=c===null||c===void 0x0?void 0x0:c['priceIncrement'])!==null&&d!==void 0x0?d:0.01)+'p':''+(b['duration']===0x1?'':b['duration'])+b['durationType'];};const candleAlignToFeedFlag=b=>{switch(b){case'session_start':return's';case'midnight':default:return'm';}};export const toSubscriptionKey=(b,c,d)=>{const e=periodToString(c,d),f=isExtendedHoursSupported(c)&&(d===null||d===void 0x0?void 0x0:d['extendedHours'])!==undefined?',tho='+!d['extendedHours']:'',g=(d===null||d===void 0x0?void 0x0:d['priceType'])&&(d===null||d===void 0x0?void 0x0:d['priceType'])!=='last'?',price='+d['priceType']:'',h=(d===null||d===void 0x0?void 0x0:d['candleAlignment'])?',a='+candleAlignToFeedFlag(d['candleAlignment']):'';return b+'{='+e+f+h+g+'}';};export const getMaxFromTimeForAggregation=b=>{const c=new Date();switch(b['durationType']){case't':case'r':case's':return addDays(c,-0x5)['getTime']();case'm':case'v':return b['duration']>0x5?addDays(c,-0x2b)['getTime']():addDays(c,-0x5a)['getTime']();case'h':return addDays(c,-0x11d)['getTime']();case'd':case'w':case'mo':case'y':return addYears(new Date(0x0),0x1)['getTime']();}};const checkCandleIsLast=(b,c)=>{const d=0x1;for(let e=0x1;e<=d;e++){const f=b[b['length']-e];if(f&&f['time']===c['time'])return!![];}return![];},checkCandleIsNew=(b,c)=>{for(let d=0x0;d<b['length'];d++){if(b[d]['time']===c['time'])return![];}return!![];},updateExistingCandle=(b,c)=>{const d=b[b['length']-0x1];d&&d['time']===c['time']&&(d['close']=c['close'],d['high']=c['high'],d['impVolatility']=c['impVolatility'],d['low']=c['low'],d['open']=c['open'],d['volume']=c['volume'],d['vwap']=c['vwap']);},sequenceTOption=sequenceT(a),toCandleFromFeed=b=>pipe(sequenceTOption(option['fromNullable'](b['time']),option['fromNullable'](b['high']),option['fromNullable'](b['low']),option['fromNullable'](b['close']),option['fromNullable'](b['open'])),option['map'](([c,d,f,g,h])=>({'high':d,'low':f,'open':h,'close':g,'volume':getVolume(b['volume']),'impVolatility':b['impVolatility'],'vwap':b['vwap'],'time':c}))),getVolume=b=>typeof b==='string'||typeof b==='undefined'?0x0:b;function lastOf(b){if(b&&b['length'])return b[b['length']-0x1];return undefined;}